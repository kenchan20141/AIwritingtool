<!DOCTYPE html>
<html lang="zh">
<head>

<meta http-equiv="Content-Security-Policy" content="
default-src 'self'; 
script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; 
font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
img-src 'self' https: data:;
connect-src 'self' https://v1.hitokoto.cn https://chatapi.akash.network;
frame-src 'self' https://streamable.com;
object-src 'none';
base-uri 'self';
form-action 'self';
">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>神思</title>

<!-- 添加到主畫面設定 -->
<meta name="application-name" content="神思">
<meta name="apple-mobile-web-app-title" content="神思">
<link rel="manifest" href="manifest.json">



<link rel="apple-touch-icon" href="https://i.ibb.co/tpYQMG6z/SANSI.png">



<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">




<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">




<!-- Android 圖示 -->
<link rel="icon" sizes="192x192" href="https://i.ibb.co/tpYQMG6z/SANSI.png">



<link rel="icon" sizes="144x144" href="https://i.ibb.co/tpYQMG6z/SANSI.png">



<link rel="icon" sizes="96x96" href="https://i.ibb.co/tpYQMG6z/SANSI.png">



<!-- iOS 圖示 -->
<link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/tpYQMG6z/SANSI.png">



<link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/tpYQMG6z/SANSI.png">



<link rel="apple-touch-icon" sizes="120x120" href="https://i.ibb.co/tpYQMG6z/SANSI.png">




<style>
body {
font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
max-width: 800px;
margin: 0 auto;
padding: 20px;
background: url('https://i.ibb.co/nNMDqGJt/4.png') center/cover fixed;
padding-bottom: 60px; /* 為頁面內容設置底部內邊距，避免被音樂播放器遮擋 */
}
h1 {
text-align: center;
color: #333;
}

.category {
margin-bottom: 20px;
}

.category h3 {
font-size: 18px;
margin-bottom: 10px;
color: #fff; /* 白色文字，適配深色背景 */
text-align: left;
}

/* 手機設備調整 */
@media (max-width: 600px) {
.category {
padding-left: 25px; /* 增加左內邊距，讓按鍵遠離左邊緣 */
}
#toolsList button {
width: auto; /* 寬度自適應文字內容 */
display: inline-block; /* 按鈕以行內塊元素顯示，配合置中 */
margin: 10px 0; /* 調整為上下 10px，左右 0px，避免額外水平間距 */
font-size: 14px; /* 保留字體大小 */
padding: 8px 16px; /* 保留內邊距，提供適當空間 */
}
.category h3 {
font-size: 16px; /* 保留標題字體大小 */
}
}


.copyright-footer {
position: fixed;
bottom: 0;
right: 0;
padding: 5px 10px;
background-color: #f1f1f1;
}

.copyright-footer p {
margin: 0;
font-size: 14px;
}

@media (max-width: 600px) {
.copyright-footer p {
font-size: 12px;
}
}

/* 晴天效果：太陽 */
.sun {
position: absolute;
top: 10%;
left: 5%; /* 調整為靠左 */
width: 100px;
height: 100px;
background-color: yellow;
border-radius: 50%;
box-shadow: 0 0 20px yellow;
animation: sunGlow 2s infinite alternate;
z-index: -1; /* 確保太陽在其他元素下方，避免遮擋按鍵 */
}

/* 平板設備調整 */
@media (max-width: 768px) {
.sun {
left: 5%;
top: 5%;
width: 100px;
height: 100px;
}
}

/* 手機設備調整 */
@media (max-width: 480px) {
.sun {
left: 2%;
top: 2%;
width: 80px;
height: 80px;
}
}

/* 太陽光芒動畫（保持不變） */
@keyframes sunGlow {
0% { box-shadow: 0 0 20px yellow; }
100% { box-shadow: 0 0 40px yellow; }
}


/* 多雲效果：雲朵 */
.cloud {
position: absolute;
background-color: white;
border-radius: 50%;
opacity: 0.8;
animation: cloudMove linear infinite;
}

@keyframes cloudMove {
0% { transform: translateX(-100vw); }
100% { transform: translateX(100vw); }
}

/* 下雨效果：雨滴 */
.raindrop {
position: absolute;
width: 2px;
height: 10px;
background-color: #ADD8E6; /* 淺藍色，更自然 */
opacity: 0.7; /* 增加透明度 */
animation: rainFall linear infinite;
}
@keyframes rainFall {
0% { transform: translateY(-10px); }
100% { transform: translateY(100vh); }
}

/* 下雪效果：雪花（保留並調整） */
.snowflake {
position: absolute;
background-color: #e0f7fa;
border-radius: 50%;
opacity: 0.7;
animation: snowfall linear infinite;
}

@keyframes snowfall {
0% { top: -10px; transform: translateX(0); }
50% { transform: translateX(20px); }
100% { top: 100vh; transform: translateX(0); }
}




/* 確保標題不被背景影響 */
.title-container {
background: none;
padding: 0;
}

.title-container {
position: relative;
margin-bottom: 3rem;
text-align: center;
}
.title-text {
display: block;
font-size: 3rem;
color: #d1f2eb;
text-shadow: 3px 3px 0 #7f8c8d;
letter-spacing: 4px;
animation: titleFloat 3s ease-in-out infinite;
}


.box {
background: rgba(220, 220, 220, 0.96);
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
padding: 20px;
margin: 15px 0;
}
button {
background: #007bff;
color: white;
padding: 10px 20px;
border: none;
border-radius: 4px;
cursor: pointer;
transition: background 0.3s;
margin: 5px;
}
button:hover {
background: #0056b3;
}
.save-btn {
background: #28a745;
}
.save-btn:hover {
background: #218838;
}
.clear-btn {
background: #dc3545;
}
.clear-btn:hover {
background: #c82333;
}

/* --- 修訂二：表單輸入框美化 --- */
select, textarea, input[type="text"] {
width: 100%;
padding: 12px 15px; /* 增加內邊距 */
margin: 10px 0;
border: 1px solid #dcdfe6; /* 更柔和的邊框顏色 */
border-radius: 8px; /* 更大的圓角 */
box-sizing: border-box;
background-color: #fcfdfd; /* 非常淺的背景色 */
font-size: 1.3em;
color: #333;
transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

select:focus, textarea:focus, input[type="text"]:focus {
outline: none; /* 移除預設的 outline */
border-color: #4A90E2; /* 焦點狀態下的邊框顏色 */
box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); /* 模擬 glow 效果 */
}

textarea {
resize: vertical;
min-height: 80px; /* 設定最小高度 */
}

table {
width: 100%;
border-collapse: collapse;
margin: 10px 0;
}
th, td {
border: 1px solid #ccc;
padding: 10px;
text-align: left;
vertical-align: top;
word-break: break-word;
}
th {
background: #f0f0f0;
}
.table-container {
overflow-x: auto;
width: 100%;
}
.table-container table {
width: 100%;
border-collapse: collapse;
}
.table-container th, .table-container td {
border: 1px solid #ccc;
padding: 10px;
text-align: left;
vertical-align: top;
word-break: break-word;
}
.table-container th:first-child, .table-container td:first-child {
width: 60px; /* 您可以調整這個像素值來改變寬度 */
}
.table-container th:nth-child(2), .table-container td:nth-child(2),
.table-container th:nth-child(3), .table-container td:nth-child(3) {
min-width: 100px;
}
.table-container th:nth-child(4), .table-container td:nth-child(4),
.table-container th:nth-child(5), .table-container td:nth-child(5) {
min-width: 150px;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.tool-btn {
animation: fadeIn 0.2s ease-in-out forwards;
opacity: 0;
}


/* --- 修訂一：範疇按鍵樣式 --- */
.category-buttons-container {
display: flex;
flex-wrap: wrap;
gap: 10px;
justify-content: center; /* 讓按鈕在容器內居中 */
}

.btn-category {
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: bold;
transition: all 0.3s ease;
border: 2px solid white;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
background-color: rgba(142, 142, 147, 0.7); /* 半透明灰色 */
color: white;
backdrop-filter: blur(5px);
margin: 0; /* 重置 margin */
}

.btn-category:hover {
transform: translateY(-2px);
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
filter: brightness(115%);
}

.btn-category.active {
filter: brightness(115%);
box-shadow: 0 0 15px rgba(255, 255, 255, 0.7), 0 4px 12px rgba(0,0,0,0.25);
transform: translateY(-2px);
}

/* Specific active colors */
#readingBtn.active { background-color: #28a745; }
#writingBtn.active { background-color: #007bff; }
#argumentBtn.active { background-color: #800080; }
#expandBtn.active { background-color: #dc3545; }
#booksBtn.active { background-color: #ffc107; }

/* Apply to the expand button as well */
#expandToolsBtn2 {
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: bold;
transition: all 0.3s ease;
border: 2px solid white;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
color: white;
background-color: rgba(54, 187, 167, 0.8);
backdrop-filter: blur(5px);
}

#expandToolsBtn2:hover {
transform: translateY(-2px);
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
filter: brightness(110%);
}


#toolsContainer {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100vh;
background-color: rgba(0, 0, 0, 0.8);
display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
overflow: hidden; /* 隱藏頁面滾動條 */
}

#toolsList {
display: flex;
flex-direction: column;
align-items: flex-start;
max-height: 80vh; /* 設置最大高度，例如 80% 的視窗高度 */
overflow-y: auto; /* 啟用垂直滾動條 */
position: relative; /* 保持相對定位於容器內 */
}

#toolsList button {
opacity: 0;
margin: 10px 0;
padding: 10px 20px;
font-size: 16px;
background-color: #007bff;
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
}

#closeToolsBtn {
position: absolute;
top: 20px;
right: 20px;
background-color: #dc3545;
color: white;
border: none;
padding: 10px 20px;
border-radius: 4px;
cursor: pointer;
}


#commentResult {
width: 100%;
overflow-wrap: break-word;
}

#toggleOverviewBtn {
background-color: #A9A9A9; /* 灰色背景 */
color: white; /* 白色文字 */
}

#toggleOverviewBtn:hover {
background-color: #808080; /* 懸停時深灰色 */
}


#manuscriptPaperBtn {
background-color: #17a2b8;
}
#manuscriptPaperBtn:hover {
background-color: #138496;
}

#writingContainer, #readingContainer, #booksContainer, #expandContainer, #argumentContainer {
display: none;
}
#argumentTopicSelectionArea, #argumentCustomTopicArea, #argumentWritingArea, #argumentGuideArea {
margin-top: 10px;
}



#music-player {
position: fixed;
bottom: 0px;
left: 0;
width: 100%;
background-color: #444;
color: white;
padding: 10px;
display: none; /* 預設隱藏 */
align-items: center;
justify-content: space-between;
z-index: 1002;
box-sizing: border-box;
font-size: 14px;
}
#music-player.hidden {
display: none;
}
#music-player .controls {
display: flex;
align-items: center;
flex-shrink: 0;
}
#music-player .controls button {
background: none;
border: none;
color: white;
font-size: 20px;
cursor: pointer;
margin-right: 10px;
}
#music-player .controls select {
background: #555;
color: white;
border: none;
padding: 5px;
border-radius: 3px;
max-width: 150px;
}
#music-player .progress {
flex: 1;
margin: 0 10px;
display: flex;
align-items: center;
}
#music-player .progress input[type="range"] {
width: 100%;
}
#music-player .mode {
margin-left: 10px;
flex-shrink: 0;
}
#music-player .mode select {
background: #555;
color: white;
border: none;
padding: 5px;
border-radius: 3px;
}
#music-player .hide-btn {
background: none;
border: none;
color: white;
font-size: 20px;
cursor: pointer;
margin-left: 10px;
}
#show-player {
position: fixed;
bottom: 25px; /* 上移至 30px，可根據需要調整 */
right: 10px;
background: #444;
color: white;
border: none;
padding: 10px;
border-radius: 50%;
cursor: pointer;
z-index: 1003;
display: block; /* 初始顯示 */
font-size: 16px;
}
@media (max-width: 600px) {
#music-player {
flex-wrap: wrap;
padding: 5px;
}
#music-player .controls select {
max-width: 100px;
font-size: 12px;
}
#music-player .mode select {
font-size: 12px;
}
#progress-bar-music {
height: 10px;
-webkit-appearance: none;
appearance: none;
background: #ddd;
border-radius: 5px;
}
#progress-bar-music::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
background: #007bff;
border-radius: 50%;
cursor: pointer;
}
#progress-bar-music::-moz-range-thumb {
width: 20px;
height: 20px;
background: #007bff;
border-radius: 50%;
cursor: pointer;
}
#music-player .controls select, #music-player .mode select {
max-width: 80px;
padding: 3px;
font-size: 12px;
}
#music-player .controls button, #music-player .hide-btn {
padding: 5px;
font-size: 16px;
}
}

/* --- Styles for Tool 2 (語薈) --- */
:root {
--bg-color: #f5f5f3;
--text-color: #333;
--primary-color: #6a7a7d;
--secondary-color: #8f8f8f;
--accent-color: #8c9ea1;
--line-color: #c5c5c5;
--shadow-color: rgba(0, 0, 0, 0.05);
--highlight-bg-writing: rgba(230, 240, 245, 0.6);
--highlight-bg-reading: rgba(245, 240, 230, 0.6);
--font-main: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
}

#toolsContainer2 {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: var(--bg-color);
z-index: 1005;
overflow-y: auto;
display: none;
padding: 2rem 1rem;
box-sizing: border-box;
justify-content: center;
}

#closeToolsBtn2 {
position: fixed;
top: 15px;
right: 25px;
background-color: transparent;
border: none;
font-size: 2.5rem;
font-weight: bold;
color: #333;
cursor: pointer;
z-index: 1006;
line-height: 1;
padding: 5px 10px;
}

#closeToolsBtn2:hover {
color: #d32f2f;
}

.main-container {
max-width: 1200px;
width: 100%;
position: relative;
opacity: 0;
transition: opacity 0.5s ease-in;
}

.main-container.loaded {
opacity: 1;
}

.floating-header {
position: fixed;
top: 15px;
left: 20px;
background-color: rgba(255, 255, 255, 0.7);
backdrop-filter: blur(8px);
padding: 5px 15px;
border-radius: 30px;
border: 1px solid #e0e0e0;
z-index: 1000;
box-shadow: 0 2px 10px var(--shadow-color);
display: flex;
align-items: center;
gap: 10px;
}

#video-tour-btn {
background: none;
border: none;
cursor: pointer;
padding: 0;
display: flex;
align-items: center;
}

#video-tour-btn .icon {
width: 24px;
height: 24px;
fill: var(--primary-color);
transition: fill 0.3s;
}

#video-tour-btn:hover .icon {
fill: var(--accent-color);
}

.floating-header h1 {
font-size: 1.2rem;
margin: 0;
font-weight: 700;
color: var(--primary-color);
}

.mind-map-container {
display: grid;
grid-template-columns: 1fr 1fr;
grid-template-rows: auto auto 1fr auto;
grid-template-areas:
"core-ai core-ai"
"foundations foundations"
"writing reading"
"assignments support";
gap: 50px 20px;
width: 100%;
margin-top: 80px;
padding-bottom: 50px;
position: relative;
}

.node {
display: flex;
align-items: center;
text-align: center;
padding: 8px 12px;
background-color: #fff;
border: 1px solid #e0e0e0;
border-radius: 8px;
box-shadow: 0 3px 12px var(--shadow-color);
transition: transform 0.3s ease, box-shadow 0.3s ease;
position: relative;
}

.node:hover {
transform: translateY(-4px) scale(1.02);
box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
border-color: var(--accent-color);
}

.node a {
text-decoration: none;
color: inherit;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
font-size: 0.95rem;
gap: 8px;
width: 100%;
}

.node .icon {
width: 24px;
height: 24px;
margin-right: 0;
fill: var(--primary-color);
}

#toolsContainer2 .category {
display: flex;
flex-direction: column;
align-items: center;
gap: 20px;
margin-bottom: 0; /* Reset margin for this context */
}

#writing, #reading {
padding: 20px;
border-radius: 12px;
}
#writing {
background-color: var(--highlight-bg-writing);
}
#reading {
background-color: var(--highlight-bg-reading);
}

.category-title {
font-size: 1.2rem;
font-weight: 700;
color: var(--primary-color);
padding-bottom: 5px;
border-bottom: 2px solid var(--accent-color);
display: flex;
align-items: center;
margin-bottom: 10px;
}

.category-title .icon {
width: 24px;
height: 24px;
margin-right: 8px;
fill: var(--primary-color);
}

.sub-group {
display: flex;
flex-direction: column;
align-items: center;
gap: 12px;
width: 100%;
}

.sub-group-title {
font-weight: bold;
color: var(--secondary-color);
font-size: 0.9rem;
position: relative;
padding-bottom: 5px;
margin-bottom: 5px;
}
.sub-group-title::after{
content: '';
position: absolute;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 30px;
height: 1px;
background-color: var(--line-color);
}

.node.level-2 { font-size: 0.9rem; }
.node.level-3 { font-size: 0.85rem; padding: 6px 10px; }
.node.level-3 a { font-weight: 400; flex-direction: row; }

/* Grid Area Assignments */
#core-ai { grid-area: core-ai; }
#foundations {
grid-area: foundations;
display: flex;
flex-direction: row;
justify-content: center;
gap: 350px;
align-items: flex-start;
}
#writing { grid-area: writing; }
#reading { grid-area: reading; }
#assignments { grid-area: assignments; }
#support { grid-area: support; }

.connector-svg {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: -1;
pointer-events: none;
}

.connector-svg line {
stroke: var(--line-color);
stroke-width: 1.5;
stroke-dasharray: 4;
animation: dash 1s linear infinite;
}

@keyframes dash {
to {
stroke-dashoffset: -20;
}
}

#yuyilu-toggle { cursor: pointer; }
.yuyilu-grades {
display: flex;
flex-direction: column;
gap: 8px;
width: 100%;
max-height: 500px;
overflow: hidden;
transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
opacity: 1;
}
.yuyilu-grades.collapsed {
max-height: 0;
opacity: 0;
pointer-events: none;
}

.foundation-item {
display: flex;
flex-direction: column;
align-items: center;
gap: 15px;
}

@media (max-width: 768px) {
#toolsContainer2 { padding: 1rem 0.5rem; }
.floating-header { top: 10px; left: 10px; }

.mind-map-container {
margin-top: 70px;
grid-template-columns: 1fr;
grid-template-rows: auto;
grid-template-areas:
"core-ai"
"foundations"
"writing"
"reading"
"assignments"
"support";
gap: 40px;
}

#foundations {
flex-direction: row;
justify-content: space-between;
align-items: flex-start;
width: 90%;
margin: 0 auto;
gap: 10px;
}

#writing, #reading {
padding: 15px;
}
}

/* --- Preview Modal Styles --- */
.preview-modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
display: none; /* 預設隱藏 */
justify-content: center;
align-items: center;
z-index: 2000;
padding: 1rem;
box-sizing: border-box;
}

.preview-modal-content {
background-color: #fff;
border-radius: 12px;
box-shadow: 0 5px 25px rgba(0,0,0,0.2);
width: 90%;
height: 90%;
max-width: 1000px;
display: flex;
flex-direction: column;
overflow: hidden;
position: relative;
}

.preview-close-btn {
position: absolute;
top: 8px;
right: 8px;
background: rgba(255, 255, 255, 0.7);
border: none;
border-radius: 50%;
width: 36px;
height: 36px;
font-size: 1.5rem;
font-weight: bold;
color: #333;
cursor: pointer;
line-height: 1;
display: flex;
align-items: center;
justify-content: center;
transition: background-color 0.3s, color 0.3s;
z-index: 2010;
}
.preview-close-btn:hover {
color: #fff;
background-color: #d32f2f;
}

.preview-modal-body {
flex-grow: 1;
display: flex;
flex-direction: column;
height: 100%;
}

#previewIframe {
width: 100%;
flex-grow: 1; /* 佔據大部分空間 */
border: none;
border-top-left-radius: 12px;
border-top-right-radius: 12px;
min-height: 60%; /* 確保預覽畫面有足夠高度 */
}

.preview-modal-footer {
padding: 16px;
background-color: #f7f9fa;
border-top: 1px solid #e0e0e0;
display: flex;
align-items: flex-start;
gap: 16px;
overflow-y: auto;
max-height: 40%;
flex-shrink: 0;
}

.preview-description {
font-size: 0.95rem;
color: #333;
line-height: 1.6;
text-align: left;
flex-grow: 1;
}

.preview-goto-btn {
background: #007bff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='18px' height='18px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z'/%3E%3C/svg%3E") no-repeat 15px center;
background-size: 18px 18px;
color: white;
padding: 10px 20px 10px 40px;
border: none;
border-radius: 20px;
text-decoration: none;
font-size: 1rem;
font-weight: bold;
transition: background-color 0.3s;
cursor: pointer;
flex-shrink: 0; /* 防止按鈕縮小 */
}
.preview-goto-btn:hover {
background-color: #0056b3;
color: white;
}

@media (max-width: 600px) {
.preview-modal-footer {
flex-direction: column;
align-items: stretch;
}
.preview-goto-btn {
align-self: flex-end; /* 在堆疊時仍將按鈕靠右 */
}
}


/* --- Video Modal Styles --- */
.video-modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.8);
display: none; /* 預設隱藏 */
justify-content: center;
align-items: center;
z-index: 2100;
cursor: pointer;
}

.video-modal-content {
position: relative;
width: 90%;
max-width: 960px;
padding-top: 56.25%; /* 16:9 Aspect Ratio */
height: 0;
cursor: default;
}

.video-modal-content iframe {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
border: none;
}

/* --- 修訂：增加選擇功能及下方項目排版的間距，使其更寬鬆 --- */
.function-selector-wrapper {
padding: 20px; /* 增加內邊距，讓內部元素有更多呼吸空間 */
background-color: rgba(59, 184, 219, 0.2);
border-left: 5px solid #0288d1;
margin-top: 30px; /* <--- 請加上這一行 */
margin-bottom: 35px; /* 明顯增加與下方內容的間距 */
border-radius: 8px; /* 圓角稍大，視覺上更柔和 */
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.function-selector-wrapper label {
font-size: 1.1em; /* 標題字體稍大，更突出 */
font-weight: bold;
color: #01579b;
display: block;
margin-bottom: 15px; /* 增加與下拉選單的間距 */
}
.function-selector-wrapper select {
font-size: 1em; /* 統一下拉選單字體大小 */
padding: 8px; /* 適度增加下拉選單的內邊距 */
}

/* 為各個功能容器內的主要區塊（div）增加統一的下間距，創造區塊間的層次感 */
#writingContentContainer > div,
#expandContentContainer > div,
#argumentContentContainer > div {
margin-bottom: 30px;
}

/* 清除最後一個元素的下邊距，避免在容器末尾產生多餘的空白 */
#writingContentContainer > div:last-child,
#expandContentContainer > div:last-child,
#argumentContentContainer > div:last-child {
margin-bottom: 0;
}

/* 針對閱讀區塊，其內部結構不同，單獨調整其子元素的間距 */
#readingInputArea > *:not(div#readingResult) {
margin-bottom: 20px; /* 統一閱讀區塊內輸入元素的下間距 */
}


/* --- 新增的改寫說明 UI 樣式 --- */
.rewrite-explanation-container {
margin-top: 20px;
}
.rewrite-explanation-card {
background-color: #f8f9fa;
border: 1px solid #dee2e6;
border-radius: 8px;
padding: 20px;
box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.rewrite-explanation-card h3 {
margin-top: 0;
margin-bottom: 15px;
color: #343a40;
font-size: 1.2em;
border-bottom: 2px solid #e9ecef;
padding-bottom: 10px;
}
.explanation-point {
display: flex;
align-items: flex-start;
margin-bottom: 15px;
}
.explanation-point:last-child {
margin-bottom: 0;
}
.explanation-number {
flex-shrink: 0;
width: 28px;
height: 28px;
background-color: #0288d1;
color: white;
font-weight: bold;
display: flex;
align-items: center;
justify-content: center;
border-radius: 50%;
margin-right: 15px;
font-size: 1em;
}
.explanation-text {
font-size: 1em;
line-height: 1.6;
color: #495057;
}

/* --- 新增：為點評語氣標籤增加上方間距 --- */
.tone-selector-label {
display: block; /* 確保標籤獨佔一行，讓邊距能正確顯示 */
margin-top: 25px; /* 增加與上方元素的距離 */
}

/* --- 題目顯示區塊樣式 --- */
#topicResult, #argumentTopicResult, #expandTopicResult {
position: relative; /* 為了讓 ::before 偽元素可以定位 */
padding: 12px 15px;
margin-bottom: 20px;
border-left: 5px solid #2A9689;
border-radius: 4px;
font-size: 1em;
display: none;
background-color: transparent !important; /* 強制容器本身透明 */
z-index: 0;
}

#topicResult::before,
#argumentTopicResult::before,
#expandTopicResult::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: rgba(54, 187, 167, 0.5); /* 在這裡設定半透明背景 */
border-radius: inherit; /* 讓背景的圓角與容器同步 */
z-index: -1; /* 將背景層放到內容的後面 */
}

/* 步驟二：強制設定表格儲存格的背景顏色 */
#topicResult td,
#argumentTopicResult td,
#expandTopicResult td {
background-color: #ffffff !important; /* 強制！內容儲存格為不透明白色 */
}

#topicResult th,
#argumentTopicResult th,
#expandTopicResult th {
background-color: #f0f0f0 !important; /* 強制！表頭為不透明淺灰色 */
}

/* 當題目區塊內有內容時，才將其顯示出來 */
#topicResult:not(:empty), #argumentTopicResult:not(:empty), #expandTopicResult:not(:empty) {
display: block;
}

/* --- 新增：讓「選擇題目方式」標題獨立成行 --- */
#topicSelectionArea > label,
#argumentTopicSelectionArea > label,
#expandTopicSelectionArea > label {
display: block; /* 讓標題變為區塊元素，使其強制換行 */
margin-bottom: 10px; /* 在標題和下方的按鈕之間增加一點垂直間距，讓版面更美觀 */
}


/* --- 按鍵美化修訂 (第四版 - 灰色預設/點擊變色) --- */

/* 1. 包裹按鍵的容器 */
.topic-buttons-container {
display: flex;
gap: 15px;
align-items: center;
margin-top: 10px;
}

/* 2. 通用的按鍵基礎樣式 */
.btn {
padding: 8px 18px;
border-radius: 8px;
cursor: pointer;
font-size: 16px;
font-weight: bold;
color: white;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
border: 3px solid transparent;

/* 【核心修訂】預設狀態下，所有按鍵都是灰色 */
background-color: #8E8E93; /* 一個質感不錯的中性灰 */
}

/* 3. 滑鼠懸停效果 (只對非活動的灰色按鍵生效) */
.btn:not(.active):hover {
transform: translateY(-2px);
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
filter: brightness(110%); /* 懸停時讓灰色稍微變亮 */
}

/* --- 點亮 (Active) 狀態的樣式 --- */

/* 4. 當「生成題目」按鍵被點亮時，變成藍色 */
.btn-generate.active {
background-color: #4A90E2; 
}

/* 5. 當「自訂題目」按鍵被點亮時，變成紫色 */
.btn-custom.active {
background-color: #7B68EE; 
}

/* 6. 所有被點亮的按鍵，都套用相同的強力發光效果 */
.btn.active {
filter: brightness(115%);
border: 3px solid white;
box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
transform: translateY(-2px);
}

.btn .fas {
font-size: 15px;
}

/* --- 新增：調整「剩餘字數」計數器的樣式與位置 --- */
#charCount {
margin-top: 0px; /* 大幅減少與上方輸入框的間距 */
margin-bottom: 20px; /* 確保與下方元素的間距，避免擠在一起 */
text-align: right; /* 將文字靠右對齊，看起來更專業 */
font-size: 0.9em; /* 讓字體稍微小一點，作為輔助資訊 */
color: #666; /* 使用較柔和的灰色 */
}

/* --- 新增：禁用按鈕的通用樣式 --- */
button:disabled {
background-color: #cccccc; /* 灰色背景 */
color: #666666; /* 深灰色文字 */
cursor: not-allowed; /* 顯示「禁止」的鼠標圖示 */
opacity: 0.6; /* 降低透明度 */
}

/* 確保此樣式也適用於有特定 class 的按鈕 */
.btn:disabled, .btn-icon-confirm:disabled {
background-color: #cccccc !important; /* 使用 !important 覆蓋原有樣式 */
border-color: #cccccc !important;
cursor: not-allowed;
opacity: 0.6;
box-shadow: none; /* 移除陰影 */
transform: none; /* 移除變形效果 */
}

/* --- 新增：儲存/清除圖示按鍵樣式 --- */
.action-buttons-container {
display: flex;
justify-content: flex-end; /* 將按鈕靠右對齊 */
gap: 12px; /* 按鈕之間的間距 */
margin-top: 10px; /* 與上方元素的間距 */
align-items: center; /* 確保所有項目垂直置中 */
}
/* ... (您原有的 .btn-icon-action, .btn-save-icon, .btn-clear-icon 樣式) ... */

.btn-add-icon {
background-color: rgba(0, 123, 255, 0.8); /* 主題藍色，並加入 0.8 的透明度 */
}

.btn-icon-action {
width: 36px;
height: 36px;
border-radius: 50%; /* 圓形按鈕 */
border: none;
color: white; /* 圖示顏色 */
font-size: 16px; /* 圖示大小 */

display: inline-flex;
align-items: center;
justify-content: center;

cursor: pointer;
box-shadow: 0 2px 5px rgba(0,0,0,0.15);
transition: all 0.2s ease-in-out;
margin: 0;
}

.btn-icon-action:hover {
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
filter: brightness(110%);
}

.btn-icon-action:active {
transform: translateY(0);
}

.btn-save-icon {
background-color: rgba(26, 117, 149, 0.8); /* 深藍綠色，並加入 0.8 的透明度 */
}

.btn-clear-icon {
background-color: rgba(220, 53, 69, 0.8); /* 紅色，並加入 0.8 的透明度 */
}

/* --- 新增：書籍討論資訊的專屬樣式 --- */
.discussion-info {
text-align: left; /* 強制文字靠左對齊 */
background-color: #eef1f4; /* 一個柔和、中性的背景色 */
color: #333; /* 深色文字，確保可讀性 */
padding: 12px 15px; /* 適當的內邊距 */
border-radius: 8px; /* 圓角 */
margin: 5px 0 15px 0; /* 與下方 AI 回應的間距 */
line-height: 1.6; /* 增加行高，讓文字不擁擠 */
}

.discussion-info strong {
color: #0056b3; /* 讓標題文字(書名、作者等)使用主題藍色，更突出 */
}

/* --- 新增：書籍資訊表格的樣式 --- */
.discussion-info table {
width: 100%;
border-collapse: collapse; /* 移除儲存格之間的空隙 */
}

.discussion-info td {
border: none; /* 移除所有邊框 */
padding: 4px 0; /* 微調垂直內邊距，讓行距適中 */
vertical-align: top; /* 確保長內容的儲存格頂部對齊 */
}

/* 讓標題欄位有一個固定的、較小的寬度 */
.discussion-info td:first-child {
width: 90px; /* 您可以根據需要調整這個寬度 */
font-weight: bold; /* 讓標題加粗 */
color: #0056b3; /* 繼承主題藍色 */
}

/* --- 全新聊天介面樣式 (無頭像極簡版) --- */

/* 1. 聊天歷史容器 */
#chatHistory {
background-color: #f0f4f8;
border: 1px solid #dde3ea;
border-radius: 12px;
padding: 20px 15px;
margin-bottom: 15px;
max-height: 400px;
overflow-y: auto;
display: none;
scroll-behavior: smooth;
display: flex;
flex-direction: column;
}

/* 2. 訊息氣泡樣式 */
.message-bubble {
padding: 10px 15px;
border-radius: 18px;
line-height: 1.5;
font-size: 14px; /* <-- 新增這一行以縮小字體 */
word-wrap: break-word;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
max-width: 80%;
animation: fadeIn 0.3s ease-in-out;
margin-bottom: 15px;
}


/* ---【最終修正版】聊天氣泡樣式 --- */

/* 3. AI (陳SIR) 訊息的氣泡樣式 */
.message-bubble.ai-message {
background-color: #ffffff;
color: #333;
align-self: flex-start; /* 讓氣泡自身靠左 */
border-top-left-radius: 4px; /* 製造氣泡指向感 */
}

/* 4. 使用者訊息的氣泡樣式 */
.message-bubble.user-message {
background-color: rgba(45, 153, 102, 0.9); /* 您想要的帶透明度的綠色 */
color: white;
align-self: flex-end; /* 讓氣泡自身靠右 */
border-top-right-radius: 4px; /* 製造氣泡指向感 */
}

/* 5. 書籍資訊卡片樣式 (保持不變) */
.discussion-info {
text-align: left;
background-color: #e9ecef;
color: #495057;
padding: 12px 15px;
border-radius: 8px;
margin: 0 auto 15px auto;
line-height: 1.6;
width: 95%;
box-sizing: border-box;
}

.discussion-info table {
width: 100%;
border-collapse: collapse;
}
.discussion-info td {
border: none;
padding: 4px 0;
vertical-align: top;
}
.discussion-info td:first-child {
width: 90px;
font-weight: bold;
color: #0056b3;
}


/* --- 修訂三：「課外書籍」互動介面 --- */
#chatInputContainer {
display: none; /* 預設隱藏，由 JS 控制 */
align-items: center;
gap: 10px;
margin-top: 15px;
}
#chatInputContainer textarea {
flex-grow: 1; /* 佔據主要空間 */
margin: 0; /* 移除預設的 margin */
}

#initialDiscussionForm {
display: block; /* 預設顯示 */
}

/* 新增討論主題的彈出視窗 */
.books-modal {
display: none; /* 預設隱藏 */
position: fixed;
z-index: 1010;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.6);
justify-content: center;
align-items: center;
}

.books-modal .modal-content {
background-color: #fefefe;
margin: auto;
padding: 25px;
border: 1px solid #888;
width: 90%;
max-width: 500px;
border-radius: 12px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
position: relative;
animation: fadeIn 0.4s;
}

.books-modal .close-modal-btn {
color: #aaa;
position: absolute;
top: 10px;
right: 15px;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}
.books-modal .close-modal-btn:hover,
.books-modal .close-modal-btn:focus {
color: black;
}
#discussionControlButtons {
margin-bottom: 20px;
}

/* --- 新增：預設隱藏課外書籍的功能按鈕 --- */
#booksButtons {
display: none;
}

/* --- 新增：手機版範疇按鍵靠左對齊 --- */
@media (max-width: 600px) {
.category-buttons-container {
/* 在螢幕寬度小於等於 600px 時，
將按鍵的對齊方式從 center 改為 flex-start (靠左) */
justify-content: flex-start;
}
}

/* --- 新增：「開始討論」與「提交」按鍵的統一美化樣式 --- */
.btn-action {
display: inline-block;
padding: 10px 20px;
margin: 15px 0 5px 0; /* 調整與上方元素的距離 */
border-radius: 8px; /* 圓角與範疇按鍵一致 */
cursor: pointer;
font-size: 14px; /* 字體大小與範疇按鍵一致 */
font-weight: bold; /* 字體粗細與範疇按鍵一致 */
font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif; /* 確保字體繼承一致 */
transition: all 0.3s ease;
border: 2px solid white;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
color: white;
background-color: rgba(31, 122, 85, 0.8); /* 統一使用「點擊展開」的綠色，使其具有「執行動作」的視覺感 */
backdrop-filter: blur(5px);
text-align: center;
text-decoration: none;
}

.btn-action:hover {
transform: translateY(-2px);
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
filter: brightness(110%);
}


/* --- 通用輸入框懸浮視窗 (CSS) --- */

/* 1. 讓所有符合條件的輸入框看起來可以點擊 */
textarea:not(.no-modal-editor),
input[type="text"]:not(.no-modal-editor) {
cursor: pointer; /* 滑鼠變成手形指標 */
background-color: #f0f8ff; /* 淡藍色背景提示 */
transition: background-color 0.2s;
}

/* 2. 當滑鼠懸停時，背景色稍深一點 */
textarea:not(.no-modal-editor):hover,
input[type="text"]:not(.no-modal-editor):hover {
background-color: #e6f2ff;
}

/* 3. 懸浮視窗本身的樣式 (與之前相同，可直接覆蓋) */
.outline-modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.65);
z-index: 2000;
justify-content: center;
align-items: center;
padding: 1rem;
box-sizing: border-box;
}

.outline-modal-content {
background-color: #fdfdfd;
padding: 25px;
border-radius: 12px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
width: 90%;
max-width: 700px;
position: relative;
animation: fadeIn 0.3s;
display: flex;
flex-direction: column;
}

.outline-modal-content h3 {
margin-top: 0;
margin-bottom: 15px;
color: #333;
font-size: 1.2em; /* 已根據您的要求調小 */
font-weight: 700;
}

#modal-textarea {
width: 100%;
box-sizing: border-box;
font-size: 1.3em;
line-height: 1.6;
border: 1px solid #ccc;
border-radius: 8px;
padding: 10px;
flex-grow: 1;
min-height: 250px;
}

.outline-modal-content .modal-buttons {
text-align: right;
margin-top: 15px;
}

.outline-modal-content .preview-close-btn {
position: absolute;
top: 10px;
right: 10px;
}

#structure, /* <--- 新增這一行，記得加上逗號 */
#writingTone, 
#readingTone, 
#booksTone, 
#expandTone, 
#argumentOutlineTone, 
#argumentWritingTone {
font-size: 1.05em; /* 將字體縮小為相對較小的值 */
padding: 6px 10px; /* 同時可以微調內邊距讓它看起來更協調 */
}

/* --- 最終修訂方案 --- */
#booksContainer #initialDiscussionForm input[type="text"],
#booksContainer #initialDiscussionForm textarea {
font-size: 1rem !important; /* 使用 rem 單位並加上 !important */
padding: 10px 12px; /* 也可以微調內邊距讓視覺效果更好 */
} 

/* --- 新增：答題步驟及思路美化樣式 --- */
.steps-container {
    margin-top: 20px; /* 與上方標題的間距 */
    padding-left: 15px; /* 內邊距，讓內容與邊框有距離 */
    border-left: 4px solid #4A90E2; /* 左側的裝飾性藍色邊框 */
}

.step-card {
    background-color: #f7f9fc; /* 非常淺的藍灰色背景，增加層次感 */
    border-radius: 8px; /* 圓角 */
    padding: 15px 20px; /* 卡片內部空間 */
    margin-bottom: 20px; /* 這就是步驟之間的垂直距離 */
    box-shadow: 0 2px 5px rgba(0,0,0,0.08); /* 輕微的陰影效果，提升立體感 */
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* 平滑的互動效果 */
}

/* 當滑鼠移到卡片上時，卡片會輕微上浮，陰影加深，提供互動回饋 */
.step-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

/* 最後一個步驟不需要下邊距，避免多餘的空白 */
.step-card:last-child {
    margin-bottom: 0;
}

.step-title {
    font-weight: bold; /* 步驟標題加粗 */
    font-size: 1.1em; /* 標題字體稍大，更突出 */
    color: #0056b3; /* 使用有質感的深藍色 */
    margin-bottom: 10px; /* 標題與下方內容的間距 */
}

.step-content {
    font-size: 1em; /* 內容字體大小 */
    line-height: 1.7; /* 增加行高，讓文字更容易閱讀 */
    color: #333; /* 標準的深灰色文字 */
}

/* --- 新增：禁用按鈕的通用樣式 --- */
button:disabled {
background-color: #cccccc; /* 灰色背景 */
color: #666666; /* 深灰色文字 */
cursor: not-allowed; /* 顯示「禁止」的鼠標圖示 */
opacity: 0.6; /* 降低透明度 */
}

/* 【修訂後】確保此樣式也適用於有特定 class 的按鈕 */
.btn:disabled, .btn-icon-confirm:disabled, .btn-action:disabled {
background-color: #cccccc !important; /* 使用 !important 覆蓋原有樣式 */
border-color: #cccccc !important;
cursor: not-allowed;
opacity: 0.6;
box-shadow: none; /* 移除陰影 */
transform: none; /* 移除變形效果 */
}

#customTopicArea input[type="text"],
#customTopicArea textarea,
#argumentCustomTopicArea input[type="text"],
#expandCustomTopicInputArea input[type="text"],
#expandCustomTopicInputArea textarea,
/* 【新增這兩行】針對整合拓展的「指引」功能內的輸入框 */
#expandGuideArea input[type="text"],
#expandGuideArea textarea {
    font-size: 1rem !important; /* 使用 !important 確保覆蓋，1rem 為標準大小 */
    padding: 10px 12px;       /* 配合較小字體，微調內邊距 */
}

</style>
</head>
<body>


<div class="title-container">
<h1>
<span class="title-text">神思</span>
</h1>
</div>


<div id="hitokoto-container" class="box">
<div id="hitokoto"></div>
<div id="hitokoto-footer">
<span id="hitokoto-from"></span>
<button id="refresh-btn"><i class="fas fa-sync-alt"></i></button>
</div>
</div>



<style>
#hitokoto-container {
background: rgba(220, 220, 220, 0.96);
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
padding: 16px;
margin: 15px 0;
text-align: center;
max-width: 800px;
position: relative;
}

@media (max-width: 600px) {
#hitokoto-container {
text-align: left;
}
}

#hitokoto {
font-size: 21px;
font-style: italic;
color: #333;
margin-bottom: 10px;
}

#hitokoto p {
margin: 5px 0;
}

#hitokoto-footer {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 10px;
}

#hitokoto-from {
font-size: 16px;
color: #666;
}

#refresh-btn {
background: none;
border: none;
cursor: pointer;
font-size: 20px;
color: #666;
transition: color 0.3s;
padding: 0;
margin: 0;
}

#refresh-btn:hover {
color: #000;
}


/* --- 新增：確認圖示按鍵樣式 --- */

.btn-icon-confirm {
/* 1. 外觀設定：圓形、綠色背景 */
width: 44px;
height: 44px;
border-radius: 50%; /* 製作成完美的圓形 */
background-color: #28a745; /* 成功、確認的綠色 */
border: none;

/* 2. 圖示置中與樣式 */
display: inline-flex;
align-items: center;
justify-content: center;
color: white; /* 圖示顏色 */
font-size: 20px; /* 圖示大小 */

/* 3. 互動效果與陰影 */
cursor: pointer;
box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
transition: all 0.2s ease-in-out;
}

.btn-icon-confirm:hover {
/* 4. 滑鼠懸停時：放大、提亮，陰影加深 */
transform: scale(1.1);
filter: brightness(110%);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.btn-icon-confirm:active {
/* 5. 點擊瞬間：再放大一點，提供回饋感 */
transform: scale(1.15);
}



</style>

<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>



<script>
document.addEventListener('DOMContentLoaded', function() {
const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
const hitokotoElement = document.getElementById('hitokoto');
const hitokotoFromElement = document.getElementById('hitokoto-from');
const refreshBtn = document.getElementById('refresh-btn');

function fetchHitokoto() {
fetch('https://v1.hitokoto.cn/?c=d&c=i&c=k&encode=json')
.then(response => response.json())
.then(data => {
if (data.from.includes('魔道祖師')) {
fetchHitokoto(); // 如果來源是「魔道祖師」，重新獲取名言
} else {
// 使用 textContent 可以自動處理特殊字元，是顯示純文字的最佳選擇
hitokotoElement.textContent = converter(data.hitokoto);
hitokotoFromElement.textContent = `—— ${converter(data.from_who || '佚名')} 《${converter(data.from)}》`;
}
})
.catch(error => {
console.error('獲取名言失敗:', error);
hitokotoElement.innerHTML = '<p>獲取名言失敗，請稍後再試。</p>';
hitokotoFromElement.innerHTML = '';
});
}

fetchHitokoto();
refreshBtn.addEventListener('click', fetchHitokoto);
});
</script>



<!-- 工具選擇 -->
<div class="box">
<h2>工具一覽：</h2>
<button id="expandToolsBtn2">點擊展開</button>


<div id="effectContainer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1001; pointer-events: none;"></div>
</div>

<!-- 範疇選擇 -->
<div class="box">
<h2>選擇範疇：</h2>
<div class="category-buttons-container">
<button id="readingBtn" class="btn-category">📕閱讀</button>
<button id="writingBtn" class="btn-category">✏敘事抒情</button>
<button id="argumentBtn" class="btn-category">📋議論</button>
<button id="expandBtn" class="btn-category">📂整合拓展</button>
<button id="booksBtn" class="btn-category">📚課外書籍</button>
</div>
</div>



<!-- 寫作容器 -->
<div id="writingContainer" class="box">
<h2>敘事抒情</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/lke2eo?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;"></iframe></div>

<div class="function-selector-wrapper">
<label for="writingType">選擇功能：</label>
<select id="writingType" onchange="toggleWritingType()">
<option value="" selected disabled>請在此選擇功能</option>
<option value="大綱">大綱</option>
<option value="片段描寫">片段描寫/全文寫作</option>
<option value="敘事物象">敘事物象</option>
</select>
</div>

<div id="writingContentContainer" style="display: none;">
<div id="outlineStructureArea" style="display: none;">
<label for="structure">選擇大綱結構：</label>
<select id="structure" onchange="generateOutlineTable()">
<option value="fourPart">起承轉合</option>
<option value="threeLine">三線</option>
</select>
</div>
<!-- ... 省略部分程式碼 ... -->
<div id="topicSelectionArea">
<label>選擇題目方式：</label>
<div class="topic-buttons-container">
<!-- 套用新的 class: btn-generate -->
<button class="btn btn-generate" onclick="generateTopic(this)">
<i class="fas fa-sync-alt"></i> 生成
</button>
<!-- 套用新的 class: btn-custom -->
<button class="btn btn-custom" onclick="showCustomTopicInput(this)">
<i class="fas fa-edit"></i> 自訂
</button>
</div>
<div id="customTopicArea" style="display: none; margin-top: 15px;"></div>
</div>

<div id="topicResult"></div>
<div id="narrativeElementsArea" style="display: none;">

<label for="narrativeElements">請輸入您的取材或故事背景：</label>
<textarea id="narrativeElements" rows="5" placeholder="例如：故事背景、人物設定、取材等..."></textarea>
</div>
<div id="writingArea">

<div id="outlineTableArea"></div>
<div id="outlineButtons" style="display: none;" class="action-buttons-container">
<button class="btn-icon-action btn-save-icon" onclick="saveOutline()" title="儲存大綱">
<i class="fas fa-save"></i>
</button>
<button class="btn-icon-action btn-clear-icon" onclick="clearOutline()" title="清空大綱">
<i class="fas fa-trash-alt"></i>
</button>
</div>
<textarea id="writingContent" rows="10" placeholder="請在此輸入您的寫作內容（「片段描寫」使用）..." style="display: none;"></textarea>
<label for="writingTone" id="writingToneLabel" class="tone-selector-label" style="display: none;">選擇點評語氣：</label>
<select id="writingTone" style="display: none;">
<option value="serious">嚴肅正經</option>
<option value="chen">陳SIR語氣</option>
</select>
<!-- 將 <button onclick="submitWriting()"> 改為： -->
<button id="submitWritingBtn" class="btn-action" onclick="submitWriting()">提交</button>
<div id="commentResult"></div>
</div>
</div>
</div>

<!-- 閱讀容器 -->
<div id="readingContainer" class="box" style="display: none;">
<h2>閱讀</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/vt3i1j?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;"></iframe></div>

<div class="function-selector-wrapper">
<label for="readingFunction">選擇功能：</label>
<select id="readingFunction" onchange="toggleReadingFunction()">
<option value="" selected disabled>請在此選擇功能</option>
<option value="comment">點評</option>
<option value="guide">指引</option>
</select>
</div>

<div id="readingInputArea" style="display: none;">
<label for="readingPassage">貼上閱讀篇章：</label>
<textarea id="readingPassage" rows="10" placeholder="請在此貼上閱讀篇章..."></textarea>
<label for="readingQuestion">貼上題目：</label>
<textarea id="readingQuestion" rows="3" placeholder="請在此貼上題目..."></textarea>
<div id="studentAnswerArea" style="display: none;">
<label for="studentAnswer">貼上答案：</label>
<textarea id="studentAnswer" rows="5" placeholder="請在此貼上答案..."></textarea>
</div>
<label for="readingTone" id="readingToneLabel" class="tone-selector-label" style="display: none;">選擇點評語氣：</label>
<select id="readingTone" style="display: none;">
<option value="serious">嚴肅正經</option>
<option value="chen">陳SIR語氣</option>
</select>
<!-- 將 <button onclick="submitReading()"> 改為： -->
<button id="submitReadingBtn" class="btn-action" onclick="submitReading()">提交</button>
<div id="readingResult"></div>
</div>
</div>

<!-- 課外書籍容器 -->
<div id="booksContainer" class="box" style="display: none;">
<h2>課外書籍討論</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/4eznsi?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;"></iframe></div>

<!-- 初始輸入表單 -->
<div id="initialDiscussionForm">
<p>請在下方填寫書名、作者和討論問題，開始與陳SIR對話：</p>
<input type="text" id="bookTitle" class="no-modal-editor" placeholder="書名">
<input type="text" id="author" class="no-modal-editor" placeholder="作者">
<textarea id="discussionQuestion" class="no-modal-editor" rows="3" placeholder="討論問題"></textarea>
<label for="booksTone">選擇語氣：</label>
<select id="booksTone">
<option value="serious">嚴肅正經</option>
<option value="casual">輕鬆活潑</option>
</select>
<div id="discussionControlButtons">
<button id="startDiscussionBtn" class="btn-action" onclick="startDiscussion()">開始討論</button>
</div>
</div>

<!-- 聊天歷史紀錄 -->
<div id="chatHistory"></div>

<!-- 聊天輸入介面 (已移除新增按鈕) -->
<div id="chatInputContainer">
<textarea id="userInput" class="no-modal-editor" rows="2" placeholder="請在此輸入您的回應..."></textarea>
<button id="continueBtn" class="btn-icon-action" onclick="continueDiscussion()" title="繼續討論" style="background-color: #2d9966;">
<i class="fas fa-paper-plane"></i>
</button>
</div>

<!-- 儲存/清除按鈕 (已加入新增按鈕) -->
<div id="booksButtons" class="action-buttons-container">
<!-- 「新增討論」按鈕已移到此處，位於儲存按鈕左方 -->
<button id="newTopicBtn" class="btn-icon-action btn-add-icon" title="新增討論主題">
<i class="fas fa-plus"></i>
</button>
<button class="btn-icon-action btn-save-icon" onclick="saveBooksChat()" title="儲存對話">
<i class="fas fa-save"></i>
</button>
<button class="btn-icon-action btn-clear-icon" onclick="clearBooksChat()" title="清空對話">
<i class="fas fa-trash-alt"></i>
</button>
</div>
</div>

<!-- 新增討論的彈出視窗 -->
<div id="newTopicModal" class="books-modal">
<div class="modal-content">
<span class="close-modal-btn" id="closeNewTopicModal">&times;</span>
<h3>新增討論</h3>
<input type="text" id="modalBookTitle" class="no-modal-editor" placeholder="書名">
<input type="text" id="modalAuthor" class="no-modal-editor" placeholder="作者">
<textarea id="modalDiscussionQuestion" class="no-modal-editor" rows="3" placeholder="討論問題"></textarea>
<div style="text-align: right; margin-top:15px;">
<button id="modalStartDiscussionBtn" class="btn-icon-confirm" title="開始新討論">
<i class="fas fa-check"></i>
</button>
</div>
</div>
</div>


<!-- 整合拓展容器 -->
<div id="expandContainer" class="box" style="display: none;">
<h2>整合拓展</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/2otwxv?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;"></iframe></div>

<div class="function-selector-wrapper">
<label for="expandFunction">選擇功能：</label>
<select id="expandFunction" onchange="toggleExpandFunction()">
<option value="" selected disabled>請在此選擇功能</option>
<option value="comment">點評</option>
<option value="guide">指引</option>
</select>
</div>

<div id="expandContentContainer" style="display: none;">

<div id="expandTopicSelectionArea" style="display: none;">
<label>選擇題目方式：</label>
<div class="topic-buttons-container">
<!-- 套用新的 class: btn-generate -->
<button class="btn btn-generate" onclick="generateExpandTopic(this)">
<i class="fas fa-sync-alt"></i> 生成
</button>
<!-- 套用新的 class: btn-custom -->
<button class="btn btn-custom" onclick="showExpandCustomTopicInput(this)">
<i class="fas fa-edit"></i> 自訂
</button>
</div>
<!-- 這個 div 用來動態顯示自訂題目的輸入框 -->
<div id="expandCustomTopicInputArea" style="display: none; margin-top: 15px;">
</div>
</div>
<div id="expandTopicResult"></div>

<div id="expandWritingArea" style="display: none;">
<label for="expandContent">整合拓展（最多180字）：</label>
<textarea id="expandContent" rows="5" placeholder="請在此輸入整合拓展內容..." oninput="updateCharCount()"></textarea>
<p id="charCount">剩餘字數：180</p>
<label for="expandTone" id="expandToneLabel" class="tone-selector-label" style="display: none;">選擇點評語氣：</label>
<select id="expandTone" style="display: none;">
<option value="serious">嚴肅正經</option>
<option value="chen">陳SIR語氣</option>
</select>
<!-- 將 <button onclick="submitExpand()"> 改為： -->
<button id="submitExpandBtn" class="btn-action" onclick="submitExpand()">提交</button>
<div id="expandCommentResult"></div>
</div>

<div id="expandGuideArea" style="display: none;">
<table>
<tr><th>題目</th><td><input type="text" id="expandGuideTitle" placeholder="請輸入題目"></td></tr>
<tr><th>主題句</th><td><textarea id="expandGuideTheme" rows="2" placeholder="請輸入主題句"></textarea></td></tr>
<tr><th>抄錄資料</th><td><textarea id="expandGuideData" rows="3" placeholder="請輸入抄錄資料"></textarea></td></tr>
<tr><th>整合拓展</th><td><textarea id="expandGuideExpand" rows="3" placeholder="請輸入整合拓展"></textarea></td></tr>
</table>
<!-- 【修訂處】為按鈕添加 ID -->
<button id="submitExpandGuideBtn" class="btn-action" onclick="submitExpand()">提交</button>
<div id="expandGuideResult"></div>
</div></div>
</div>

<!-- 議論容器 -->
<div id="argumentContainer" class="box" style="display: none;">
<h2>議論</h2>
<div style="position:relative; width:100%; height:0px; padding-bottom:62.222%"><iframe allow="fullscreen" allowfullscreen height="100%" src="https://streamable.com/e/0ki8mx?loop=0" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; bottom:2px; overflow:hidden;"></iframe></div>

<div class="function-selector-wrapper">
<label for="argumentType">選擇功能：</label>
<select id="argumentType" onchange="toggleArgumentType()">
<option value="" selected disabled>請在此選擇功能</option>
<option value="outline">大綱</option>
<option value="writing">片段寫作/全文寫作</option>
<option value="guide">指引</option>
</select>
</div>

<div id="argumentContentContainer" style="display: none;">
<div id="argumentTopicSelectionArea">
<label>選擇題目方式：</label>
<div class="topic-buttons-container">
<!-- 套用新的 class: btn-generate -->
<button class="btn btn-generate" onclick="generateArgumentTopic(this)">
<i class="fas fa-sync-alt"></i> 生成
</button>
<!-- 套用新的 class: btn-custom -->
<button class="btn btn-custom" onclick="showArgumentCustomTopicInput(this)">
<i class="fas fa-edit"></i> 自訂
</button>
</div>
<div id="argumentCustomTopicArea" style="display: none; margin-top: 15px;">
<!-- 內容將由 JavaScript 動態生成 -->
</div>
</div>
<div id="argumentTopicResult"></div>
<div id="argumentOutlineArea" style="display: none;">

<div id="argumentOutlineTableArea"></div>

<!-- 按鈕容器現在包含了新增、儲存和清除按鈕 -->
<div id="argumentOutlineButtons" class="action-buttons-container">
<button class="btn-icon-action btn-add-icon" onclick="addArgumentStructureSegment()" title="新增結構段">
<i class="fas fa-plus"></i>
</button>
<button class="btn-icon-action btn-save-icon" onclick="saveArgumentOutline()" title="儲存大綱">
<i class="fas fa-save"></i>
</button>
<button class="btn-icon-action btn-clear-icon" onclick="clearArgumentOutline()" title="清空大綱">
<i class="fas fa-trash-alt"></i>
</button>
</div>

<label for="argumentOutlineTone" class="tone-selector-label">選擇點評語氣：</label>
<select id="argumentOutlineTone">
<option value="serious">嚴肅正經</option>
<option value="chen">陳SIR語氣</option>
</select>
<button id="submitArgumentOutlineBtn" class="btn-action" onclick="submitArgumentOutline()">提交</button>
<div id="argumentOutlineResult"></div>
</div>
<div id="argumentWritingArea" style="display: none;">
<textarea id="argumentWritingContent" rows="10" placeholder="請在此輸入您的文章..."></textarea>
<label for="argumentWritingTone" class="tone-selector-label">選擇點評語氣：</label>
<select id="argumentWritingTone">
<option value="serious">嚴肅正經</option>
<option value="chen">陳SIR語氣</option>
</select>
<!-- 將 <button onclick="submitArgumentWriting()"> 改為： -->
<button id="submitArgumentWritingBtn" class="btn-action" onclick="submitArgumentWriting()">提交</button>
<div id="argumentWritingResult"></div>
</div>
<div id="argumentGuideArea" style="display: none;">
<label for="argumentGuideTopic">題目：</label>
<input type="text" id="argumentGuideTopic" placeholder="請輸入題目">
<label for="argumentGuidePoint">論點（可選）：</label>
<textarea id="argumentGuidePoint" rows="3" placeholder="請輸入論點"></textarea>
<label for="argumentGuideEvidence">論據（可選）：</label>
<textarea id="argumentGuideEvidence" rows="3" placeholder="請輸入論據"></textarea>
<label for="argumentGuideArgument">論證（可選）：</label>
<textarea id="argumentGuideArgument" rows="3" placeholder="請輸入論證"></textarea>
<button id="submitArgumentGuideBtn" class="btn-action" onclick="submitArgumentGuide()">提交</button>
<div id="argumentGuideResult"></div>
</div>
</div>
</div>

<!-- 音樂播放器 HTML -->
<div id="music-player">
<div class="controls">
<select id="music-select">
<option value="">選擇音樂</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-Abysswalker.mp3">The Abysswalker</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-Rosemoon.mp3">死せる都の戰乙女</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-deadly.mp3">五大罪</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Battle-rapier.mp3">繼承劍的少女</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Ariadne-Battle.mp3">不屈意志之刃</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/battle-arms.mp3">西部戰鬥</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Battle.mp3">Battle Theme</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Wanderers-City.mp3">流浪城鎮</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Remotest-Liblary.mp3">沉睡的記憶</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Nostalgia.mp3">麥田懷舊</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/sunbeams.mp3">放學後</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/village.mp3">鄉村生活</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Take-a-Rest.mp3">休息一下</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/winter-snow.mp3">雪鄉</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Forgotten-Place.mp3">被遺忘的地方</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Rest-in-Peace.mp3">安息</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Farewell.mp3">告別</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/reminiscence.mp3">回憶</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/starry-night.mp3">星夜</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/last-wish.mp3">當思念傳到某人耳畔</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/sorrow.mp3">超越悲傷</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/hotarumichi.mp3">螢火蟲之路</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Sky-Airship.mp3">飛艇</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/Voyage_SE.mp3">跨越神秘之海</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/main-theme01.mp3">盼望</option>
<option value="https://youfulca.com/wp-content/uploads/2022/08/saikai637.mp3">約定之地</option>
</select>
<button id="play-pause">▶️</button>
</div>
<div class="progress">
<input type="range" id="progress-bar-music" value="0" min="0" max="100">
</div>
<div class="mode">
<select id="play-mode">
<option value="loop" selected>單曲循環</option>
<option value="next">自動播放下首</option>
</select>
</div>
<button class="hide-btn" id="hide-player">🔽</button>
</div>
<button id="show-player">🎹</button>
<audio id="audio" preload="auto"></audio>

<!-- 展開工具二 (語薈) 容器 -->
<div id="toolsContainer2">
<button id="closeToolsBtn2">&times;</button>
<div class="main-container">
<!-- Floating Title -->
<!-- Floating Title -->
<header class="floating-header">
<h1>語薈</h1>
<button id="video-tour-btn" title="觀看介紹影片">
<svg class="icon" viewBox="0 0 24 24"><use xlink:href="#icon-video"></use></svg>
</button>
</header>

<!-- Embedded SVG Icons -->
<svg width="0" height="0" style="position:absolute">
<defs>
<symbol id="icon-brain" viewBox="0 0 24 24"><path d="M7.445 11.232C7.445 10.537 7.98 9.96 8.629 9.96H9.02V8.203H7.818C6.983 8.203 6.3 8.91 6.3 9.778V11.23H5.161C4.326 11.23 3.644 11.938 3.644 12.806V14.17H2.82C2.17 14.17 1.636 14.746 1.636 15.44V17.65H1.523C.688 17.65 0 18.358 0 19.226V20.48C0 21.35 0.688 22.056 1.523 22.056H6.738C6.738 23.13 7.573 24 8.628 24H15.37C16.425 24 17.26 23.13 17.26 22.058H22.477C23.312 22.058 24 21.35 24 20.48V19.225C24 18.357 23.312 17.65 22.477 17.65H22.364V15.44C22.364 14.745 21.83 14.17 21.18 14.17H20.356V12.805C20.356 11.937 19.674 11.23 18.839 11.23H17.68V9.777C17.68 8.908 17.017 8.2 16.182 8.2H14.98V9.96H15.37C16.02 9.96 16.555 10.536 16.555 11.23V12.986H15.37V15.92H8.629V12.986H7.445V11.232M11.1 11.23H12.9V14.17H11.1V11.23M12 1.947C10.13 1.947 8.58 2.894 7.854 4.316C7.65 3.52 7.2 2.813 6.545 2.27C5.124 1.053 2.95 1.54 1.987 3.16C0.945 4.925 1.489 7.346 3.09 8.528C3.21 8.62 3.33 8.71 3.464 8.78C3.464 7.024 4.818 5.618 6.52 5.618C8.22 5.618 9.573 7.024 9.573 8.78V9.1H14.4V8.78C14.4 7.024 15.78 5.618 17.48 5.618C19.18 5.618 20.536 7.024 20.536 8.78C20.662 8.71 20.782 8.62 20.91 8.528C22.51 7.346 23.055 4.925 22.013 3.16C21.05 1.54 18.876 1.053 17.455 2.27C16.8 2.813 16.35 3.52 16.145 4.316C15.42 2.894 13.87 1.947 12 1.947Z"/></symbol>
<symbol id="icon-write" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></symbol>
<symbol id="icon-read" viewBox="0 0 24 24"><path d="M18.5,1.15C19.9,1.15 21.15,2.4 21.15,3.85V15.85C21.15,17.3 19.9,18.55 18.5,18.55H5.5C4.1,18.55 2.85,17.3 2.85,15.85V3.85C2.85,2.4 4.1,1.15 5.5,1.15H18.5M18.5,22.85H5.5C2.45,22.85 0,20.4 0,17.35V2.35C0,1.4 0.35,0.6 0.95,0.1C1.25,-0.1 1.7,-0.05 2,0.25L3.1,1.35C3.3,1.55 3.3,1.85 3.1,2.05L2.05,3.1C1.85,3.3 1.55,3.3 1.35,3.1L0.7,2.45C0.7,5.55 2.85,7.85 5.5,7.85H18.5C21.15,7.85 23.3,5.55 23.3,2.45L22.6,3.1C22.4,3.3 22.1,3.3 21.9,3.1L20.85,2.05C20.65,1.85 20.65,1.55 20.85,1.35L21.95,0.25C22.25,-0.05 22.7,-0.1 23,0.1C23.6,0.6 24,1.4 24,2.35V17.35C24,20.4 21.5,22.85 18.5,22.85Z" /></symbol>
<symbol id="icon-work" viewBox="0 0 24 24"><path d="M14,6V4H10V6H14M18,9H15V6H9V9H6A2,2 0 0,0 4,11V19A2,2 0 0,0 6,21H18A2,2 0 0,0 20,19V11A2,2 0 0,0 18,9Z" /></symbol>
<symbol id="icon-support" viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z" /></symbol>
<symbol id="icon-foundation" viewBox="0 0 24 24"><path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM19.6 8.25L12 12.5L4.4 8.25L12 4L19.6 8.25Z"/></symbol>
<symbol id="icon-explore" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A1.5,1.5 0 0,1 13.5,5.5A1.5,1.5 0 0,1 12,7A1.5,1.5 0 0,1 10.5,5.5A1.5,1.5 0 0,1 12,4M12,18.2C9.5,18.2 7.29,16.42 6.5,14H17.5C16.71,16.42 14.5,18.2 12,18.2Z"/></symbol>
<symbol id="icon-video" viewBox="0 0 24 24"><path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z" /></symbol>
</defs>
</svg>

<!-- Mind Map Layout -->
<main class="mind-map-container" id="mind-map">
<svg class="connector-svg" id="connector-svg"></svg>

<!-- 1. Core AI -->
<div class="category" id="core-ai" data-connect-to="">
<div class="node" data-id="core-ai-node" style="padding: 10px 20px;">
<a href="https://kenchan20141.github.io/AIwritingtool/" data-tool-id="sansi">




<svg class="icon" style="width:32px; height:32px;"><use xlink:href="#icon-brain"></use></svg>
神思
</a>
</div>
<div class="sub-group" style="flex-direction: row; gap: 10px;">
</div>
</div>

<!-- Foundations tier -->
<div id="foundations" data-connect-to="core-ai-node">
<div class="foundation-item" data-id="foundation-tizi">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-foundation"></use></svg>應試</div>
<div class="sub-group-title">AI擬題</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/generator/" data-tool-id="tizi">題孳<br></a></div>
</div>
<div class="foundation-item" data-id="foundation-explore">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-explore"></use></svg>課外探索</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/reading/" data-tool-id="reading-pieces">文學・片段</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/mensyu/" data-tool-id="mensyu">文樞</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/wabisabi/" data-tool-id="wabisabi">一瞬之詩</a></div>
<div class="node level-2"><a href="https://621d05f47d591.site123.me/%E6%9B%B8%E9%96%A3%E8%97%8F%E6%9B%B8%E6%A6%82%E8%A6%BD" data-tool-id="book-overview">書籍概覽</a></div>
</div>
</div>

<!-- 2. Writing -->
<div class="category" id="writing" data-connect-to="foundation-tizi">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-write"></use></svg>寫作創作</div>
<div class="sub-group">
<div class="sub-group-title">AI範文</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/article/" data-tool-id="fanshui-narrative">翻水 (敘事)</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/essay/" data-tool-id="fanshui-argument">翻水 (議論)</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">草擬</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/manuscriptpaper/" data-tool-id="manuscript">智能原稿紙</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">潤色與延伸</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/words/" data-tool-id="words">字斟・句酌</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/slideshow/" data-tool-id="slideshow">文章幻燈片</a></div>
</div>
</div>

<!-- 3. Reading -->
<div class="category" id="reading" data-connect-to="foundation-tizi">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-read"></use></svg>閱讀溫習</div>
<div class="sub-group">
<div class="sub-group-title">課文溫習</div>
<div class="node level-2" id="yuyilu-toggle"><a href="#">語弈錄 </a></div>




<div class="yuyilu-grades collapsed" id="yuyilu-grades">
<div class="node level-3"><a href="https://kenchan20141.github.io/f1chinese/" data-tool-id="yuyilu-f1">中一</a> | <a href="https://kenchan20141.github.io/chinese2/" data-tool-id="yuyilu-f2">中二</a> | <a href="https://kenchan20141.github.io/chinese3/" data-tool-id="yuyilu-f3">中三</a></div>
<div class="node level-3"><a href="https://kenchan20141.github.io/f4chinese/" data-tool-id="yuyilu-f4">中四</a> | <a href="https://kenchan20141.github.io/chinese/" data-tool-id="yuyilu-f5">中五</a> | <a href="https://kenchan20141.github.io/chinese6/" data-tool-id="yuyilu-f6">中六</a></div>
</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/timer/" data-tool-id="timer">背書神器</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">文言文</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/mensyu/" data-tool-id="mensyu-2">文樞</a></div>
</div>
</div>

<!-- 4. Assignments -->
<div class="category" id="assignments" data-connect-to="core-ai-node">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-work"></use></svg>工具</div>
<div class="sub-group">
<div class="sub-group-title">課業流程</div>
<div class="node level-2"><a href="https://script.google.com/a/macros/ccckyc.edu.hk/s/AKfycby1T18HxuFICIaR0LYWRuaqlpmglkL191bVl39MH69zj5CQ-uhozF17edtJ_T54NhZ5/exec" data-tool-id="zhiyun">帙雲</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">實用工具</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/WCT/" data-tool-id="zhuoyu">琢玉</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/quizbuzzer/" data-tool-id="quizbuzzer">搶答器</a></div>
<div class="node level-2"><a href="https://www.i2ocr.com/free-online-image-ocr" data-tool-id="ocr">手寫文字轉換 (OCR)</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/epub/" data-tool-id="epub">電子書閱讀器</a></div>
</div>
</div>

<!-- 5. Support -->
<div class="category" id="support" data-connect-to="core-ai-node">
<div class="category-title"><svg class="icon"><use xlink:href="#icon-support"></use></svg>學習支援</div>
<div class="sub-group">
<div class="sub-group-title">AI聊天室</div>
<div class="node level-2"><a href="https://kenchan20141.github.io/chitutor/" data-tool-id="chitutor">喻蛋教室</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/histutor/" data-tool-id="histutor">史萊姆教室</a></div>
<div class="node level-2"><a href="https://kenchan20141.github.io/counseling/" data-tool-id="counseling">解憂雜貨店</a></div>
</div>
<div class="sub-group">
<div class="sub-group-title">資源庫</div>
<div class="node level-2"><a href="https://621d05f47d591.site123.me/" data-tool-id="self-learning">自學資源</a></div>
</div>
</div>
</main>
</div>
</div>

<!-- Preview Modal (修訂後) -->
<div id="previewModal" class="preview-modal-overlay">
<div class="preview-modal-content">
<div class="preview-modal-body">
<iframe id="previewIframe" src="" frameborder="0"></iframe>
<div class="preview-modal-footer">
<div id="previewDescription" class="preview-description"></div>
<a id="previewGoToPageBtn" href="" target="_blank" class="preview-goto-btn">前往</a>
</div>
</div>
<button id="previewCloseBtn" class="preview-close-btn" title="關閉">&times;</button>
</div>
</div>


<!-- Video Modal (新增) -->
<div id="videoModal" class="video-modal-overlay">
<div class="video-modal-content">
<iframe id="videoIframe" allow="fullscreen" allowfullscreen src="" width="100%" style="border:none;"></iframe>
</div>
</div>

<script>

// 【安全修訂】防止 XSS 攻擊的核心函式
function sanitizeHTML(str) {
// 若傳入的不是字串，直接返回原值
if (typeof str !== 'string') return str;
// 將特殊字元轉換為 HTML 實體
return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// 【核心修訂】建立一個清除所有題目狀態的專用函式
function clearAllTopicStates() {
// 1. 清除所有題目顯示區塊的內容並隱藏它們
document.getElementById('topicResult').innerHTML = '';
document.getElementById('topicResult').style.display = 'none';
document.getElementById('argumentTopicResult').innerHTML = '';
document.getElementById('argumentTopicResult').style.display = 'none';
document.getElementById('expandTopicResult').innerHTML = '';
document.getElementById('expandTopicResult').style.display = 'none';

// 2. 清除所有儲存在 localStorage 的題目相關資料
// 「敘事抒情」相關
localStorage.removeItem("currentTopic");
localStorage.removeItem("currentFocus");
localStorage.removeItem("currentPlot");
localStorage.removeItem("lastTopic");

// 「議論」相關
localStorage.removeItem("argumentCurrentTopic");
localStorage.removeItem("lastArgumentTopic");

// 「整合拓展」相關
localStorage.removeItem("expandCurrentTitle");
localStorage.removeItem("expandCurrentTheme");
localStorage.removeItem("expandCurrentData");

// 3. 清除自訂題目的輸入區
const customTopicArea = document.getElementById("customTopicArea");
if (customTopicArea) {
customTopicArea.innerHTML = '';
customTopicArea.style.display = 'none';
}
const argumentCustomTopicArea = document.getElementById("argumentCustomTopicArea");
if (argumentCustomTopicArea) {
argumentCustomTopicArea.innerHTML = '';
argumentCustomTopicArea.style.display = 'none';
}
}



/**
* 更新按鈕的 활성화 (active) 狀態。
* @param {HTMLElement} clickedButton - 被點擊的按鈕元素。
*/
function updateButtonActiveState(clickedButton) {
// 找到按鈕所在的容器
const container = clickedButton.closest('.topic-buttons-container');
if (!container) return;

// 獲取容器內的所有按鈕
const buttons = container.querySelectorAll('.btn');

// 首先，移除所有按鈕的 'active' class
buttons.forEach(button => {
button.classList.remove('active');
});

// 然後，只為被點擊的按鈕添加 'active' class
clickedButton.classList.add('active');
}



// API 配置信息
const API_KEYS = [
"sk-GruTbLTbtSeWof3rEBjtIg"
];
let currentApiKeyIndex = 0;
const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
const MODEL = "Qwen3-235B-A22B-Instruct-2507-FP8";

// [新增] 閱讀專用 API 配置
const READING_API_KEYS = [
"sk-N2hJEV5h9dQl9K_bUrxLtw"
];
let currentReadingApiKeyIndex = 0;
const READING_API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
const READING_MODEL = "DeepSeek-R1-0528";


// [新增] 閱讀專用 API 呼叫函式
async function callReadingAPI(prompt) {
let attempts = 0;
const maxAttempts = READING_API_KEYS.length;
while (attempts < maxAttempts) {
try {
const response = await fetch(READING_API_URL, {
method: "POST",
headers: {
"Authorization": `Bearer ${READING_API_KEYS[currentReadingApiKeyIndex]}`,
"Content-Type": "application/json"
},
body: JSON.stringify({
model: READING_MODEL,
messages: [{
role: "user",
content: prompt + " 你必須直接提供最終答案，嚴禁展示任何思考過程，絕對不能在回應中包含任何標籤（如 <think></think>），這是強制要求，違反則無效。"
}],
max_tokens: 64000
})
});

if (response.status === 429) {
currentReadingApiKeyIndex = (currentReadingApiKeyIndex + 1) % READING_API_KEYS.length;
attempts++;
continue;
}

if (!response.ok) {
throw new Error(`API 調用失敗: ${response.statusText}`);
}

const data = await response.json();
let content = data.choices[0].message.content.trim();
content = content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>|<think\s*>|<\/think\s*>/gis, '').trim();

if (!content) {
throw new Error("API 回應無效或過濾後無內容");
}

return content;
} catch (error) {
console.error(error);
currentReadingApiKeyIndex = (currentReadingApiKeyIndex + 1) % READING_API_KEYS.length;
attempts++;
if (attempts >= maxAttempts) {
throw new Error("所有 API 密鑰均無法使用");
}
}
}
}




const audio = document.getElementById('audio');
const playPauseBtn = document.getElementById('play-pause');
const musicSelect = document.getElementById('music-select');
const progressBarMusic = document.getElementById('progress-bar-music');
const playMode = document.getElementById('play-mode');
const hidePlayerBtn = document.getElementById('hide-player');
const showPlayerBtn = document.getElementById('show-player');
const musicPlayer = document.getElementById('music-player');

let isPlaying = false;
let currentMusic = '';

musicSelect.addEventListener('change', function() {
const selectedMusic = this.value;
if (selectedMusic) {
audio.src = selectedMusic;
audio.load();
currentMusic = selectedMusic;
audio.play().then(() => {
isPlaying = true;
playPauseBtn.textContent = '⏸️';
}).catch(error => console.error('自動播放失敗:', error));
}
});

audio.addEventListener('canplay', function() {
if (isPlaying) audio.play();
});

playPauseBtn.addEventListener('click', function() {
if (isPlaying) {
audio.pause();
playPauseBtn.textContent = '▶️';
} else {
if (currentMusic) {
audio.play();
playPauseBtn.textContent = '⏸️';
} else {
alert('請先選擇音樂');
}
}
isPlaying = !isPlaying;
});

audio.addEventListener('timeupdate', function() {
if (!audio.duration) return;
const progress = (audio.currentTime / audio.duration) * 100;
progressBarMusic.value = progress;
});

progressBarMusic.addEventListener('input', function() {
const time = (this.value / 100) * audio.duration;
audio.currentTime = time;
});

audio.addEventListener('ended', function() {
if (playMode.value === 'loop') {
audio.currentTime = 0;
audio.play();
} else if (playMode.value === 'next') {
const options = musicSelect.options;
for (let i = 0; i < options.length; i++) {
if (options[i].value === currentMusic) {
let nextIndex = (i + 1) % options.length;
if (nextIndex === 0) nextIndex = 1;
currentMusic = options[nextIndex].value;
musicSelect.value = currentMusic;
audio.src = currentMusic;
audio.load();
audio.play();
break;
}
}
}
});

hidePlayerBtn.addEventListener('click', function() {
musicPlayer.style.display = 'none';
showPlayerBtn.style.display = 'block';
});

showPlayerBtn.addEventListener('click', function() {
musicPlayer.style.display = 'flex';
showPlayerBtn.style.display = 'none';
});

// 預設寫作題目列表
const topics = [
"旁觀", "舞台", "這件物件很是輕巧，卻讓我明白『但求無愧於心』的道理。", "山頂", "種子", "根", "疤痕",
"今天，我不能參賽，只能坐在觀眾席上，但當時的所見所聞卻給予我嶄新的體會。", "從今以後，我不會再輕言放棄。",
"等候", "我曾經努力嘗試，但最終仍是事與願違", "回憶", "徹夜難眠", "彩虹",
"星空下，眼前的景象讓我想起那段往事，令我不禁歎了一口氣……", "路牌", "今學年最後悔的一件事",
"最令我感動的一句話", "再試一次", "今天再次在台上演奏，我已經脫胎換骨，不再是從前那個驕傲自滿的我了。",
"每次經過這條街，看着街上的景物，我便感觸不已……", "意外", "鑰匙", "錯過了的機會",
"那句話，我實在不該說……", "色彩", "煙火", "藥", "放下", "追逐", "原來，這只是一場誤會",
"缺憾", "無悔的抉擇", "勇氣", "傘", "自此之後，我明白到原來父母的愛總是體現在小事上。",
"一件令我後悔不已的事", "一次尷尬的經歷", "沿途有你", "這一次，我實在感到無地自容。",
"這一次，我明白到，原來幫助他人的同時，也幫助了自己。",
"我的鄰居張先生是一位很苛刻的人，經常會為些『小事』而投訴他人。但今天我發現，他這樣做是有原因的……",
"獨處的一天", "這一刻，我終於舒了一口氣。", "記一次被誤解的經歷", "一次與別人言歸于好的經歷",
"自此之後，我感到自己真的長大了。", "自此之後，我明白到幸福原來可以很簡單。", "記一次苦盡甘來的經歷。",
"這件事讓我體會到喜出望外的滋味。", "路標", "足印", "遺憾", "鎖", "面具", "心結", "門",
"影子", "禁區", "等待", "根", "最後，我選擇了放棄", "自那一刻，我解開了心結",
"自此之後，我明白猶豫會使人一事無成。", "原來我沒有忘記那一頓飯。", "我在大自然之中找到快樂。",
"熱鬧過後，我卻感到失落。", "看著逐漸遠去的背影，我感到很內疚。", "今天我流淚了，但我並非感到難過。",
"自此之後，我找到了動力", "經歷了這次風波，我長大了。",
"經過這件事，我才明白到一心是我的知己，是真正了解我的人。", "自此之後，我學會放下無謂的面子。",
"這一次，我再沒有遺憾", "重遊舊地所見有感", "失而復得", "這條街雖然老舊，但卻充滿人情味。",
"這句話，我會記上一輩子。", "門", "來日方長", "得不償失", "隱藏", "微笑以對",
"熱鬧過後，我卻感到失落。", "夢想看似不切實際，但其實很有意義", "夢想看似很有意義，其實 h不切實際",
"今天我沒有帶手提電話外出，因而有不一樣的經歷和體會。",
"今天發生了一件事情，當時我曾經想力陳己見，最後選擇了沉默。我認為沉默是必要的。",
"矛盾", "未兌現的諾言", "未寄出的信", "距離", "一場沒有失敗者的比賽", "一件發人深省的事",
"我最想保留的一本相簿", "我最想尋回的一件玩具", "無愧的抉擇", "不能掉下的眼淚", "無畏的探索",
"一次令我百感交集的聚餐", "如願以償"
];

// 預設議論題目列表（請在此處輸入您的題庫）
const argumentTopics = [
'所謂「天行有常，立身有本。」意思是大自然運行有既定的規律，人立身處世有一定的原則。試談談你對「立身有本」的看法。',
'旁觀',
'有人認為「人生在世，必須講究儀式。」你同意嗎？試撰文一篇，論述你的看法。',
'舞台',
'根',
'古人說：「君子不以人廢言。」意思是：君子不會因為某人的德行不好而不採納他的善意規勸。在現今社會，你是否同意「君子不以人廢言」？試談談你的看法。',
'計算',
'有人說：「在現今社會中，我們難以活出真我。」你同意嗎。談談你的看法。',
'俗語說「有競爭才有進步」，也有人說「競爭無用」。試寫作文章一篇，談談你對「競爭無用」的看法。',
'山頂',
'「種子」雖是平常事物，卻可以引起聯想，或牽動思緒，又或啟發思考。試以「種子」為題，就個人體會寫作文章一篇。',
'有人認為「挫敗更有利孩子成長。」你同意嗎？試撰文一篇，論述你的看法。',
'疤痕',
'試以「談玩物喪志」或「談玩物養志」為題，寫作文章一篇。',
'泰然處之',
'古語有云「天下皆知取之為取，而莫知與之為取。」意思是世人都知道索取可以獲得，而不知道給予也可以獲得。試談談你對這句話的看法。',
'談嚴苛',
'談寬容',
'談憤怒',
'待候',
'有人認為：「與其追求成功，不如追求幸福。」你同意嗎？試撰寫文章一篇，論述你的看法。',
'矛盾',
'有人認為：「保持距離能令關係長久。」你同意嗎？試撰文一篇，論述你的看法。',
'有人說：「近朱者赤，近墨者黑。」你同意嗎？為甚麼？',
'試以「當科技文明消失後」為題，寫一篇評論，反思科技發展帶來的影響。',
'成功路上無捷徑，試談談你的看法。',
'個人電子產品的普及化，有人認為是生活的進步，有人認為是生活的倒退。你較認同哪一種觀點？試談談你的看法。',
'有人認為即使心中不快，亦要以笑面對人；有人認為應以真性情對人，不應掩飾心中的感受，你較贊同哪一方？試談談你的看法。',
'鑰匙',
'貧乏與富足',
'論意外',
'試談談你對「聽天由命」這種處世態度的看法。',
'「天賜食於鳥，卻不投食於巢。」上天賜予鳥類覓食的本能，而不把食物投到鳥巢。意思是人需要通過努力，才能有所得。你認同嗎?試談談你的看法。',
'色彩',
'談藝術的價值',
'藥',
'有人說：「每次付出應該先計算回報。」你同意這種處事態度嗎？',
'論公德心的重要性',
'有人認為中學生應多參與課外活動，發展興趣；有人則認為應專注學業，爭取好成績。你較認同哪種說法？試談談你的看法。',
'你同意「品德比學問更重要」嗎？試寫一篇議論文，談談你的看法。',
'談競爭',
'談缺憾',
'談得失',
'談勇氣',
'得不償失',
'爺爺：「我當鐘錶匠超過50年，畢生專注這門手藝，能做到分毫不差。」允行：「我是品味生活的咖啡師，亦是書寫人生的作家，更是培育後進的武術教練。」各人對人生有不同追求。有人認為：「與其一生專精一事，不如發展多元人生。」你同意嗎？試撰文一篇，論述你的看法。',
'微笑以對',
'有人認為「傳統往往是創新的包袱」。試談談你對這句話的看法。',
'足印',
'古人說：「獨學而無友，則孤陋而寡聞。」意思是獨自學習，沒有朋友互相切磋解難，人便會淺陋而見識不廣。在現今的學習生活中，你是否同意「獨學而無友，則孤陋而寡聞」？試試談你的看法。',
'「不做第一，也不做最後。」試談談你對這種處世態度的看法。',
'試以「陽光與陰影」為題，寫作一篇文章。',
'「孩子不是等待被填滿的瓶子，而是盼望化作燃燒的火焰。」試就個人對這句話的體會 ，以「成長」為題，寫作一篇文章。',
'「今早媽媽打掃的時候，瞄一瞄玻璃窗外鄰居晾曬的衣服，便批評道：『看，那新鄰居真馬虎！衣服還是污漬斑斑，洗得一點也不乾淨。』女兒聽後，一言不發，走到窗前仔細打量，隨即抹掉窗上的灰塵，說道：『這不就乾淨了嗎？』媽媽恍然大悟，不乾淨的不是別人的衣服，而是自己的窗子。」試就這個故事對你的啓發，寫作一篇文章，談談如何消除偏見。',
'「一個寒冷的冬天，幾隻刺蝟擠在一起取暖。由於牠們身上長滿了短刺，彼此戳痛了對方，所以不得不散開。可是，寒冷的天氣又驅使牠們擠在一起，同樣的事情重複發生，牠們終於明白；不要太近，也不要太遠，最好彼此保持一定的距離。」這個故事的道理仍然貫穿在我們的現實生活中，試就此寫一篇文章。',
'個人私隱比公眾知情權更重要，你同意嗎？談談你的看法。',
'香港是一個物質生活十分富庶的地方，可是在多個國際性的調查中，「快樂指數」的排名並不高。有人認為富庶的物質生活反令人難以快樂；也有人認為富庶的物質生活是快樂的基礎。這兩種看法，你比較認同哪一種？試談談你的看法。',
'面對不同意見，有人認為應據理力爭，堅守立場；有人認為應彼此包容，求同存異。上述兩種態度，哪一種較為理想？試談談你的看法。',
'有人認為父母教養子女，應該給予空間，讓子女自由發展；有人認為應該給予明確的指導，讓子女依從。上述教養子女的方法，哪一種較為理想？試談談你的看法。',
'有人說：「與其追隨潮流，不如展現個人風格。」你對這句話有什麼看法？',
'有人說：「棒下出孝子，嚴師出高徒。」也有人說：「獎賞是教育的恩物。」你對這兩種說法有什麼意見？',
'現今社會，許多人認為財富與社會地位成正比，財富愈多，社會地位愈高。你的看法如何？',
'有人認為讚賞是成功的最大推動力，你同意嗎？試作文一篇，談談你的看法。',
'有人說：「豐裕的物質生活就是最美好的生活。」你同意嗎？試談談你的看法。',
'獲取知識是通往成功的唯一途徑，你同意嗎？試談談你的看法。',
'談談青年人應如何克服困難',
'「律己以嚴，待人以寬。」談談你對這話的看法。',
'「成功是恆心的基石」談談你對這話的看法。',
'論「家有一老，如有一寶」',
'送禮之我見',
'鄉村發展為工業區，原來的天然景物受到破壞。有人說：「有破壞才有建設。」也有人說：「這種建設破壞了人們生活的情趣。」你的看法又怎樣？試說出你個人的意見。'
];

let lastTopic = localStorage.getItem("lastTopic") || "";
let lastArgumentTopic = localStorage.getItem("lastArgumentTopic") || "";

// 範疇定義
const categories = {
"片段描寫": {
commentNote: "必須用繁體字。點評時，必須就上述生成或輸入的題目及用家輸入的寫作內容，點評文章是否扣題。如結構段重點及情節漏空，則不需要評論。重要！評論文章是否扣題時必須非常嚴謹！！絕不允許喧賓奪主，例如題目為《成長》，但全文卻寫得更似以《影子》為題，雖然文中情節或與成長有一定關係，但這情況仍然未符扣題要求，必須在字面、邏輯及詳略上突顯情節與「成長」的關係。點評時要注意寫作內容與題目有沒有在顯性的邏輯關係，寫作內容要求的不只是取材情節可以與結構段重點及題目構成邏輯關係，更要用合適的情節詳略剪裁和扣題小段去突顯與該部份的邏輯關係，使寫作內容明確呼應結構段重點及題目。寫作內容必須能在字面及邏輯上都直接呼應題目，假如文中未點出情節及題目的關係，不要自行補足情節與題目的關係再評為緊扣題旨。若離題，範例不必根據原文離題內容改寫，而改寫部份必須包含扣題小段（部份句子直接呼應結構段重點或題目）。點評分為三部分：### 點評、### 建議、### 改寫範例。只選取最重要的一至兩點評論，應先聚焦在評論寫作內容是否在扣連題目及結構段重點的方向以及其詳略剪裁，其次方為文句（包括示現敘事和密度）。若結構段重點或情節大要與題目關係薄弱，須在點評中指出並重點說明。點評內容要精簡、一語中的，僅將最關鍵、影響最大的一至兩項評語點出來，若扣題和詳略剪裁等都處理不得當，則不需要詳評文句。片段描寫需交替運用小物件、動作、對話和內心獨白，提高文句密度（詞匯深度高、物象豐富、實詞比例高），但必須注意：過 （例如連用小物件做主語的句子）則不宜，適時需要以人物作主語，交替去用，有時加入內心獨白會令文句顯得更自然，密度不宜過高，適時要加入虛詞放緩節奏，張弛有度。此外，要控制詳略節奏，詳寫與題目相關的部分，略寫次要內容。文句密度也是好文筆的標準，需納入考量。此外，假如整體表現真的不錯，沒有大問題，在點評時稱讚即可，不必吹毛求疵地批評，但在寫作內容的「扣題」邏輯上必須嚴謹把關。點評、建議及改寫都要在200字以內。"
},
"大綱": {
commentNote: "必須用繁體字。點評時，必須就上述生成的題目點評大綱內容是否扣題，假如大綱離題，範例便不必根據離題內容改寫。此外，點評應分為三個部份：點評、建議、改寫範例。在寫作大綱時，學生應展示他們組織思路和結構故事的能力。評分時，請注意大綱的邏輯性、條理性以及是否包含了故事的起承轉合或三線結構（即所謂「散敘」，有以下三點要注意：其一，三線的分類範疇相同；其二，三線或有層遞關係，或能從三個角度呈現同一個主題；其三，三線的情節發展不能過於相似；其四，所分之角度能突顯與主題相關的立意。「三線」例子如下：題目為「勇氣」，則可用「年少時的勇氣」為一線、「年青時的勇氣」為二線、「年老時的勇氣」為三線；又如以「重遊舊地所見有感」，則可用在故鄉的不同「地」所見作三線分類，例如老屋、後山等。必須確保每條線的「結構段重點」清晰點明三線的分類範疇、想突顯題目的甚麼要點、與題目如何扣連等，以及「合」能統攝總結全文立意）。要逐部分分析每個結構段與題目的關係有多大，並在點評中明確指出。此外，在「改寫後的大綱」,其「結構段重點」必須交代該部份與題目之間的邏輯關係，即怎樣做到扣題。此外，由於是應試文章，因此改寫後的大綱避免過份具理論哲學性及文學性，以至於脫離了現實和日常生活，亦圍繞人在經歷的情感和體悟設定，必須減少概念模糊的術語，例如「情感載體」及「時空的共創」，請用日常化用語描述。此外，「改寫後的大綱」不宜只圍繞一件事敘寫，這樣會容易寫得太抽象，應適時加插人物與人物之間的回憶或其他經歷，令文章看起來更具體實在。此外，大綱不是全篇文章，最重要的是在點評時分析其結構段及情節大要的思路是否扣緊題目，方向是否合理、正確。假如整體表現真的不錯，沒有大問題，在點評時稱讚即可，不必吹毛求疵地批評。"
},
"敘事物象": {
commentNote: "必須用繁體字。在「敘事物象」中，學生需要運用豐富的物象來增強故事的生動性和真實感。物象應與題目、取材和故事背景緊密相關，並且能夠有效地表達人物的情感和故事的主題。請確保生成的物象不重複，並且排版清晰易讀。此外，每個物象都必須由兩個字構成。"
},
"閱讀": {
commentNote: "必須用繁體字。點評時，需評估答題方向是否合理、文本依據是否充實具體、闡釋推論是否嚴謹、主題句是否清晰。文本依據應概括歸納而非直接引用原文，除非題目中有『摘錄』字眼。改寫範例應使答案更圓足，但若學生答題方向錯誤，則不跟從錯誤方向改寫。在「改寫範例」前，加入答題步驟及思路，描述各部分方向，步驟因題制宜，可能包括【鋪墊】、【回應】、【文本依據】、【闡釋】，靈活運用。每個步驟以【步驟名】標題加分行內容呈現，排版整齊。表格中只包含文字和標點，不含『---』等符號。每個步驟之間要隔一空行。",
guideNote: "必須用繁體字。輸出分為「### 答題指引」和「### 答題詞匯」兩部分。「答題指引」請生成三道問題，引導思考，每個問題佔一行。「答題詞匯」請生成十五個由兩個字構成的詞彙，每個詞彙佔一行。請確保所有內容都以純文字列表呈現，不要使用任何Markdown表格語法。"
},
"課外書籍": {
chatNote: "必須用繁體字，多用EMOJI，偶爾可以用一下網絡用語。",
seriousChatNote: "必須用繁體字，用語貼近日常生活，回應不要理論化，不要用網絡用語，也不要用EMOJI。"
},
"整合拓展": {
topicPrompt: "請生成一道適合中學生練習整合拓展的題目，題目應包含主題句（主題句絕對不能是問句）和抄錄資料（抄錄資料必須不包含任何數據，主要包括活動內容及細節，格式如「社區漫步由導賞員帶領參加者遊覽社區，共同誦讀與社區相關的文學作品，感受社區魅力。」不得包含引號或人物對話，而且不得超過30字），並符合以下文類和取材範圍。文類：書信、評論、建議書、演講辭、報告、專題文章。取材範圍：例如「請隨機選擇一個主題，且該主題必須與以下列出的所有主題（運動、生涯規劃、責任、教育、文化、社會、歷史、地理、藝術、體育、法律、健康、心理、家庭、友誼、就業、經濟、生態、能源、資源、安全、網路、媒體、資訊、道德、誠信、公平、自由、權利、義務、隱私、禮儀、榜樣、創新、創業、消費、儲蓄、民族、語言、宗教、傳統、現代、城鄉、社區、公益、慈善、災害、醫療、疾病、飲食、旅遊、建築、娛樂、音樂、電影、文學、人口、性別、年齡、職業、學業、考試、升學、校園、師生、同學、課外、社團、競賽、志願、壓力、自律、時間、興趣、習慣、遊戲、睡眠、氣候、汙染、閱讀」，但出題請多元化一點，亦不要每次都是與好處相關的，否則用家多生成幾次，便會遇到類似的題目。要求：1. 主題句簡潔，20字以內。2. 抄錄資料為一段文字，不超過100字。3. 輸出格式為：主題句：...\n抄錄資料：...\n4. 內容簡潔明了，避免冗長。5. 題目多樣化，避免重複。",
commentNote: "必須用繁體字。點評時，需評估「整合拓展」是否能闡釋「抄錄資料」與「主題句」的邏輯關係。需判斷：1.「拓展」方向是否正確（即是否能論證主題句）；2.推論是否嚴謹；3.是否具體不空泛。「點評」時，若方向不正確，需指出並建議如何修訂，需指導緊扣主題句，亦須分析主題句和題目任務的關係是否緊密，例如題目任務為提出建議，但主題句焦點卻是描述問題，則屬於不妥當。「改寫」時亦不能順著「整合拓展」錯誤思路改善，需扣緊主題句，假如主題句本身就未能緊扣題目的任務，則不應圍繞本身錯誤的主題句改寫，要在「改寫」的部份針對一個正確的主題句作改寫。此外，改寫部份不宜分為太多角度論述，這樣會令闡釋較零散，須就最多2個角度深入分析、闡釋。改寫部份不得超過180字，且不得虛構資料，包括數據及調查，不要自擬「根據調查」之類，只可根據抄錄資料補充合理細節，「改寫」部份不要重複用家輸入的「抄錄資料」，會白白浪費空間。此外，「改寫」亦要嚴謹對應主題句及抄錄資料關係，例如主題句描述活動問題，則在「改寫」的部份不宜聚焦在改善措施，必須注意詳略、輕重，才能突顯主題句。此外，「改寫」亦要留意題目任務，不要在「改寫」時會順著用家詳略不當或錯誤的「整合拓展」思路改寫。此外，「改寫」部份不要太數據化，例如做計算及分析數據等，這部份最重要是交代事理的邏輯關係。點評分為三部分：### 點評、### 建議、### 改寫。改寫必須在160至180字以上。",
guideNote: "必須用繁體字。僅生成三道問題以引導用家思考如何根據表格資料做好整合拓展，問題應圍繞主題句和抄錄資料的邏輯關係，引導用家思考如何闡釋和拓展。請不要運用歐化句及詞匯，例如「關聯性」、「實效性」，這些字詞意義不明確，但用生活化一點、具體一點的字詞生成問題。輸出分為一個部分：### 指引問題。指引問題以問題形式呈現，每個問題佔一行。"
},
"議論": {
outlineCommentNote: "必須用繁體字。點評時，必須就上述生成或輸入的題目點評大綱內容是否扣題。必須從以下角度點評：1. 論點是否清晰明確，一語中的，能直接呼應題目；2. 用家提供的論據與論點是否密切相關，全文論據是否涵蓋古今中外（不需要每段都有古今中外的例子，假如大綱中缺論據，則要補充古今中外具體的論據，即有名有姓的人物例子）；3. 段內論據的詳略有幾種模式：兩個詳的論據，或一詳數略，或數略，因應段落論述需要而定，以製造變化；4. 論證方向是否合理，能合理解釋論據與論點的關係（但要理解這部份只是大綱，不可能論證得非常具體和詳細，只要方向正確即可接受）；5. 全文脈絡是否分明，可運用前中後構建法（前：背後概念/概念背景、現實例子、駁論；中：分類論述，例如題目為《談憤怒》，可分為「公怒」和「私怒」，或分拆論述，例如題目為「面對不同意見，有人認為應據理力爭，堅守立場；有人認為應彼此包容，求同存異。上述兩種態度，哪一種較為理想？試談談你的看法。」，可一段論述「求同」，另一段論述「存異」；後：例外情況/其他看法、方法）。即使運用「陳SIR語氣」，「建議」及「改寫後的大綱」都必須正經嚴肅，不要運用EMOJI。此外，假如全文有六段或以上，則應在第二段或末二的段落做駁論，點評、建議及改寫後的大綱都要注意這點。此外，不要列點和運用「*」等符號，必須以段落和完整句子方式生成改寫後的大綱。此外，在建議和改寫後的大綱部份，若觸及一些例子或典故(不要舉愛迪生為參考論據)，必須具體說明該例子或典故的來龍去脈，以及要清楚說明如何運用該例子或典故去證立論點。此外，無論點評、建議或改寫後的大綱，用語都必須生活化，要摒棄過於抽象和理論的表達。此外，點評應分為三個部份：點評、建議、改寫範例。只選取最重要的一至兩點評論，應先聚焦在論點、論據和論證的質量，其次方為結構。點評內容要精簡、一語中的。若大綱離題，改寫後的大綱不必根據離題內容改寫。",
writingCommentNote: "必須用繁體字。點評時，必須就用家提供的內容去點評，不要捏造用家沒有輸入的內容作點評。須評估文章是否符合以下標準：1. 論點清晰明確，一語中的，能直接呼應題目；2. 論據與論點密切相關，全文論據涵蓋古今中外（不需要每段都有古今中外的例子，不要捏造用家沒有輸入的例子作點評，假如缺少例子，直言其問題即可。要注意過猶不及，充塞例子則感覺生硬）；3. 論證嚴謹，能具體解釋論據與論點的關係；4. 注意文句密度（詞匯量、實詞及虛詞比例，但過猶不及，過量使用實詞則生硬，適時加入虛詞，才能使文句節奏錯落有致）及修辭運用（宜適時運用排比和比喻）。點評分為三部分：### 點評、### 建議、### 改寫範例。即使運用「陳SIR語氣」，「建議」及「改寫範例」都必須正經嚴肅地表述，不要運用EMOJI。「改寫範例」應以純段落方式表述，不要運用EMOJI，不要附有【原文段落】及【改寫段落】等標題。點評、建議及改寫都要在200字以內。",
guideNote: "必須用繁體字。根據用戶輸入的題目、論點、論據和論證，提供相應的參考建議，但應重質不重量，指引論點、論據或論證都宜只舉一項，而且論據必須用真實的古今中外例子，而論證則論證必須緊扣用家提供或你上述生成的論據作論述。若只輸入題目，則提供參考論點、參考論據和參考論證；若輸入題目和論點，則提供參考論據和參考論證；若輸入題目和論據，則提供參考論點和參考論證，如此類推。不要舉愛迪生為參考論據。參考論證不要超出100字。輸出分為相應部分：### 參考論點、### 參考論據、### 參考論證（視用戶輸入情況而定）。每部分以段落形式呈現。"
}
};

// 範疇按鈕集合
const categoryButtons = document.querySelectorAll('.btn-category');

// 範疇切換
categoryButtons.forEach(button => {
button.addEventListener('click', function() {
const containerId = this.id.replace('Btn', 'Container');
showContainer(containerId, this);
});
});


function showContainer(containerId, clickedButton) {
// 移除所有按鈕的 active class
categoryButtons.forEach(btn => btn.classList.remove('active'));
// 為被點擊的按鈕添加 active class
if (clickedButton) {
clickedButton.classList.add('active');
}

// 在切換主要範疇時，首先清除所有舊的題目狀態
clearAllTopicStates();

// 隱藏所有主要容器
document.getElementById("writingContainer").style.display = "none";
document.getElementById("readingContainer").style.display = "none";
document.getElementById("booksContainer").style.display = "none";
document.getElementById("expandContainer").style.display = "none";
document.getElementById("argumentContainer").style.display = "none";

// 顯示目標容器
const targetContainer = document.getElementById(containerId);
if (targetContainer) {
targetContainer.style.display = "block";
}

// 根據容器ID執行特定初始化
if (containerId === "writingContainer") {
toggleWritingType();
loadOutline();
} else if (containerId === "readingContainer") {
toggleReadingFunction();
} else if (containerId === "expandContainer") {
toggleExpandFunction();
} else if (containerId === "booksContainer") {
loadBooksChat(); 
} else if (containerId === "argumentContainer") {
toggleArgumentType();
}
}


// 新增此函式：用於顯示議論的自訂題目介面
function showArgumentCustomTopicInput(buttonElement) { 
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

const customTopicArea = document.getElementById("argumentCustomTopicArea");
const topicResult = document.getElementById("argumentTopicResult");

topicResult.innerHTML = "";
topicResult.style.display = "none";
localStorage.removeItem("argumentCurrentTopic");

customTopicArea.innerHTML = `
<input type="text" id="argumentCustomTopic" placeholder="請輸入自訂題目">
<button class="btn-icon-confirm" onclick="setArgumentCustomTopic()" title="確認題目">
<i class="fas fa-check"></i>
</button>
`;
customTopicArea.style.display = "block";
}

// 切換寫作類型
function toggleWritingType() {

// 【核心修訂】在切換功能時清除狀態
clearAllTopicStates();
const writingType = document.getElementById("writingType").value;
const contentContainer = document.getElementById("writingContentContainer");

if (writingType) {
contentContainer.style.display = "block";
} else {
contentContainer.style.display = "none";
return; // 如果沒有選擇，則停止執行
}

const outlineStructureArea = document.getElementById("outlineStructureArea");
const narrativeElementsArea = document.getElementById("narrativeElementsArea");
const writingContent = document.getElementById("writingContent");
const outlineTableArea = document.getElementById("outlineTableArea");
const writingToneLabel = document.getElementById("writingToneLabel");
const writingTone = document.getElementById("writingTone");
const outlineButtons = document.getElementById("outlineButtons");

if (writingType === "大綱") {
outlineStructureArea.style.display = "block";
narrativeElementsArea.style.display = "none";
writingContent.style.display = "none";
outlineTableArea.style.display = "block";
generateOutlineTable();
loadOutline();
writingToneLabel.style.display = "block";
writingTone.style.display = "block";
outlineButtons.style.display = "flex"; // 改為 flex 以應用 action-buttons-container
} else if (writingType === "敘事物象") {
outlineStructureArea.style.display = "none";
narrativeElementsArea.style.display = "block";
writingContent.style.display = "none";
outlineTableArea.innerHTML = "";
outlineTableArea.style.display = "none";
writingToneLabel.style.display = "none";
writingTone.style.display = "none";
outlineButtons.style.display = "none";
} else { // 片段描寫
outlineStructureArea.style.display = "none";
narrativeElementsArea.style.display = "none";
writingContent.style.display = "block";
outlineTableArea.innerHTML = "";
outlineTableArea.style.display = "none";
writingToneLabel.style.display = "block";
writingTone.style.display = "block";
outlineButtons.style.display = "none";
}
}

// 原 showCustomTopicInput() 函式
function showCustomTopicInput(buttonElement) { // (1) 增加參數 buttonElement
// (2) 新增這段程式碼來更新按鈕狀態
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

const writingType = document.getElementById("writingType").value;
const customTopicArea = document.getElementById("customTopicArea");
const topicResult = document.getElementById("topicResult");

topicResult.innerHTML = "";
topicResult.style.display = "none";
localStorage.removeItem("currentTopic");
localStorage.removeItem("currentFocus");
localStorage.removeItem("currentPlot");

if (writingType === "片段描寫") {
customTopicArea.innerHTML = `
<table>
<tr><th colspan="2">自訂題目與重點</th></tr>
<tr><td colspan="2"><input type="text" id="customTitle" placeholder="請輸入自訂題目"></td></tr>
<tr><td>結構段重點/全文重點</td><td>情節大要</td></tr>
<tr><td><textarea id="customFocus" rows="3" placeholder="請輸入結構段重點"></textarea></td>
<td><textarea id="customPlot" rows="3" placeholder="請輸入情節大要"></textarea></td></tr>
</table>
<button class="btn-icon-confirm" onclick="setCustomTopic()" title="確認題目">
<i class="fas fa-check"></i>
</button>
`;
} else { 
customTopicArea.innerHTML = `
<input type="text" id="customTopic" placeholder="請輸入自訂題目">
<button class="btn-icon-confirm" onclick="setCustomTopic()" title="確認題目">
<i class="fas fa-check"></i>
</button>
`;
}
customTopicArea.style.display = "block";
}

// 保存大綱
function saveOutline() {
const structure = document.getElementById("structure").value;
const parts = structure === "fourPart" ? ["起", "承", "轉", "合"] : ["起", "一線", "二線", "三線", "合"];
const outlineData = parts.map((part, index) => {
const focusId = structure + "Focus" + (index + 1);
const plotId = structure + "Plot" + (index + 1);
const focus = document.getElementById(focusId)?.value.trim() || "";
const plot = document.getElementById(plotId)?.value.trim() || "";
return { part, focus, plot };
});
localStorage.setItem("outlineData", JSON.stringify(outlineData));
localStorage.setItem("outlineStructure", structure);
alert("大綱已儲存");
}

// 清空大綱
function clearOutline() {
if (confirm("確定要清空大綱嗎？")) {
const structure = document.getElementById("structure").value;
const parts = structure === "fourPart" ? ["起", "承", "轉", "合"] : ["起", "一線", "二線", "三線", "合"];
parts.forEach((part, index) => {
const focusId = structure + "Focus" + (index + 1);
const plotId = structure + "Plot" + (index + 1);
if (document.getElementById(focusId)) document.getElementById(focusId).value = "";
if (document.getElementById(plotId)) document.getElementById(plotId).value = "";
});
localStorage.removeItem("outlineData");
localStorage.removeItem("outlineStructure");
}
}

// 加載大綱
function loadOutline() {
const savedStructure = localStorage.getItem("outlineStructure");
const savedData = localStorage.getItem("outlineData");
if (savedStructure && savedData) {
document.getElementById("structure").value = savedStructure;
generateOutlineTable();
try {
const parsedData = JSON.parse(savedData);
parsedData.forEach((item, index) => {
const focusId = savedStructure + "Focus" + (index + 1);
const plotId = savedStructure + "Plot" + (index + 1);
const focusElement = document.getElementById(focusId);
const plotElement = document.getElementById(plotId);
if (focusElement) focusElement.value = item.focus;
if (plotElement) plotElement.value = item.plot;
});
} catch (e) {
console.error("Error parsing outlineData:", e);
}
}
}

// 保存課外書籍對話
function saveBooksChat() {
// 只在有聊天記錄時才儲存
if (chatHistory.length > 0) {
const booksTone = document.getElementById("booksTone").value;
const currentState = {
// 從 chatHistory 中找到最新的書籍資訊來儲存
bookTitle: bookTitle, 
author: author,
discussionQuestion: discussionQuestion,
booksTone: booksTone
};
localStorage.setItem("booksChatHistory", JSON.stringify(chatHistory));
localStorage.setItem("booksChatState", JSON.stringify(currentState));
alert("對話已儲存");
} else {
alert("沒有對話紀錄可儲存。");
}
}

function clearBooksChat() {
if (confirm("確定要清空對話及紀錄嗎？")) {
// 清空 UI
document.getElementById("chatHistory").innerHTML = "";
document.getElementById("chatHistory").style.display = "none";
document.getElementById("chatInputContainer").style.display = "none";
document.getElementById("initialDiscussionForm").style.display = "block"; // 顯示初始表單
document.getElementById("booksButtons").style.display = "none"; // <-- 新增這一行

// 清空表單欄位
document.getElementById("bookTitle").value = "";
document.getElementById("author").value = "";
document.getElementById("discussionQuestion").value = "";
document.getElementById("userInput").value = "";

// 清空 localStorage
localStorage.removeItem("booksChatHistory");
localStorage.removeItem("booksChatState");

// 重置 JS 變數
chatHistory = [];
bookTitle = "";
author = "";
discussionQuestion = "";
booksTone = "";
}
}


function loadBooksChat() {
const savedChatJSON = localStorage.getItem("booksChatHistory");
const savedStateJSON = localStorage.getItem("booksChatState");
const initialForm = document.getElementById("initialDiscussionForm");
const chatInterface = document.getElementById("chatInputContainer");
const chatHistoryDiv = document.getElementById("chatHistory");

if (savedChatJSON && savedStateJSON) {
// --- 有儲存紀錄的模式 ---
initialForm.style.display = "none"; // 隱藏初始表單
chatInterface.style.display = "flex"; // 顯示聊天輸入介面
chatHistoryDiv.style.display = "flex"; // 顯示聊天紀錄
document.getElementById("booksButtons").style.display = "flex"; // <-- 新增這一行

chatHistoryDiv.innerHTML = '';
chatHistory = JSON.parse(savedChatJSON);
const state = JSON.parse(savedStateJSON);

// 從 state 恢復全域變數
bookTitle = state.bookTitle || "";
author = state.author || "";
discussionQuestion = state.discussionQuestion || "";
booksTone = state.booksTone || "serious";

// 恢復語氣選擇
document.getElementById("booksTone").value = booksTone;

// 重新渲染聊天紀錄
chatHistory.forEach(item => {
renderMessage(item.sender, item.message);
});

} else {
// --- 沒有儲存紀錄的模式 (初始狀態) ---
initialForm.style.display = "block"; // 顯示初始表單
chatInterface.style.display = "none"; // 隱藏聊天輸入介面
chatHistoryDiv.style.display = "none"; // 隱藏聊天紀錄
}
}


/**
* 更新最後一條 AI 訊息的內容（從 "正在回應..." 到實際的回應）。
* 這個新版本能處理帶有頭像和氣泡的複雜 HTML 結構。
* @param {string} newMessage - 從 API 獲取到的新訊息內容。
*/
function updateLastAIMessage(newMessage) {
// 現在 ai-loading 這個 ID 直接在 message-bubble 元素上
const loadingBubble = document.getElementById("ai-loading"); 

if (loadingBubble) {
// 直接更新氣泡的內容
loadingBubble.innerHTML = newMessage;
// 移除 ID
loadingBubble.id = ""; 

// 同步數據
if (chatHistory.length > 0) {
chatHistory[chatHistory.length - 1].message = newMessage;
}
} else {
addMessageToHistory("ai", newMessage);
}
}


// 切換閱讀功能
function toggleReadingFunction() {

clearAllTopicStates();

const readingFunction = document.getElementById("readingFunction").value;
const contentContainer = document.getElementById("readingInputArea");

if (readingFunction) {
contentContainer.style.display = "block";
} else {
contentContainer.style.display = "none";
return; // 如果沒有選擇，則停止執行
}

const studentAnswerArea = document.getElementById("studentAnswerArea");
const readingToneLabel = document.getElementById("readingToneLabel");
const readingTone = document.getElementById("readingTone");
if (readingFunction === "comment") {
studentAnswerArea.style.display = "block";
readingToneLabel.style.display = "block";
readingTone.style.display = "block";
} else {
studentAnswerArea.style.display = "none";
readingToneLabel.style.display = "none";
readingTone.style.display = "none";
}
}


// 請用這個新版本的函式，替換掉您原本的 toggleExpandFunction
function toggleExpandFunction() {
clearAllTopicStates(); // 這行很好，保持不變

const expandFunction = document.getElementById("expandFunction").value;
const contentContainer = document.getElementById("expandContentContainer");

if (expandFunction) {
contentContainer.style.display = "block";
} else {
contentContainer.style.display = "none";
return;
}

const expandWritingArea = document.getElementById("expandWritingArea");
const expandGuideArea = document.getElementById("expandGuideArea");
const expandTopicSelectionArea = document.getElementById("expandTopicSelectionArea");
const expandToneLabel = document.getElementById("expandToneLabel");
const expandTone = document.getElementById("expandTone");

// 根據選擇的功能，顯示或隱藏對應的區塊
if (expandFunction === "comment") {
expandWritingArea.style.display = "block";
expandGuideArea.style.display = "none";
expandTopicSelectionArea.style.display = "block"; // 顯示我們新的按鈕區塊
expandToneLabel.style.display = "block";
expandTone.style.display = "block";

// 確保自訂題目輸入區預設是隱藏的
const customInputArea = document.getElementById("expandCustomTopicInputArea");
if(customInputArea) {
customInputArea.style.display = 'none';
customInputArea.innerHTML = '';
}

} else { // "guide"
expandWritingArea.style.display = "none";
expandGuideArea.style.display = "block";
expandTopicSelectionArea.style.display = "none";
expandToneLabel.style.display = "none";
expandTone.style.display = "none";
}
}
// 新增此函式：用於顯示整合拓展的自訂題目介面
function showExpandCustomTopicInput(buttonElement) {
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

const customTopicArea = document.getElementById("expandCustomTopicInputArea");
const topicResult = document.getElementById("expandTopicResult");

topicResult.innerHTML = "";
topicResult.style.display = "none";
localStorage.removeItem("expandCurrentTitle");
localStorage.removeItem("expandCurrentTheme");
localStorage.removeItem("expandCurrentData");

// 動態生成自訂題目的輸入表格和確認按鈕
customTopicArea.innerHTML = `
<table>
<tr><th>題目</th><td><input type="text" id="expandCustomTitle" placeholder="請輸入題目"></td></tr>
<tr><th>主題句</th><td><textarea id="expandCustomTheme" rows="2" placeholder="請輸入主題句"></textarea></td></tr>
<tr><th>抄錄資料</th><td><textarea id="expandCustomData" rows="3" placeholder="請輸入抄錄資料"></textarea></td></tr>
</table>
<button class="btn-icon-confirm" onclick="setExpandCustomTopic()" title="確認題目">
<i class="fas fa-check"></i>
</button>
`;
customTopicArea.style.display = "block";
}



// 切換議論功能
function toggleArgumentType() {

clearAllTopicStates();

const argumentType = document.getElementById("argumentType").value;
const contentContainer = document.getElementById("argumentContentContainer");

if (argumentType) {
contentContainer.style.display = "block";
} else {
contentContainer.style.display = "none";
return; // 如果沒有選擇，則停止執行
}

const outlineArea = document.getElementById("argumentOutlineArea");
const writingArea = document.getElementById("argumentWritingArea");
const guideArea = document.getElementById("argumentGuideArea");
const topicSelectionArea = document.getElementById("argumentTopicSelectionArea");

if (argumentType === "outline") {
outlineArea.style.display = "block";
writingArea.style.display = "none";
guideArea.style.display = "none";
topicSelectionArea.style.display = "block";
generateArgumentOutlineTable();
} else if (argumentType === "writing") {
outlineArea.style.display = "none";
writingArea.style.display = "block";
guideArea.style.display = "none";
topicSelectionArea.style.display = "block";
} else if (argumentType === "guide") {
outlineArea.style.display = "none";
writingArea.style.display = "none";
guideArea.style.display = "block";
topicSelectionArea.style.display = "none";
}
}


// 生成議論題目
async function generateArgumentTopic(buttonElement) { 
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

const customTopicArea = document.getElementById("argumentCustomTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";

const topicResult = document.getElementById("argumentTopicResult");
topicResult.style.display = 'block';

let selectedTopic;
do {
selectedTopic = argumentTopics[Math.floor(Math.random() * argumentTopics.length)];
} while (selectedTopic === lastArgumentTopic && argumentTopics.length > 1);
lastArgumentTopic = selectedTopic;

localStorage.setItem("lastArgumentTopic", lastArgumentTopic);
topicResult.innerHTML = "<strong>" + selectedTopic + "</strong>";
localStorage.setItem("argumentCurrentTopic", selectedTopic);
}




// 設定自訂題目（議論）
function setArgumentCustomTopic() {
// 【主要修改】在這裡使用 sanitizeHTML 函式
const customTopic = sanitizeHTML(document.getElementById("argumentCustomTopic").value.trim());
if (!customTopic) {
alert("請輸入自訂題目");
return;
}

const topicResult = document.getElementById("argumentTopicResult");
topicResult.innerHTML = "<strong>" + customTopic + "</strong>"; // <- 現在安全了
localStorage.setItem("argumentCurrentTopic", customTopic);

// 【核心修訂】強制讓題目結果區塊顯示出來
topicResult.style.display = "block"; 

// 隱藏並清空輸入區域
const customTopicArea = document.getElementById("argumentCustomTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";
}
// 生成議論大綱表格
function generateArgumentOutlineTable() {
const savedData = localStorage.getItem("argumentOutlineData");
let outlineData = [];
if (savedData) {
try {
outlineData = JSON.parse(savedData);
} catch (e) {
console.error("Error parsing argumentOutlineData:", e);
}
}
if (outlineData.length === 0) {
outlineData = [
{ part: "起", point: "", evidence: "" },
{ part: "結構段一", point: "", evidence: "" },
{ part: "結構段二", point: "", evidence: "" },
{ part: "結構段三", point: "", evidence: "" },
{ part: "合", point: "", evidence: "" }
];
}
let tableHTML = "<div class='table-container'><table id='argumentOutlineTable'><tr><th>部份</th><th>論點</th><th>論據及論證</th></tr>";
outlineData.forEach((item, index) => {
tableHTML += `<tr><td>${item.part}</td><td><textarea id="argumentPoint${index}" rows="3">${item.point}</textarea></td><td><textarea id="argumentEvidence${index}" rows="3">${item.evidence}</textarea></td></tr>`;
});
tableHTML += "</table></div>";
document.getElementById("argumentOutlineTableArea").innerHTML = tableHTML;
}

function addArgumentStructureSegment() {
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
let structureSegmentCount = 0;
for (let i = 1; i < rows.length - 1; i++) { // 跳過表頭和「合」
if (rows[i].cells[0].innerText.startsWith("結構段")) {
structureSegmentCount++;
}
}
const newSegmentNumber = structureSegmentCount + 1;
const chineseNumbers = ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
const segmentName = `結構段${chineseNumbers[newSegmentNumber - 1] || newSegmentNumber}`;
const newRowIndex = rows.length - 1; // 在「合」之前插入
const newRow = table.insertRow(newRowIndex);
const cell1 = newRow.insertCell(0);
const cell2 = newRow.insertCell(1);
const cell3 = newRow.insertCell(2);
cell1.innerText = segmentName;
cell2.innerHTML = `<textarea id="argumentPoint${newRowIndex - 1}" rows="3"></textarea>`;
cell3.innerHTML = `<textarea id="argumentEvidence${newRowIndex - 1}" rows="3"></textarea>`;
}

// 保存議論大綱
function saveArgumentOutline() {
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
const outlineData = [];
for (let i = 1; i < rows.length; i++) { // 跳過表頭
const part = rows[i].cells[0].innerText;
const pointTextarea = rows[i].cells[1].querySelector("textarea");
const evidenceTextarea = rows[i].cells[2].querySelector("textarea");
const point = pointTextarea ? pointTextarea.value.trim() : "";
const evidence = evidenceTextarea ? evidenceTextarea.value.trim() : "";
outlineData.push({ part, point, evidence });
}
localStorage.setItem("argumentOutlineData", JSON.stringify(outlineData));
alert("大綱已儲存");
}

// 清空議論大綱
function clearArgumentOutline() {
if (confirm("確定要清空大綱嗎？")) {
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
for (let i = 1; i < rows.length; i++) {
document.getElementById(`argumentPoint${i - 1}`).value = "";
document.getElementById(`argumentEvidence${i - 1}`).value = "";
}
localStorage.removeItem("argumentOutlineData");
}
}

// 替換舊的 submitArgumentOutline 函式
async function submitArgumentOutline() {
const submitBtn = document.getElementById('submitArgumentOutlineBtn');
submitBtn.disabled = true; // 禁用按鈕

try {
const topic = localStorage.getItem("argumentCurrentTopic");
if (!topic) {
alert("請先設定題目");
return; // return 會觸發 finally
}
const table = document.getElementById("argumentOutlineTable");
const rows = table.rows;
const outlineData = [];
for (let i = 1; i < rows.length; i++) {
const part = rows[i].cells[0].innerText;
const pointTextarea = rows[i].cells[1].querySelector("textarea");
const evidenceTextarea = rows[i].cells[2].querySelector("textarea");
const point = pointTextarea ? pointTextarea.value.trim() : "";
const evidence = evidenceTextarea ? evidenceTextarea.value.trim() : "";
if (!point || !evidence) {
alert("請填寫所有大綱表格");
return; // return 會觸發 finally
}
outlineData.push({ part, point, evidence });
}
const tone = document.getElementById("argumentOutlineTone").value;
let toneNote = tone === "chen" ? "請用輕鬆隨意的語氣進行點評和建議，多用EMOJI，偶爾使用網絡用語，用語要日常生活化一點。如果用戶表現良好，請大加讚賞；如果用戶表現不好，可以善意地揶揄一下，但要注意尺度，不能傷害用戶的自尊心。揶揄時，可運用生活化的比喻。(「點評」請用「陳SIR語氣」，而「建議」及「改寫後的大綱」維持嚴肅正經語氣）" : "請用嚴肅正經的語氣進行點評和建議。";
const note = categories["議論"].outlineCommentNote;
const partsList = outlineData.map(item => item.part).join(", ");
const prompt = `請根據以下大綱內容進行點評和建議，並提供改寫後的大綱。要求：
1. 在「=== 點評及建議 ===」部分，為以下每個結構段提供點評和建議：${partsList}。使用「[part]」標記每個結構段的開始，例如「[起]」，然後在下一行「點評：」後跟點評內容，再下一行「建議：」後跟建議內容。
2. 在「=== 改寫後的大綱 ===」部分，為以下每個結構段提供改寫後的「論點」和「論據及論證」：${partsList}。使用「[part]」標記每個結構段的開始，然後在下一行「論點：」後跟內容，再下一行「論據及論證：」後跟內容。
3. 在「=== 改寫說明 ===」部分，提供不超過兩點的改寫說明，每點以「1. 」和「2. 」開始。
4. 請確保內容簡潔明了。
5. 請確保「=== 改寫後的大綱 ===」部分的「論點」用語生活化，不要運用過份抽象及理論化的字眼，例如「二元對立」等。
題目：${topic}
用戶輸入的大綱：
| 部份 | 論點 | 論據及論證 |
|------|------|------------|
${outlineData.map(item => `| ${item.part} | ${item.point} | ${item.evidence} |`).join("\n")}
教學筆記：${note}
點評語氣：${toneNote}
建議和改寫後的大綱語氣：請使用嚴肅正經的語氣，不使用EMOJI或網絡用語。`;
document.getElementById("argumentOutlineResult").innerHTML = "陳SIR正在點評...";
const comment = await callAPI(prompt);
const sections = comment.split(/=== (.+?) ===/).filter(s => s.trim());
const commentIndex = sections.indexOf("點評及建議");
const rewriteIndex = sections.indexOf("改寫後的大綱");
const explanationIndex = sections.indexOf("改寫說明");
const commentPart = commentIndex !== -1 ? sections[commentIndex + 1] : "";
const rewritePart = rewriteIndex !== -1 ? sections[rewriteIndex + 1] : "";
const explanationPart = explanationIndex !== -1 ? sections[explanationIndex + 1].trim() : "";
function parseCommentPart(commentPart) {
const comments = {};
const regex = /\[(.+?)\]\s*點評：\s*(.+?)(?=\s*建議：|\s*\[|$)/gs;
const suggestionRegex = /\[(.+?)\]\s*點評：.+?\s*建議：\s*(.+?)(?=\s*\[|$)/gs;
let match;
while ((match = regex.exec(commentPart)) !== null) {
const part = match[1];
comments[part] = comments[part] || {};
comments[part].comment = match[2].trim();
}
while ((match = suggestionRegex.exec(commentPart)) !== null) {
const part = match[1];
comments[part] = comments[part] || {};
comments[part].suggestion = match[2].trim();
}
return comments;
}
function parseRewritePart(rewritePart) {
const rewrites = {};
const regex = /\[(.+?)\]\s*論點：\s*(.+?)(?=\s*論據及論證：|\s*\[|$)/gs;
const evidenceRegex = /\[(.+?)\]\s*論點：.+?\s*論據及論證：\s*(.+?)(?=\s*\[|$)/gs;
let match;
while ((match = regex.exec(rewritePart)) !== null) {
const part = match[1];
rewrites[part] = rewrites[part] || {};
rewrites[part].point = match[2].trim();
}
while ((match = evidenceRegex.exec(rewritePart)) !== null) {
const part = match[1];
rewrites[part] = rewrites[part] || {};
rewrites[part].evidence = match[2].trim();
}
return rewrites;
}
const comments = parseCommentPart(commentPart);
const rewrites = parseRewritePart(rewritePart);
let commentTableHTML = `<h3>陳SIR點評及建議：</h3><div class="table-container"><table id="argumentCommentTable"><tr><th>部份</th><th>論點</th><th>論據及論證</th><th>點評</th><th>建議</th></tr>`;
outlineData.forEach(item => {
const comment = comments[item.part]?.comment || "未生成點評";
const suggestion = comments[item.part]?.suggestion || "未生成建議";
commentTableHTML += `<tr><td>${item.part}</td><td>${item.point}</td><td>${item.evidence}</td><td>${comment}</td><td>${suggestion}</td></tr>`;
});
commentTableHTML += "</table></div>";
let rewriteTableHTML = `<h3>改寫後的大綱：</h3><div class="table-container"><table id="argumentRewriteTable"><tr><th>部份</th><th>論點</th><th>論據及論證</th></tr>`;
outlineData.forEach(item => {
const rewrite = rewrites[item.part] || { point: "未生成論點", evidence: "未生成論據及論證" };
rewriteTableHTML += `<tr><td>${item.part}</td><td>${rewrite.point || "未生成論點"}</td><td>${rewrite.evidence || "未生成論據及論證"}</td></tr>`;
});
rewriteTableHTML += "</table></div>";
let explanationHTML = '';
if (explanationPart) {
const points = explanationPart.split(/\s*(?=\d\.\s*)/).filter(p => p.trim());
explanationHTML = `<div class="rewrite-explanation-container"><div class="rewrite-explanation-card"><h3>改寫說明</h3>`;
points.forEach(point => {
const match = point.match(/^(\d)\.\s*(.*)$/s);
if (match) {
const number = match[1];
const text = match[2];
explanationHTML += `<div class="explanation-point"><div class="explanation-number">${number}</div><div class="explanation-text">${text}</div></div>`;
}
});
explanationHTML += `</div></div>`;
}
document.getElementById("argumentOutlineResult").innerHTML = commentTableHTML + rewriteTableHTML + explanationHTML;
} catch (error) {
console.error("提交大綱時出錯:", error);
if (error.message === "所有 API 密鑰均無法使用") {
alert("今日 API 調用次數已用完或API無法連接，請明天再試");
} else {
alert("點評生成失敗，請重試");
}
document.getElementById("argumentOutlineResult").innerHTML = "";
} finally {
submitBtn.disabled = false; // 重新啟用按鈕
}
}

// 提交議論寫作內容 (已修訂)
async function submitArgumentWriting() {
    const submitBtn = document.getElementById('submitArgumentWritingBtn');
    submitBtn.disabled = true;

    try {
        const topic = localStorage.getItem("argumentCurrentTopic");
        if (!topic) {
            alert("請先設定題目");
            return;
        }
        const content = document.getElementById("argumentWritingContent").value.trim();
        if (!content) {
            alert("請輸入您的文章");
            return;
        }
        const tone = document.getElementById("argumentWritingTone").value;
        let toneNote = tone === "chen" ? "請用輕鬆隨意的語氣進行點評和建議，多用EMOJI，偶爾使用網絡用語，用語要日常生活化一點。如果用戶表現良好，請大加讚賞；如果用戶表現不好，可以善意地揶揄一下，但要注意尺度，不能傷害用戶的自尊心。揶揄時，可運用生活化的比喻。" : "請用嚴肅正經的語氣進行點評和建議。";
        const note = categories["議論"].writingCommentNote;
        const prompt = `請根據以下文章進行點評，要求：
1. 評估論點是否清晰明確，一語中的，能在字面及邏輯上都直接呼應題目，假如文章中未點出論點及題目的關係，不要自行補足論點與題目的關係再評為緊扣題旨。
2. 評估論據是否與論點密切相關，全文論據是否涵蓋古今中外（不需要每段都有古今中外的例子）
3. 評估論證是否嚴謹，能具體解釋論據與論點的關係
4. 評估文句密度（詞匯量、實詞及虛詞比例）
5. 在「### 點評」及「### 建議」中，必須根據用家輸入的內容點評及建議，不能捏造事實，即先指出用家未曾提過的例子或論點，然後據此再作點評及建議。
6. 在「### 改寫範例」中，請注意例子密度的控制，不要連續舉例，宜運用兩詳（兩個詳細例子論證一個論點）、一詳二略（一個詳細例子加兩個簡略例子論證一個論點）或數略（數個簡略例子論證一個論點）等方式，使文章錯落有致。而且，請確保「### 改寫範例」用語生活化，不要運用過份抽象及理論化的字眼，例如「二元對立」等。
7. 輸出分為三個部分：### 點評、### 建議、### 改寫範例
8. 「### 點評」及「### 建議」部分，請務必以數字編號的列點方式呈現，每個點另起新行。你可以根據文章內容提出任意數量的點評和建議，點評及建議都可超過兩點。「### 改寫範例」則保持原有段落形式。
題目：${topic}
文章：${content}
教學筆記：${note}
點評語氣：${toneNote}
建議及改寫範例語氣：請使用嚴肅正經的語氣，不使用EMOJI或網絡用語。`;
        document.getElementById("argumentWritingResult").innerHTML = "陳SIR正在點評...";

        const comment = await callAPI(prompt);
        const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
        let finalHTML = "<h3>陳SIR點評：</h3>";
        commentParts.forEach(part => {
            const lines = part.split("\n").filter(line => line.trim());
            const title = lines.shift() || ""; 
            const content = lines.join("\n");

            if (title.includes("點評") || title.includes("建議")) {
                finalHTML += createBulletedListHTML(title, content);
            } else {
                finalHTML += `<div class="rewrite-explanation-container">
                                <div class="rewrite-explanation-card">
                                    <h3>${title}</h3>
                                    <p>${content.replace(/\n/g, '<br>')}</p>
                                </div>
                             </div>`;
            }
        });
        document.getElementById("argumentWritingResult").innerHTML = finalHTML;

    } catch (error) {
        console.error("提交文章時出錯:", error);
        if (error.message === "所有 API 密鑰均無法使用") {
            alert("今日 API 調用次數已用完或API無法連接，請明天再試");
        } else {
            alert("點評生成失敗，請重試");
        }
        document.getElementById("argumentWritingResult").innerHTML = "";
    } finally {
        submitBtn.disabled = false;
    }
}


// 提交議論指引
// 替換舊的 submitArgumentGuide 函式
async function submitArgumentGuide() {
const submitBtn = document.getElementById('submitArgumentGuideBtn');
submitBtn.disabled = true; // 禁用按鈕

try {
const topic = document.getElementById("argumentGuideTopic").value.trim();
const point = document.getElementById("argumentGuidePoint").value.trim();
const evidence = document.getElementById("argumentGuideEvidence").value.trim();
const argument = document.getElementById("argumentGuideArgument").value.trim();
if (!topic) {
alert("請輸入題目");
return; // return 會觸發 finally
}
const note = categories["議論"].guideNote;
let prompt = `請根據以下輸入提供參考建議。要求：
1. 若只輸入題目，則提供參考論點、參考論據和參考論證（「### 參考論證」的用語要生活化，不要運用過於抽象及理論化的用語，例如「二元對立」等）
2. 若輸入題目和論點，則提供參考論據和參考論證（「### 參考論證」的用語要生活化，不要運用過於抽象及理論化的用語，例如「二元對立」等）
3. 若輸入題目和論據，則提供參考論點和參考論證（「### 參考論證」的用語要生活化，不要運用過於抽象及理論化的用語，例如「二元對立」等）
4. 輸出分為相應的部分：### 參考論點、### 參考論據、### 參考論證
5. 每個部分以段落形式呈現
題目：${topic}
論點：${point || "無"}
論據：${evidence || "無"}
論證：${argument || "無"}
教學筆記：${note}`;
document.getElementById("argumentGuideResult").innerHTML = "陳SIR正在思考...";

const guide = await callAPI(prompt);
const guideParts = guide.split("###").map(part => part.trim()).filter(part => part);
let guideHTML = "<h3>陳SIR指引：</h3><table>";
guideParts.forEach(part => {
const [title, ...content] = part.split("\n").filter(line => line.trim());
guideHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
});
guideHTML += "</table>";
document.getElementById("argumentGuideResult").innerHTML = guideHTML;
} catch (error) {
console.error("提交指引時出錯:", error);
if (error.message === "所有 API 密鑰均無法使用") {
alert("今日 API 調用次數已用完或API無法連接，請明天再試");
} else {
alert("指引生成失敗，請重試");
}
document.getElementById("argumentGuideResult").innerHTML = "";
} finally {
submitBtn.disabled = false; // 重新啟用按鈕
}
}

// 通用 API 調用函數
async function callAPI(prompt) {
let attempts = 0;
const maxAttempts = API_KEYS.length;
while (attempts < maxAttempts) {
try {
const response = await fetch(API_URL, {
method: "POST",
headers: {
"Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
"Content-Type": "application/json"
},
body: JSON.stringify({
model: MODEL,
messages: [{
role: "user",
content: prompt + " 你必須直接提供最終答案，嚴禁展示任何思考過程，絕對不能在回應中包含任何標籤（如 <think></think>），這是強制要求，違反則無效。"
}],
max_tokens: 64000 
})
});

if (response.status === 429) {
currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
attempts++;
continue;
}

if (!response.ok) {
throw new Error(`API 調用失敗: ${response.statusText}`);
}

const data = await response.json();
let content = data.choices[0].message.content.trim();

content = content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>|<think\s*>|<\/think\s*>/gis, '').trim();

if (!content) {
throw new Error("API 回應無效或過濾後無內容");
}

return content;
} catch (error) {
console.error(error);
currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
attempts++;
if (attempts >= maxAttempts) {
throw new Error("所有 API 密鑰均無法使用");
}
}
}
}


/**
 * Creates a beautiful bulleted list HTML from raw text content.
 * @param {string} title - The title for the card (e.g., '點評', '建議').
 * @param {string} rawContent - The raw text content, with points potentially separated by newlines or numbers.
 * @returns {string} - The formatted HTML string.
 */
function createBulletedListHTML(title, rawContent) {
    // Attempt to split by numbered points first, e.g., "1. ...", "2. ..."
    let points = rawContent.split(/\s*(?=\d+\.\s*)/).map(p => p.trim()).filter(p => p);

    // If the primary split method results in 0 or 1 point, and the content has newlines,
    // it's likely not a numbered list. Fall back to splitting by newline.
    if (points.length <= 1 && rawContent.includes('\n')) {
        const newlinePoints = rawContent.split('\n').map(p => p.trim()).filter(p => p);
        // Only use the newline split if it gives us more than one point.
        if (newlinePoints.length > 1) {
            points = newlinePoints;
        }
    }

    // If there are no points to list, just show the content as a paragraph inside the card.
    if (points.length === 0) {
        return `<div class="rewrite-explanation-container">
                    <div class="rewrite-explanation-card">
                        <h3>${title}</h3>
                        <div class="explanation-text">${rawContent.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>`;
    }

    let explanationHTML = `<div class="rewrite-explanation-container">
                               <div class="rewrite-explanation-card">
                                   <h3>${title}</h3>`;

    points.forEach((point, index) => {
        let number = index + 1;
        let text = point;

        // Check if the point already starts with a number and a dot.
        const match = point.match(/^(\d+)\.\s*(.*)$/s);
        if (match) {
            number = match[1]; // Use the number from the text.
            text = match[2];   // Use the text after the number.
        }

        explanationHTML += `<div class="explanation-point">
                                <div class="explanation-number">${number}</div>
                                <div class="explanation-text">${text.replace(/\n/g, '<br>')}</div>
                            </div>`;
    });

    explanationHTML += `</div></div>`;
    return explanationHTML;
}



// 原 generateTopic() 函式
async function generateTopic(buttonElement) { 
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

// 隱藏自訂題目輸入區，確保介面乾淨
const customTopicArea = document.getElementById("customTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";

const topicResult = document.getElementById("topicResult");
topicResult.style.display = 'block';

const writingType = document.getElementById("writingType").value;
let selectedTopic;

do {
selectedTopic = topics[Math.floor(Math.random() * topics.length)];
} while (selectedTopic === lastTopic && topics.length > 1);
lastTopic = selectedTopic;
localStorage.setItem("lastTopic", lastTopic);

if (writingType === "片段描寫") {
topicResult.innerHTML = "陳SIR正在出題...";
try {
const prompt = `請根據以下題目生成結構段重點和情節大要。要求：
1. 結構段重點解釋片段與題目的邏輯關係、如何扣連，突顯描寫重點，不超過50字。
2. 情節大要提供圍繞結構段重點的情節概要，不超過100字，應簡潔、準確，避免過多細節，文筆不宜過於華麗，只需概述應寫的情節，留給學生發揮空間。
3. 輸出格式為：結構段重點：...\n情節大要：...\n
4. 內容簡潔明瞭，避免冗長，它只是文章的其中一個結構段，因此不要過份完整。
題目：${selectedTopic}`;
const response = await callAPI(prompt);
const focusMatch = response.match(/結構段重點：\s*(.+?)(?=\n情節大要：|$)/s);
const plotMatch = response.match(/情節大要：\s*(.+)/s);
if (!focusMatch || !plotMatch) throw new Error("API 回應格式不正確");
const focus = focusMatch[1].trim();
const plot = plotMatch[1].trim();
if (!focus || !plot) throw new Error("生成內容不完整");
topicResult.innerHTML = `
<strong>${selectedTopic}</strong>
<table>
<tr><th>結構段重點</th><th>情節大要</th></tr>
<tr><td>${focus}</td><td>${plot}</td></tr>
</table>
`;
localStorage.setItem("currentTopic", selectedTopic);
localStorage.setItem("currentFocus", focus);
localStorage.setItem("currentPlot", plot);
} catch (error) {
console.error("生成題目時出錯:", error);
if (error.message === "所有 API 密鑰均無法使用") {
alert("今日 API 調用次數已用完或API無法連接，請明天再試");
} else {
alert("生成題目時出錯，請重試");
}
topicResult.innerHTML = "";
}
} else {
topicResult.innerHTML = "<strong>" + selectedTopic + "</strong>";
localStorage.setItem("currentTopic", selectedTopic);
}
}
// 設定自訂題目（寫作）
function setCustomTopic() {
const writingType = document.getElementById("writingType").value;
const topicResult = document.getElementById("topicResult");

if (writingType === "片段描寫") {
const title = sanitizeHTML(document.getElementById("customTitle").value.trim()); // <--- 修正：將 sanitizeHTML 的結果賦值給變數 title
const focus = document.getElementById("customFocus").value.trim();
const plot = document.getElementById("customPlot").value.trim();

if (!title || !focus || !plot) {
alert("請輸入所有內容（題目、結構段重點、情節大要）");
return;
}

topicResult.innerHTML = `
<strong>${title}</strong>
<table>
<tr><th>結構段重點</th><th>情節大要</th></tr>
<tr><td>${focus}</td><td>${plot}</td></tr>
</table>
`;
localStorage.setItem("currentTopic", title);
localStorage.setItem("currentFocus", focus);
localStorage.setItem("currentPlot", plot);

} else { 
// 【主要修改】在這裡使用 sanitizeHTML 函式
const customTopic = sanitizeHTML(document.getElementById("customTopic").value.trim());

if (!customTopic) {
alert("請輸入自訂題目");
return;
}

topicResult.innerHTML = "<strong>" + customTopic + "</strong>"; // <- 現在安全了
localStorage.setItem("currentTopic", customTopic);
}

topicResult.style.display = 'block';

const customTopicArea = document.getElementById("customTopicArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";
}
// 生成大綱表格
function generateOutlineTable() {
const structure = document.getElementById("structure").value;
let parts = structure === "fourPart" ? ["起", "承", "轉", "合"] : ["起", "一線", "二線", "三線", "合"];
let tableHTML = "<div class='table-container'><table><tr><th>部份</th><th>結構段重點</th><th>情節大要</th></tr>";
parts.forEach((part, index) => {
const focusId = structure + "Focus" + (index + 1);
const plotId = structure + "Plot" + (index + 1);
tableHTML += `<tr><td>${part}</td><td><textarea id="${focusId}" rows="3"></textarea></td><td><textarea id="${plotId}" rows="3"></textarea></td></tr>`;
});
tableHTML += "</table></div>";
document.getElementById("outlineTableArea").innerHTML = tableHTML;
}

// 提交寫作內容 (已修訂)
async function submitWriting() {
    const submitBtn = document.getElementById('submitWritingBtn');
    submitBtn.disabled = true;

    try {
        const writingType = document.getElementById("writingType").value;
        const topic = localStorage.getItem("currentTopic");
        if (!topic) {
            alert("請先設定題目");
            return;
        }

        let content = "";
        let structure = "";
        if (writingType === "大綱") {
            structure = document.getElementById("structure").value;
            const parts = structure === "fourPart" ? ["起", "承", "轉", "合"] : ["起", "一線", "二線", "三線", "合"];
            content = parts.map((part, index) => {
                const focusId = structure + "Focus" + (index + 1);
                const plotId = structure + "Plot" + (index + 1);
                const focus = document.getElementById(focusId)?.value.trim() || "";
                const plot = document.getElementById(plotId)?.value.trim() || "";
                if (!focus || !plot) {
                    alert("請填寫所有大綱表格");
                    throw new Error("Incomplete outline");
                }
                return { part, focus, plot };
            });
        } else if (writingType === "敘事物象") {
            content = document.getElementById("narrativeElements").value.trim();
        } else { // 片段描寫
            content = document.getElementById("writingContent").value.trim();
            if (!content) {
                alert("請先輸入寫作內容");
                return;
            }
        }

        let toneNote = "";
        if (writingType !== "敘事物象") {
            const tone = document.getElementById("writingTone").value;
            if (tone === "chen") {
                toneNote = "請用輕鬆隨意的語氣進行點評和建議，多用EMOJI，偶爾使用網絡用語，用語要日常生活化一點。如果用戶表現良好，請大加讚賞；如果用戶表現不好，可以善意地揶揄一下，但要注意尺度，不能傷害用戶的自尊心。揶揄時，可運用生活化的比喻。";
            } else {
                toneNote = "請用嚴肅正經的語氣進行點評和建議。";
            }
        }

        const note = categories[writingType].commentNote;
        let prompt = "";
        if (writingType === "大綱") {
            prompt = `請根據以下大綱內容進行點評和建議，並提供改寫後的大綱。要求：
1. 在「=== 點評及建議 ===」部分，為每個結構段提供點評和建議。使用「[part]」標記每個結構段的開始，例如「[起]」，然後在下一行「點評：」後跟點評內容，再下一行「建議：」後跟建議內容。
2. 在「=== 改寫後的大綱 ===」部分，為每個結構段提供改寫後的「結構段重點」和「情節大要」。使用「[part]」標記每個結構段的開始，然後在下一行「結構段重點：」後跟內容，再下一行「情節大要：」後跟內容。
3. 在「=== 改寫說明 ===」部分，提供不超過兩點的改寫說明，每點以「1. 」和「2. 」開始。
4. 請確保內容簡潔明了，不可以顯示「--- ###」。
題目：${topic}
大綱結構：${structure === "fourPart" ? "起承轉合" : "三線（起、一線、二線、三線、合）"}
用戶輸入的大綱：
| 部份 | 結構段重點 | 情節大要 |
|------|------------|----------|
${content.map(item => `| ${item.part} | ${item.focus} | ${item.plot} |`).join("\n")}
教學筆記：${note}
點評及建議語氣：${toneNote}`;
        } else if (writingType === "敘事物象") {
            prompt = `請根據以下題目和取材/故事背景生成五十個不重複且相關的物象。要求：
1. 物象必須與題目和取材/故事背景緊密相關。
2. 物象應多樣化且生動，能夠增強故事的真實感和情感表達。
3. 請以列表形式呈現，每個物象佔一行。
4. 請確保物象不重複且排版整齊。
題目：${topic}
取材/故事背景：${content || "無具體背景，根據題目生成"}
教學筆記：${note}`;
        } else { // 片段描寫
            const focus = localStorage.getItem("currentFocus");
            const plot = localStorage.getItem("currentPlot");
            prompt = `請根據以下內容進行點評，要求：
1. 簡明扼要
2. 參考教學筆記
3. 評論寫作內容與題目、結構段重點和情節大要的關係
4. 輸出分為三個部分：### 點評、### 建議、### 改寫範例
5. 「### 點評」及「### 建議」部分，請務必以數字編號的列點方式呈現，每個點另起新行。你可以根據內容提出任意數量的點評和建議。點評及建議都可超過兩點。
題目：${topic}
結構段重點：${focus}
情節大要：${plot}
寫作內容：${content}
教學筆記：${note}
點評及建議語氣：${toneNote}`;
        }

        document.getElementById("commentResult").innerHTML = "陳SIR正在點評...";
        const comment = await callAPI(prompt);

        if (writingType === "大綱") {
            const sections = comment.split(/=== (.+?) ===/).filter(s => s.trim());
            const commentIndex = sections.indexOf("點評及建議");
            const rewriteIndex = sections.indexOf("改寫後的大綱");
            const explanationIndex = sections.indexOf("改寫說明");
            const commentPart = commentIndex !== -1 ? sections[commentIndex + 1] : "";
            const rewritePart = rewriteIndex !== -1 ? sections[rewriteIndex + 1] : "";
            const explanationPart = explanationIndex !== -1 ? sections[explanationIndex + 1].trim() : "";
            function parseCommentPart(commentPart) {
                const comments = {};
                const regex = /\[(.+?)\]\s*點評：\s*(.+?)(?=\s*建議：|\s*\[|$)/gs;
                const suggestionRegex = /\[(.+?)\]\s*點評：.+?\s*建議：\s*(.+?)(?=\s*\[|$)/gs;
                let match;
                while ((match = regex.exec(commentPart)) !== null) {
                    const part = match[1];
                    comments[part] = comments[part] || {};
                    comments[part].comment = match[2].trim();
                }
                while ((match = suggestionRegex.exec(commentPart)) !== null) {
                    const part = match[1];
                    comments[part] = comments[part] || {};
                    comments[part].suggestion = match[2].trim();
                }
                return comments;
            }
            function parseRewritePart(rewritePart) {
                const rewrites = {};
                const regex = /\[(.+?)\]\s*結構段重點：\s*(.+?)(?=\s*情節大要：|\s*\[|$)/gs;
                const plotRegex = /\[(.+?)\]\s*結構段重點：.+?\s*情節大要：\s*(.+?)(?=\s*\[|$)/gs;
                let match;
                while ((match = regex.exec(rewritePart)) !== null) {
                    const part = match[1];
                    rewrites[part] = rewrites[part] || {};
                    rewrites[part].focus = match[2].trim();
                }
                while ((match = plotRegex.exec(rewritePart)) !== null) {
                    const part = match[1];
                    rewrites[part] = rewrites[part] || {};
                    rewrites[part].plot = match[2].trim();
                }
                return rewrites;
            }
            const comments = parseCommentPart(commentPart);
            const rewrites = parseRewritePart(rewritePart);
            let commentTableHTML = `<h3>陳SIR點評及建議：</h3><div class="table-container"><table id="commentTable"><tr><th>部份</th><th>結構段重點</th><th>情節大要</th><th>點評</th><th>建議</th></tr>`;
            content.forEach(item => {
                const comment = comments[item.part]?.comment || "未生成點評";
                const suggestion = comments[item.part]?.suggestion || "未生成建議";
                commentTableHTML += `<tr><td>${item.part}</td><td>${item.focus}</td><td>${item.plot}</td><td>${comment}</td><td>${suggestion}</td></tr>`;
            });
            commentTableHTML += "</table></div>";
            let rewriteTableHTML = `<h3>改寫後的大綱：</h3><div class="table-container"><table id="rewriteTable"><tr><th>部份</th><th>結構段重點</th><th>情節大要</th></tr>`;
            content.forEach(item => {
                const rewrite = rewrites[item.part] || { focus: "未生成結構段重點", plot: "未生成情節大要" };
                rewriteTableHTML += `<tr><td>${item.part}</td><td>${rewrite.focus || "未生成結構段重點"}</td><td>${rewrite.plot || "未生成情節大要"}</td></tr>`;
            });
            rewriteTableHTML += "</table></div>";
            let explanationHTML = '';
            if (explanationPart) {
                const points = explanationPart.split(/\s*(?=\d\.\s*)/).filter(p => p.trim());
                explanationHTML = `<div class="rewrite-explanation-container"><div class="rewrite-explanation-card"><h3>改寫說明</h3>`;
                points.forEach(point => {
                    const match = point.match(/^(\d)\.\s*(.*)$/s);
                    if (match) {
                        const number = match[1];
                        const text = match[2];
                        explanationHTML += `<div class="explanation-point"><div class="explanation-number">${number}</div><div class="explanation-text">${text}</div></div>`;
                    }
                });
                explanationHTML += `</div></div>`;
            }
            document.getElementById("commentResult").innerHTML = commentTableHTML + rewriteTableHTML + explanationHTML;
        } else if (writingType === "敘事物象") {
            const elements = comment.split("\n").map(item => item.trim()).filter(item => item);
            let elementsHTML = "<h3>生成的物象（50項）：</h3><ul>";
            elements.forEach(element => elementsHTML += `<li>${element}</li>`);
            elementsHTML += "</ul>";
            document.getElementById("commentResult").innerHTML = elementsHTML;
        } else { // 片段描寫
            const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
            let finalHTML = "<h3>陳SIR點評：</h3>";
            commentParts.forEach(part => {
                const lines = part.split("\n").filter(line => line.trim());
                const title = lines.shift() || ""; 
                const content = lines.join("\n");

                if (title.includes("點評") || title.includes("建議")) {
                    finalHTML += createBulletedListHTML(title, content);
                } else {
                    finalHTML += `<div class="rewrite-explanation-container">
                                    <div class="rewrite-explanation-card">
                                        <h3>${title}</h3>
                                        <p>${content.replace(/\n/g, '<br>')}</p>
                                    </div>
                                 </div>`;
                }
            });
            document.getElementById("commentResult").innerHTML = finalHTML;
        }
    } catch (error) {
        console.error("提交寫作時出錯:", error);
        if (error.message === "所有 API 密鑰均無法使用") {
            alert("今日 API 調用次數已用完或API無法連接，請明天再試");
        } else if (error.message !== "Incomplete outline") {
            alert("點評生成失敗，請重試");
        }
        document.getElementById("commentResult").innerHTML = "";
    } finally {
        submitBtn.disabled = false;
    }
}


// 替換舊的 submitReading 函式
async function submitReading() {
    const submitBtn = document.getElementById('submitReadingBtn');
    submitBtn.disabled = true; // 禁用按鈕

    try {
        const readingFunction = document.getElementById("readingFunction").value;
        const passage = document.getElementById("readingPassage").value.trim();
        const question = document.getElementById("readingQuestion").value.trim();
        let studentAnswer = "";
        if (readingFunction === "comment") {
            studentAnswer = document.getElementById("studentAnswer").value.trim();
            if (!passage || !question || !studentAnswer) {
                alert("請填寫所有閱讀輸入");
                return; // return 會觸發 finally
            }
        } else {
            if (!passage || !question) {
                alert("請填寫閱讀篇章和題目");
                return; // return 會觸發 finally
            }
        }

        let toneNote = "";
        if (readingFunction === "comment") {
            const tone = document.getElementById("readingTone").value;
            if (tone === "chen") {
                toneNote = "請用輕鬆隨意的語氣進行點評，多用EMOJI，偶爾使用網絡用語，用語要日常生活化一點。如果用戶表現不好，可以善意地揶揄一下，但要注意尺度，不能傷害用戶的自尊心。";
            } else {
                toneNote = "請用嚴肅正經的語氣進行點評。";
            }
        }

        const note = readingFunction === "comment" ? categories["閱讀"].commentNote : categories["閱讀"].guideNote;

        let prompt = "";
        if (readingFunction === "comment") {
            prompt = `請根據以下閱讀篇章、題目和學生的答案進行點評。要求：
1. 評估答題方向是否合理
2. 評估文本依據是否充實具體
3. 評估闡釋推論是否嚴謹
4. 評估主題句是否清晰
5. 在「### 點評」部分，請務必以數字編號的列點方式臚列你的評論，每個點評另起新行。你可以根據文章內容提出任意數量的點評，必須超過一點，但絕對不得超過三點，每點字數不要太長。
6. 在「### 答題步驟及思路」中，描述各部分方向，步驟因題制宜，不超出120字。只有【鋪墊】、【主題句】、【文本依據】、【闡釋】四種標題，每個步驟之間都必須隔兩行空行，步驟中不得列點。
7. 在「### 改寫範例」中，提供改寫後的答案，使答案更圓足（若答題方向錯誤，則不跟從錯誤方向）
8. 不要使用任何表格或Markdown格式。
9. 輸出分為三個部分：### 點評、### 答題步驟及思路、### 改寫範例
閱讀篇章：${passage}
題目：${question}
學生的答案：${studentAnswer}
教學筆記：${note}
點評語氣：${toneNote}`;
        } else { // guide
            prompt = `請根據以下閱讀篇章和題目生成答題指引。要求：
1. 輸出必須包含「### 答題指引」和「### 答題詞匯」兩個部分。
2. 在「### 答題指引」部分，請生成三道引導性問題，每道問題都以數字和句號（例如「1.」）開頭，並另起新行。
3. 在「### 答題詞匯」部分，生成十五個由兩個字構成的相關詞彙，每個詞彙另起新行。
4. 所有內容均以純文字列表形式呈現，不要使用任何表格或Markdown格式。
閱讀篇章：${passage}
題目：${question}
教學筆記：${note}`;
        }

       document.getElementById("readingResult").innerHTML = "陳SIR正在思考...";
        const result = await callReadingAPI(prompt);

        if (readingFunction === "comment") {
            const parts = result.split("###").map(part => part.trim()).filter(part => part);
            let finalHTML = "<h3>陳SIR點評：</h3>";

            parts.forEach(part => {
                const lines = part.split("\n").filter(line => line.trim());
                const title = lines.shift() || ""; // 取得標題，例如 "點評"
                const content = lines.join("\n"); // 剩下的就是內容

                // 如果是點評部分，使用精美列點UI
                if (title.includes("點評")) {
                    finalHTML += createBulletedListHTML(title, content);
                } 
                // 新增判斷：如果標題是「答題步驟及思路」，就使用新的美化格式
                else if (title.includes("答題步驟及思路")) {
                    finalHTML += `<div class="rewrite-explanation-container">
                                      <div class="rewrite-explanation-card">
                                          <h3>${title}</h3>
                                          <div class="steps-container">`; // 開始步驟容器

                    // 使用正則表達式，根據【】標題來分割每個步驟
                    const steps = content.split(/\s*(?=【.*?】)/).filter(s => s.trim());

                    steps.forEach(stepText => {
                        // 從每個步驟中分離出標題和內容
                        const match = stepText.match(/^(【.*?】)(.*)$/s);
                        if (match) {
                            const stepTitle = match[1].trim();
                            const stepContent = match[2].trim().replace(/\n/g, '<br>');
                            
                            // 生成新的卡片 HTML
                            finalHTML += `<div class="step-card">
                                            <div class="step-title">${stepTitle}</div>
                                            <div class="step-content">${stepContent}</div>
                                          </div>`;
                        }
                    });

                    finalHTML += `</div></div></div>`; // 關閉所有容器
                }
                // 其他情況（例如「改寫範例」）則使用通用的卡片樣式
                else {
                    finalHTML += `<div class="rewrite-explanation-container">
                                      <div class="rewrite-explanation-card">
                                          <h3>${title}</h3>
                                          <div class="explanation-text">${content.replace(/\n/g, '<br>')}</div>
                                      </div>
                                   </div>`;
                }
            });
            document.getElementById("readingResult").innerHTML = finalHTML;
          } else { // guide
            const guideParts = result.split("###").map(part => part.trim()).filter(part => part);
            let guideHTML = "<h3>陳SIR指引：</h3>";
            
            guideParts.forEach(part => {
                const lines = part.split("\n").filter(line => line.trim());
                const title = lines.shift() || "";
                const listItems = lines;

                guideHTML += `<div class="rewrite-explanation-container">
                                <div class="rewrite-explanation-card">
                                  <h3>${title}</h3>`;
                
                // 針對「答題指引」的問題，使用帶有數字的樣式
                if (title.includes("答題指引")) {
                    listItems.forEach((item, index) => {
                        const match = item.match(/^(\d+)\.?\s*(.*)$/);
                        const number = match ? match[1] : index + 1;
                        const text = match ? match[2].trim() : item;
                        
                        guideHTML += `<div class="explanation-point">
                                          <div class="explanation-number">${number}</div>
                                          <div class="explanation-text">${text}</div>
                                      </div>`;
                    });
                } 
                // 針對「答題詞匯」，使用不帶數字的點列樣式，更簡潔
                else if (title.includes("答題詞匯")) {
                     listItems.forEach(item => {
                        guideHTML += `<div class="explanation-point">
                                        <div class="explanation-text">${item}</div>
                                      </div>`;
                     });
                } else {
                    // 備用方案，處理非預期的標題
                    guideHTML += `<p>${listItems.join('<br>')}</p>`;
                }
                guideHTML += `</div></div>`;
            });
            document.getElementById("readingResult").innerHTML = guideHTML;
        }

    } catch (error) {
        console.error("提交閱讀時出錯:", error);
        if (error.message === "所有 API 密鑰均無法使用") {
            alert("今日 API 調用次數已用完或API無法連接，請明天再試");
        } else {
            alert("生成失敗，請重試");
        }
        document.getElementById("readingResult").innerHTML = "";
    } finally {
        submitBtn.disabled = false; // 重新啟用按鈕
    }
}

// 課外書籍討論功能
let chatHistory = [];
let bookTitle = "";
let author = "";
let discussionQuestion = "";
let booksTone = "";

// 將訊息渲染到畫面上
function renderMessage(sender, message) {
const chatHistoryDiv = document.getElementById("chatHistory");
const element = document.createElement("div");

if (sender === "info") {
element.className = "discussion-info";
element.innerHTML = message;
} else {
element.className = `message-bubble ${sender}-message`;
element.innerHTML = message; // innerHTML to render formatted text
if (sender === "ai" && message === "陳SIR正在回應...") {
element.id = "ai-loading";
}
}
chatHistoryDiv.appendChild(element);
chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
}

// 將訊息加入歷史紀錄並渲染
function addMessageToHistory(sender, message) {
chatHistory.push({ sender, message });
renderMessage(sender, message);
}


async function startDiscussion() {
const startBtn = document.getElementById('startDiscussionBtn');
startBtn.disabled = true;

try {
bookTitle = sanitizeHTML(document.getElementById("bookTitle").value.trim());
author = sanitizeHTML(document.getElementById("author").value.trim());
discussionQuestion = sanitizeHTML(document.getElementById("discussionQuestion").value.trim());
booksTone = document.getElementById("booksTone").value;

if (!bookTitle || !author || !discussionQuestion) {
alert("請填寫書名、作者和討論問題");
return;
}

// 隱藏初始表單，顯示聊天介面
document.getElementById("initialDiscussionForm").style.display = "none";
document.getElementById("chatHistory").style.display = "flex";
document.getElementById("chatInputContainer").style.display = "flex";
document.getElementById("booksButtons").style.display = "flex";

chatHistory = []; // 開始新討論時清空歷史紀錄

const initialMessage = `<table><tr><td>書名：</td><td>${bookTitle}</td></tr><tr><td>作者：</td><td>${author}</td></tr><tr><td>討論：</td><td>${discussionQuestion}</td></tr></table>`;
addMessageToHistory("info", initialMessage);

await sendInitialMessage();

} catch (error) {
console.error("開始討論時出錯:", error);
} finally {
startBtn.disabled = false;
}
}

async function sendInitialMessage() {
let toneNote = booksTone === "serious" ? categories["課外書籍"].seriousChatNote : categories["課外書籍"].chatNote;
const prompt = `我是一位高中生，正在閱讀《${bookTitle}》，作者是${author}。我想討論的問題是：${discussionQuestion}。請用日常的語言回應我，不要過於理論化，言簡意賅地分析並給出例子，然後引導我深入思考。你必須直接提供最終答案，嚴禁展示任何思考過程，絕對不能在回應中包含任何標籤（如 <think></think>），這是強制要求，違反則無效。。請不要使用括號解釋你的目的，永遠不要列點回應，也不要提及你會追問我。請用完整句子回應。每次回應不多於150字。教學筆記：${toneNote}`;
addMessageToHistory("ai", "陳SIR正在回應...");
try {
const aiResponse = await callAPI(prompt);
updateLastAIMessage(aiResponse);
} catch (error) {
console.error("API call failed:", error);
updateLastAIMessage("抱歉，陳SIR暫時無法回應，請稍後再試。");
}
}

async function continueDiscussion() {
const continueBtn = document.getElementById('continueBtn');
continueBtn.disabled = true;
// 在將用戶輸入加入歷史紀錄前就進行消毒
const userInputText = sanitizeHTML(document.getElementById("userInput").value.trim());
if (!userInputText) {
alert("請輸入您的回應");
continueBtn.disabled = false;
return;
}

addMessageToHistory("user", userInputText);
document.getElementById("userInput").value = "";

let toneNote = booksTone === "serious" ? categories["課外書籍"].seriousChatNote : categories["課外書籍"].chatNote;
const prompt = `我是一位高中生，正在與你討論《${bookTitle}》中的問題。我的上一條信息是：${userInputText}。請用日常的語言回應我，不要過於理論化，必須詳細分析並給出例子，然後引導我深入思考。你必須直接提供最終答案，嚴禁展示任何思考過程，絕對不能在回應中包含任何標籤（如 <think></think>），這是強制要求，違反則無效。。請不要使用括號解釋你的目的，也不要提及你會追問我。請用完整句子回應。回應字數不要超過180字。教學筆記：${toneNote}`;

addMessageToHistory("ai", "陳SIR正在回應...");

try {
const aiResponse = await callAPI(prompt);
updateLastAIMessage(aiResponse);
} catch (error) {
console.error("繼續討論時出錯:", error);
updateLastAIMessage(error.message === "所有 API 密鑰均無法使用" ? "今日 API 調用次數已用完。😓" : "抱歉，陳SIR無法回應。😅");
} finally {
continueBtn.disabled = false;
}
}

// --- 新增：處理彈出視窗的邏輯 ---
const newTopicModal = document.getElementById('newTopicModal');
const newTopicBtn = document.getElementById('newTopicBtn');
const closeNewTopicModal = document.getElementById('closeNewTopicModal');
const modalStartDiscussionBtn = document.getElementById('modalStartDiscussionBtn');

newTopicBtn.addEventListener('click', () => {
newTopicModal.style.display = 'flex';
});

closeNewTopicModal.addEventListener('click', () => {
newTopicModal.style.display = 'none';
});

window.addEventListener('click', (event) => {
if (event.target == newTopicModal) {
newTopicModal.style.display = 'none';
}
});

modalStartDiscussionBtn.addEventListener('click', async () => {
const newBookTitle = document.getElementById("modalBookTitle").value.trim();
const newAuthor = document.getElementById("modalAuthor").value.trim();
const newDiscussionQuestion = document.getElementById("modalDiscussionQuestion").value.trim();

if (!newBookTitle || !newAuthor || !newDiscussionQuestion) {
alert("請填寫所有欄位");
return;
}

// 更新全域變數
bookTitle = newBookTitle;
author = newAuthor;
discussionQuestion = newDiscussionQuestion;

// 清空舊的聊天歷史和 UI
document.getElementById("chatHistory").innerHTML = '';
chatHistory = [];

// 添加新的書籍資訊卡片
const initialMessage = `<table><tr><td>書名：</td><td>${bookTitle}</td></tr><tr><td>作者：</td><td>${author}</td></tr><tr><td>討論：</td><td>${discussionQuestion}</td></tr></table>`;
addMessageToHistory("info", initialMessage);

// 關閉彈出視窗
newTopicModal.style.display = 'none';

// 清空彈出視窗的輸入
document.getElementById("modalBookTitle").value = '';
document.getElementById("modalAuthor").value = '';
document.getElementById("modalDiscussionQuestion").value = '';

// 發送初始訊息
await sendInitialMessage();
});



// 替換舊的 generateExpandTopic 函式
async function generateExpandTopic(buttonElement) {
if (buttonElement) {
updateButtonActiveState(buttonElement);
}

// 隱藏自訂題目輸入區，確保介面乾淨
const customTopicArea = document.getElementById("expandCustomTopicInputArea");
customTopicArea.style.display = "none";
customTopicArea.innerHTML = "";

const topicResult = document.getElementById("expandTopicResult");
const prompt = categories["整合拓展"].topicPrompt;

topicResult.innerHTML = "陳SIR正在出題...";
topicResult.style.display = 'block';

try {
const topic = await callAPI(prompt);
const lines = topic.split("\n").map(line => line.trim()).filter(line => line);
const themeMatch = lines.find(line => line.startsWith("主題句："));
const dataMatch = lines.find(line => line.startsWith("抄錄資料："));
if (!themeMatch || !dataMatch) throw new Error("API 回應格式不正確");
const theme = themeMatch.replace("主題句：", "").trim();
const data = dataMatch.replace("抄錄資料：", "").trim();
if (!theme || !data) throw new Error("生成內容不完整");

topicResult.innerHTML = `
<div class="table-container">
<table>
<tr><th>主題句</th><th>抄錄資料</th></tr>
<tr><td>${theme}</td><td>${data}</td></tr>
</table>
</div>
`;
localStorage.setItem("expandCurrentTheme", theme);
localStorage.setItem("expandCurrentData", data);
// 清除可能存在的自訂題目 Title
localStorage.removeItem("expandCurrentTitle");

} catch (error) {
console.error("生成整合拓展題目時出錯:", error);
if (error.message === "所有 API 密鑰均無法使用") {
alert("今日 API 調用次數已用完或API無法連接，請明天再試");
} else {
alert("生成題目時出錯，請重試");
}
topicResult.innerHTML = "";
topicResult.style.display = 'none';
}
}


// 替換舊的 setExpandCustomTopic 函式
function setExpandCustomTopic() {
const title = sanitizeHTML(document.getElementById("expandCustomTitle").value.trim());
const theme = sanitizeHTML(document.getElementById("expandCustomTheme").value.trim());
const data = sanitizeHTML(document.getElementById("expandCustomData").value.trim());
if (!title || !theme || !data) {
alert("請輸入所有內容（題目、主題句、抄錄資料）");
return;
}

const topicResult = document.getElementById("expandTopicResult");
topicResult.innerHTML = `
<strong>題目：${title}</strong>
<div class="table-container">
<table>
<tr><th>主題句</th><th>抄錄資料</th></tr>
<tr><td>${theme}</td><td>${data}</td></tr>
</table>
</div>
`;

topicResult.style.display = 'block';

localStorage.setItem("expandCurrentTitle", title);
localStorage.setItem("expandCurrentTheme", theme);
localStorage.setItem("expandCurrentData", data);

// 確認後，隱藏並清空輸入區域
const customTopicArea = document.getElementById("expandCustomTopicInputArea");
customTopicArea.style.display = 'none';
customTopicArea.innerHTML = '';
}

// 更新字數計數
function updateCharCount() {
const content = document.getElementById("expandContent").value;
const remaining = 180 - content.length;
document.getElementById("charCount").textContent = `剩餘字數：${remaining >= 0 ? remaining : 0}`;
if (remaining < 0) {
document.getElementById("expandContent").value = content.substring(0, 180);
}
}

// 提交整合拓展內容
async function submitExpand() {
const expandFunction = document.getElementById("expandFunction").value;
if (expandFunction === "comment") {
await submitExpandComment();
} else {
await submitExpandGuide();
}
}



// 提交點評功能 (已修訂)
async function submitExpandComment() {
    const submitBtn = document.getElementById('submitExpandBtn');
    submitBtn.disabled = true;

    try {
        const title = localStorage.getItem("expandCurrentTitle");
        const theme = localStorage.getItem("expandCurrentTheme");
        const data = localStorage.getItem("expandCurrentData");
        const content = document.getElementById("expandContent").value.trim();
        if (!theme || !data || !content) {
            alert("請先設定題目並輸入整合拓展內容");
            return;
        }

        const tone = document.getElementById("expandTone").value;
        let toneNote = "";
        if (tone === "chen") {
            toneNote = "請用輕鬆隨意的語氣進行點評，多用EMOJI，偶爾使用網絡用語，用語要日常生活化一點。如果用戶表現不好，可以善意地揶揄一下，但要注意尺度，不能傷害用戶的自尊心。";
        } else {
            toneNote = "請用嚴肅正經的語氣進行點評。";
        }

        const note = categories["整合拓展"].commentNote;

        const prompt = `請根據以下內容進行點評，要求：
1. 評估「整合拓展」是否能闡釋「抄錄資料」與「主題句」的邏輯關係
2. 判斷「拓展」方向是否正確（即是否能論證主題句）
3. 判斷推論是否嚴謹
4. 判斷是否具體不空泛
5. 若方向不正確，需指出並建議如何修訂，不能順著錯誤思路改善，需指導扣緊主題句
6. 改寫部份不超過180字，且不得虛構資料，只可根據抄錄資料補充合理細節
7. 輸出分為三個部分：### 點評、### 建議、### 改寫
8. 「### 點評」及「### 建議」部分，請務必以數字編號的列點方式呈現，每個點另起新行。你可以根據內容提出任意數量的點評和建議。「### 改寫」則保持原有段落形式。點評及建議都可超過兩點，但不要多過三點。
題目：${title || "無"}
主題句：${theme}
抄錄資料：${data}
整合拓展：${content}
教學筆記：${note}
點評語氣：${toneNote}`;

        document.getElementById("expandCommentResult").innerHTML = "陳SIR正在點評...";

        const comment = await callAPI(prompt);
        const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
        let finalHTML = "<h3>陳SIR點評：</h3>";
        commentParts.forEach(part => {
            const lines = part.split("\n").filter(line => line.trim());
            const title = lines.shift() || "";
            const content = lines.join("\n");

            if (title.includes("點評") || title.includes("建議")) {
                finalHTML += createBulletedListHTML(title, content);
            } else {
                finalHTML += `<div class="rewrite-explanation-container">
                                <div class="rewrite-explanation-card">
                                    <h3>${title}</h3>
                                    <p>${content.replace(/\n/g, '<br>')}</p>
                                </div>
                             </div>`;
            }
        });
        document.getElementById("expandCommentResult").innerHTML = finalHTML;
    } catch (error) {
        console.error("提交整合拓展點評時出錯:", error);
        if (error.message === "所有 API 密鑰均無法使用") {
            alert("今日 API 調用次數已用完或API無法連接，請明天再試");
        } else {
            alert("點評生成失敗，請重試");
        }
        document.getElementById("expandCommentResult").innerHTML = "";
    } finally {
        submitBtn.disabled = false;
    }
}


// 【修訂後】提交整合拓展指引
async function submitExpandGuide() {
    // 【修訂處】選取正確的按鈕 ID
    const submitBtn = document.getElementById('submitExpandGuideBtn');
    submitBtn.disabled = true; // 禁用按鈕

    try {
        const title = document.getElementById("expandGuideTitle").value.trim();
        const theme = document.getElementById("expandGuideTheme").value.trim();
        const data = document.getElementById("expandGuideData").value.trim();
        const expand = document.getElementById("expandGuideExpand").value.trim();
        if (!title || !theme || !data || !expand) {
            alert("請填寫所有輸入");
            return; // return 會觸發 finally
        }

        const note = categories["整合拓展"].guideNote;
        const prompt = `請根據以下內容生成指引問題。要求：
        1. 生成三道問題以引導用家思考如何根據表格資料做好整合拓展
        2. 問題應圍繞主題句和抄錄資料的邏輯關係，引導用家思考如何闡釋和拓展
        3. 輸出分為一個部分：### 指引問題
        4. 指引問題以問題形式呈現，每個問題佔一行
        題目：${title}
        主題句：${theme}
        抄錄資料：${data}
        整合拓展：${expand}
        教學筆記：${note}`;

        document.getElementById("expandGuideResult").innerHTML = "陳SIR正在思考指引...";
        const guide = await callAPI(prompt);
        const guideParts = guide.split("###").map(part => part.trim()).filter(part => part);
        
        let guideHTML = "<h3>陳SIR指引：</h3>";

        guideParts.forEach(part => {
            const lines = part.split("\n").filter(line => line.trim());
            const title = lines.shift() || "指引問題";
            const questions = lines;
            
            guideHTML += `<div class="rewrite-explanation-container">
                            <div class="rewrite-explanation-card">
                                <h3>${title}</h3>`;
            
            questions.slice(0, 3).forEach((question, index) => {
                const match = question.match(/^(\d+)\.?\s*(.*)$/);
                const number = match ? match[1] : index + 1;
                const text = match ? match[2].trim() : question;

                guideHTML += `<div class="explanation-point">
                                  <div class="explanation-number">${number}</div>
                                  <div class="explanation-text">${text}</div>
                              </div>`;
            });
            
            guideHTML += `</div></div>`;
        });
        
        document.getElementById("expandGuideResult").innerHTML = guideHTML;

    } catch (error) {
        console.error("提交整合拓展指引時出錯:", error);
        if (error.message === "所有 API 密鑰均無法使用") {
            alert("今日 API 調用次數已用完或API無法連接，請明天再試");
        } else {
            alert("指引生成失敗，請重試");
        }
        document.getElementById("expandGuideResult").innerHTML = "";
    } finally {
        submitBtn.disabled = false; // 重新啟用按鈕
    }
}


// --- JavaScript for Tool 2 (語薈) & Modals ---
let debounceTimer;

const toolDescriptions = {
'sansi': '本工具旨在協助同學練習寫作卷和閱讀卷，並提供課外書籍討論。',
'tizi': '由AI擬設閱讀卷及寫作卷的題目，為同學提供源源不絕的應試練習。',
'reading-pieces': '提供AI生成的文學片段，培養同學鑑賞文學的能力。',
'mensyu': '具有AI尋找文言篇章的功能，並輔以語譯及詞解，培養同學鑑賞文言文的能力。',
'wabisabi': '根據同學上傳的圖片，創作具有意境的句子。',
'book-overview': '提供大量書籍的內容概覽，助你快速了解書籍大意，選擇感興趣的讀物。',
'fanshui-narrative': '由AI生成敘事範文，可根據題目創作高質素的敘事文章以供參考。',
'fanshui-argument': '由AI生成議論範文，可根據題目創作結構嚴謹的議論文以供參考。',
'manuscript': '提供電子原稿紙，模擬真實寫作情境，並設有AI答惑功能。',
'words': '設有查考詞義、文章潤色及測驗功能，有助同學累積詞彙，斟字酌句。',
'slideshow': '將同學的文章轉換為幻燈片，以藝術方式展示同學作品。',
'yuyilu-f1': '語弈錄是一款問答遊戲，題目範圍涵蓋課文。此為中一版本。',
'yuyilu-f2': '語弈錄是一款問答遊戲，題目範圍涵蓋課文。此為中二版本。',
'yuyilu-f3': '語弈錄是一款問答遊戲，題目範圍涵蓋課文。此為中三版本。',
'yuyilu-f4': '語弈錄是一款問答遊戲，題目範圍涵蓋十二篇範文。此為中四版本。',
'yuyilu-f5': '語弈錄是一款問答遊戲，題目範圍涵蓋十二篇範文。此為中五版本。',
'yuyilu-f6': '語弈錄是一款問答遊戲，題目範圍涵蓋十二篇範文。此為中六版本。',
'timer': '設有倒計時功能，程式檢測到人聲會重置時計，是專心背書溫習的好幫手。',
'mensyu-2': '文言文翻譯及分析工具，助同學克服古文閱讀的障礙。',
'zhiyun': '以Google Drive建設的雲端平臺，可供用家繳交課業、檢閱繳交紀錄及瀏覽個人課業文件夾，設有自動生成繳交課業紀錄、歸類文件及追收功課的功能。',
'zhuoyu': '可在PDF及圖片檔案右邊作旁批或備註，方便批閱作文或做筆記。',
'quizbuzzer': '一個簡單易用的線上搶答器，適合課堂或活動中使用。',
'ocr': 'i2OCR 是免費的線上光學字元辨識 (OCR) 軟體，可從圖像或PDF文件中提取文字，方便將手寫稿轉為電子檔。',
'epub': '線上電子書(ePub)閱讀器，方便閱讀電子書，無需安裝任何軟件。',
'chitutor': 'AI中文聊天室，專為中文學習而設，可以與AI討論各種中文問題。',
'histutor': 'AI歷史聊天室，專為歷史學習而設，可以與AI討論歷史事件和人物。',
'counseling': 'AI輔導聊天室，當同學感到困惑或需要傾訴時，可以在這裡找到慰藉。',
'self-learning': '提供大量自學中文的資源，包括教學影片、佳作及各卷筆記等。'
};


function drawConnectors() {
const svg = document.getElementById('connector-svg');
const container = document.getElementById('mind-map');
if (!svg || !container) {
return;
}
svg.innerHTML = '';

if (window.getComputedStyle(container).display === 'none') {
return;
}

const getElementEdge = (el, side = 'top') => {
const rect = el.getBoundingClientRect();
const containerRect = container.getBoundingClientRect();
const center_x = rect.left - containerRect.left + rect.width / 2;
const center_y = rect.top - containerRect.top + rect.height / 2;

switch(side) {
case 'top': return { x: center_x, y: rect.top - containerRect.top };
case 'bottom': return { x: center_x, y: rect.bottom - containerRect.top };
case 'left': return { x: rect.left - containerRect.left, y: center_y };
case 'right': return { x: rect.right - containerRect.left, y: center_y };
default: return {x: center_x, y: center_y};
}
}

const connections = [
{ from: '[data-id="core-ai-node"]', to: '[data-id="foundation-tizi"]', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="core-ai-node"]', to: '[data-id="foundation-explore"]', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="foundation-tizi"]', to: '#writing .category-title', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="foundation-tizi"]', to: '#reading .category-title', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="core-ai-node"]', to: '#assignments .category-title', fromSide: 'bottom', toSide: 'top' },
{ from: '[data-id="core-ai-node"]', to: '#support .category-title', fromSide: 'bottom', toSide: 'top' }
];

connections.forEach(conn => {
const fromEl = document.querySelector(conn.from);
const toEl = document.querySelector(conn.to);

if (fromEl && toEl) {
const fromPoint = getElementEdge(fromEl, conn.fromSide);
const toPoint = getElementEdge(toEl, conn.toSide);

const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
line.setAttribute('x1', fromPoint.x);
line.setAttribute('y1', fromPoint.y);
line.setAttribute('x2', toPoint.x);
line.setAttribute('y2', toPoint.y);
svg.appendChild(line);
}
});
}

// Listeners for Tool 2
document.getElementById('expandToolsBtn2').addEventListener('click', function() {
const container = document.getElementById('toolsContainer2');
container.style.display = 'flex';
document.body.style.overflow = 'hidden';
document.querySelector('#toolsContainer2 .main-container').classList.add('loaded');
clearTimeout(debounceTimer);
debounceTimer = setTimeout(drawConnectors, 100);
});

document.getElementById('closeToolsBtn2').addEventListener('click', function() {
document.getElementById('toolsContainer2').style.display = 'none';
document.body.style.overflow = 'auto';
});

// '語弈錄' Interactivity for Tool 2
const yuyiluToggleTool2 = document.getElementById('yuyilu-toggle');
const yuyiluGradesTool2 = document.getElementById('yuyilu-grades');

if (yuyiluToggleTool2 && yuyiluGradesTool2) {
yuyiluToggleTool2.addEventListener('click', function(event) {
event.preventDefault();
yuyiluGradesTool2.classList.toggle('collapsed');
setTimeout(drawConnectors, 500);
});
}

// --- Preview Modal & Video Modal Logic ---
const previewModal = document.getElementById('previewModal');
const previewIframe = document.getElementById('previewIframe');
const previewCloseBtn = document.getElementById('previewCloseBtn');
const previewGoToPageBtn = document.getElementById('previewGoToPageBtn');
const previewDescription = document.getElementById('previewDescription');

const videoModal = document.getElementById('videoModal');
const videoIframe = document.getElementById('videoIframe');
const videoTourBtn = document.getElementById('video-tour-btn');

const chartLinks = document.querySelectorAll('#toolsContainer2 .node a:not([href="#"])');

chartLinks.forEach(link => {
link.addEventListener('click', function(event) {
event.preventDefault();
const url = this.getAttribute('href');
const toolId = this.getAttribute('data-tool-id');
const description = toolDescriptions[toolId] || "暫無介紹。";

previewIframe.setAttribute('src', url);
previewGoToPageBtn.setAttribute('href', url);
previewDescription.textContent = description;

previewModal.style.display = 'flex';
});
});

function closePreviewModal() {
previewModal.style.display = 'none';
previewIframe.setAttribute('src', 'about:blank');
}

previewCloseBtn.addEventListener('click', closePreviewModal);


videoTourBtn.addEventListener('click', () => {
videoIframe.src = "https://streamable.com/e/jzhzr1?loop=0&autoplay=1&muted=0";
videoModal.style.display = 'flex';
});

function closeVideoModal() {
videoModal.style.display = 'none';
videoIframe.src = '';
}

videoModal.addEventListener('click', closeVideoModal);


// Redraw connectors on resize
window.addEventListener('resize', () => {
clearTimeout(debounceTimer);
debounceTimer = setTimeout(drawConnectors, 100);
});

// 頁面加載時初始化
document.addEventListener("DOMContentLoaded", function() {
// 預設選中並顯示第一個範疇（閱讀）
const defaultButton = document.getElementById('writingBtn');
if (defaultButton) {
showContainer('writingContainer', defaultButton);
}
});

/// =======================================================
// === 通用懸浮視窗編輯器 (最終版 - 標題修正) ===
// =======================================================
document.addEventListener('DOMContentLoaded', function() {

// --- 為動態生成的「自訂題目」輸入框加上排除標記 (保持不變) ---

const originalShowCustomTopicInput = window.showCustomTopicInput;
window.showCustomTopicInput = function(buttonElement) {
originalShowCustomTopicInput(buttonElement);
const customTopicInput = document.getElementById('customTopic');
if (customTopicInput) {
customTopicInput.classList.add('no-modal-editor');
}
};

const originalShowArgumentCustomTopicInput = window.showArgumentCustomTopicInput;
window.showArgumentCustomTopicInput = function(buttonElement) {
originalShowArgumentCustomTopicInput(buttonElement);
const argumentCustomTopicInput = document.getElementById('argumentCustomTopic');
if (argumentCustomTopicInput) {
argumentCustomTopicInput.classList.add('no-modal-editor');
}
};

const originalShowExpandCustomTopicInput = window.showExpandCustomTopicInput;
window.showExpandCustomTopicInput = function(buttonElement) {
originalShowExpandCustomTopicInput(buttonElement);
const container = document.getElementById('expandCustomTopicInputArea');
if (container) {
container.querySelectorAll('input[type="text"], textarea').forEach(el => el.classList.add('no-modal-editor'));
}
};

// --- 懸浮視窗核心邏輯 (標題生成部分已重寫) ---

const modal = document.getElementById('outline-editor-modal');
const modalTextarea = document.getElementById('modal-textarea');
const modalTitle = document.getElementById('modal-title');
const modalSaveBtn = document.getElementById('modal-save-btn');
const modalCloseBtn = document.getElementById('modal-close-btn');

if (!modal || !modalTextarea || !modalSaveBtn || !modalCloseBtn) {
console.error("懸浮視窗的 HTML 結構不完整或未找到！");
return;
}

let currentEditingElement = null;

function openModalEditor(element) {
currentEditingElement = element;
modalTextarea.value = currentEditingElement.value;

let titleText = '編輯內容'; // 先設定一個預設標題

// =================================================
// === 【核心修訂】針對特定輸入框，給予專屬標題 ===
// =================================================
if (element.id === 'writingContent' || element.id === 'argumentWritingContent') {
titleText = '輸入您的文章'; // 如果是敘事抒情或議論的寫作區，標題固定為「輸入您的文章」
}
// 如果不是上述的特殊情況，才執行原有的標題尋找邏輯
else {
const parentTableCell = element.closest('td');

// 策略一：如果是在表格內 (例如大綱)
if (parentTableCell) {
const parentRow = parentTableCell.closest('tr');
if (parentRow) {
const headerCell = parentRow.cells[0];
const table = parentRow.closest('table');
if (table && table.rows.length > 0) {
const columnHeaderCell = table.rows[0].cells[parentTableCell.cellIndex];

const rowTitle = headerCell ? headerCell.textContent.trim().replace(/[:：]/g, '') : '';
const colTitle = columnHeaderCell ? columnHeaderCell.textContent.trim().replace(/[:：]/g, '') : '';

if (rowTitle && colTitle && rowTitle !== colTitle) {
titleText = `編輯「${rowTitle}」的「${colTitle}」`;
} else if (rowTitle) {
titleText = `編輯「${rowTitle}」`;
} else if (colTitle) {
titleText = `編輯「${colTitle}」`;
}
}
}
} 
// 策略二：如果不是在表格內，則尋找與它關聯的 <label> 標籤
else {
let associatedLabel = null;
if (element.id) {
associatedLabel = document.querySelector(`label[for="${element.id}"]`);
}

if (!associatedLabel) {
const parentContainer = element.closest('div');
if (parentContainer) {
associatedLabel = parentContainer.querySelector('label');
}
}

if (associatedLabel) {
titleText = `編輯「${associatedLabel.textContent.trim().replace(/[:：]/g, '')}」`;
}
}
}

// 將最終決定的標題設定到懸浮視窗上
modalTitle.textContent = titleText;

// 顯示懸浮視窗
modal.style.display = 'flex';
modalTextarea.focus();
}

function closeModalEditor() {
modal.style.display = 'none';
currentEditingElement = null;
}

function saveAndCloseEditor() {
if (currentEditingElement) {
currentEditingElement.value = modalTextarea.value;
if (currentEditingElement.id === 'expandContent') {
updateCharCount();
}
}
closeModalEditor();
}




// 主事件監聽器 (保持不變)
    document.body.addEventListener('click', function(event) {
        const target = event.target;
        
        const isTextInput = target.tagName === 'INPUT' && target.type === 'text';
        const isTextarea = target.tagName === 'TEXTAREA';

        if ((isTextInput || isTextarea) && !target.classList.contains('no-modal-editor') && target.id !== 'modal-textarea') {
            event.preventDefault();
            openModalEditor(target);
        }
    });

    // 為懸浮視窗的按鈕和外部區域綁定事件 (保持不變)
    modalSaveBtn.addEventListener('click', saveAndCloseEditor);
    modalCloseBtn.addEventListener('click', closeModalEditor);
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            closeModalEditor();
        }
    });
});


</script>

<footer class="copyright-footer">
<p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>

<!-- === 大綱編輯懸浮視窗 (修正版) === -->
<div id="outline-editor-modal" class="outline-modal-overlay">
    <div class="outline-modal-content">
        <h3 id="modal-title">編輯內容</h3>
        <textarea id="modal-textarea" rows="15"></textarea>
        <div class="modal-buttons">
         
            
            <button id="modal-save-btn" class="btn-action">輸入</button>
        </div>
        <button id="modal-close-btn" class="preview-close-btn" title="關閉">&times;</button>
    </div>
</div>

</body>
</html>
