<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡è€å¸«çš„æ•‘æ˜Ÿ</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 15px 0;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        select, textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            vertical-align: top;
            word-break: break-word;
        }
        th {
            background: #f0f0f0;
        }
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        .table-container table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-container th, .table-container td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            vertical-align: top;
            word-break: break-word;
        }
        .table-container th:first-child, .table-container td:first-child {
            min-width: 50px;
        }
        .table-container th:nth-child(2), .table-container td:nth-child(2),
        .table-container th:nth-child(3), .table-container td:nth-child(3) {
            min-width: 100px;
        }
        .table-container th:nth-child(4), .table-container td:nth-child(4),
        .table-container th:nth-child(5), .table-container td:nth-child(5) {
            min-width: 150px;
        }
        #writingBtn {
            background-color: #007bff;
        }
        #readingBtn {
            background-color: #28a745;
        }
        #booksBtn {
            background-color: #ffc107;
        }
        #writingBtn:hover {
            background-color: #0056b3;
        }
        #readingBtn:hover {
            background-color: #218838;
        }
        #booksBtn:hover {
            background-color: #e0a800;
        }
        #chatHistory {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .user-message {
            text-align: right;
            color: blue;
            margin: 5px 0;
            padding: 5px;
            background-color: #e6f7ff;
            border-radius: 5px;
        }
        .ai-message {
            text-align: left;
            color: green;
            margin: 5px 0;
            padding: 5px;
            background-color: #f0fff0;
            border-radius: 5px;
        }
        #writingContainer, #readingContainer, #booksContainer {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ä¸­æ–‡è€å¸«çš„æ•‘æ˜Ÿ</h1>

    <!-- å·¥å…·åŠŸèƒ½æ¦‚è¦½ -->
    <div class="box">
        <h2>å·¥å…·åŠŸèƒ½æ¦‚è¦½</h2>
        <p>æœ¬å·¥å…·æ—¨åœ¨å”åŠ©åŒå­¸ç·´ç¿’å¯«ä½œå·å’Œé–±è®€å·ï¼Œä¸¦æä¾›èª²å¤–æ›¸ç±è¨è«–ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦åŠŸèƒ½ï¼š</p>
        <ul>
            <li><strong>å¯«ä½œï¼š</strong>æä¾›ç‰‡æ®µæå¯«ã€å¤§ç¶±çš„ç·´ç¿’åŠæ•˜äº‹ç‰©è±¡æŒ‡å¼•ï¼Œå¯é¸æ“‡ç”Ÿæˆæˆ–è‡ªè¨‚é¡Œç›®ï¼Œä¸¦ç²å–AIé»è©•å’Œå»ºè­°ã€‚</li>
            <li><strong>é–±è®€ï¼š</strong>æä¾›é»è©•å’ŒæŒ‡å¼•åŠŸèƒ½ï¼Œå¯è²¼ä¸Šé–±è®€ç¯‡ç« å’Œé¡Œç›®ï¼Œç²å–AIçš„é»è©•æˆ–ç­”é¡ŒæŒ‡å¼•ã€‚</li>
            <li><strong>èª²å¤–æ›¸ç±ï¼š</strong>æä¾›AIèŠå¤©å®¤ï¼Œèˆ‡AIè¨è«–èª²å¤–æ›¸ç±ï¼Œå¼•å°æ·±å…¥æ€è€ƒã€‚</li>
        </ul>
    </div>

    <!-- ç¯„ç–‡é¸æ“‡ -->
    <div class="box">
        <h2>é¸æ“‡ç·´ç¿’ç¯„ç–‡ï¼š</h2>
        <button id="writingBtn">å¯«ä½œ</button>
        <button id="readingBtn">é–±è®€</button>
        <button id="booksBtn">èª²å¤–æ›¸ç±</button>
    </div>

    <!-- å¯«ä½œå®¹å™¨ -->
    <div id="writingContainer" class="box">
        <label for="writingType">é¸æ“‡å¯«ä½œé¡å‹ï¼š</label>
        <select id="writingType" onchange="toggleWritingType()">
            <option value="ç‰‡æ®µæå¯«">ç‰‡æ®µæå¯«</option>
            <option value="å¤§ç¶±">å¤§ç¶±</option>
            <option value="æ•˜äº‹ç‰©è±¡">æ•˜äº‹ç‰©è±¡</option>
        </select>
        <div id="outlineStructureArea">
            <label for="structure">é¸æ“‡å¤§ç¶±çµæ§‹ï¼š</label>
            <select id="structure" onchange="generateOutlineTable()">
                <option value="fourPart">èµ·æ‰¿è½‰åˆ</option>
                <option value="threeLine">ä¸‰ç·š</option>
            </select>
        </div>
        <div id="topicSelectionArea">
            <label for="topicOption">é¸æ“‡é¡Œç›®æ–¹å¼ï¼š</label>
            <select id="topicOption" onchange="toggleTopicInput()">
                <option value="generate">ç”Ÿæˆé¡Œç›®</option>
                <option value="custom">è‡ªè¨‚é¡Œç›®</option>
            </select>
            <div id="generateTopicArea">
                <button onclick="generateTopic()">ç”Ÿæˆå¯«ä½œé¡Œç›®</button>
            </div>
            <div id="customTopicArea" style="display: none;"></div>
            <div id="topicResult"></div>
        </div>
        <div id="narrativeElementsArea">
            <label for="narrativeElements">è«‹è¼¸å…¥æ‚¨çš„å–ææˆ–æ•…äº‹èƒŒæ™¯ï¼š</label>
            <textarea id="narrativeElements" rows="5" placeholder="ä¾‹å¦‚ï¼šæ•…äº‹èƒŒæ™¯ã€äººç‰©è¨­å®šã€å–æç­‰..."></textarea>
        </div>
        <div id="writingArea">
            <div id="outlineTableArea"></div>
            <textarea id="writingContent" rows="10" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„å¯«ä½œå…§å®¹ï¼ˆã€Œç‰‡æ®µæå¯«ã€ä½¿ç”¨ï¼‰..."></textarea>
            <button onclick="submitWriting()">æäº¤</button>
            <div id="commentResult"></div>
        </div>
    </div>

    <!-- é–±è®€å®¹å™¨ -->
    <div id="readingContainer" class="box">
        <label for="readingFunction">é¸æ“‡é–±è®€åŠŸèƒ½ï¼š</label>
        <select id="readingFunction" onchange="toggleReadingFunction()">
            <option value="comment">é»è©•</option>
            <option value="guide">æŒ‡å¼•</option>
        </select>
        <div id="readingInputArea">
            <label for="readingPassage">è²¼ä¸Šé–±è®€ç¯‡ç« ï¼š</label>
            <textarea id="readingPassage" rows="10" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé–±è®€ç¯‡ç« ..."></textarea>
            <label for="readingQuestion">è²¼ä¸Šé¡Œç›®ï¼š</label>
            <textarea id="readingQuestion" rows="3" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šé¡Œç›®..."></textarea>
            <div id="studentAnswerArea" style="display: none;">
                <label for="studentAnswer">è²¼ä¸Šç­”æ¡ˆï¼š</label>
                <textarea id="studentAnswer" rows="5" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šç­”æ¡ˆ..."></textarea>
            </div>
            <button onclick="submitReading()">æäº¤</button>
            <div id="readingResult"></div>
        </div>
    </div>

    <!-- èª²å¤–æ›¸ç±å®¹å™¨ -->
    <div id="booksContainer" class="box">
        <h2>èª²å¤–æ›¸ç±è¨è«–</h2>
        <p>è«‹åœ¨ä¸‹æ–¹å¡«å¯«æ›¸åã€ä½œè€…å’Œè¨è«–å•é¡Œï¼Œé–‹å§‹èˆ‡é™³SIRå°è©±ï¼š</p>
        <input type="text" id="bookTitle" placeholder="æ›¸å">
        <input type="text" id="author" placeholder="ä½œè€…">
        <textarea id="discussionQuestion" rows="3" placeholder="è¨è«–å•é¡Œ"></textarea>
        <button onclick="startDiscussion()">é–‹å§‹è¨è«–</button>
        <div id="chatHistory"></div>
        <textarea id="userInput" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰..." style="display: none;"></textarea>
        <button id="continueBtn" onclick="continueDiscussion()" style="display: none;">ç¹¼çºŒè¨è«–</button>
    </div>

    <script>
        // API é…ç½®ä¿¡æ¯
        const API_KEYS = [
            "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",
            "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",
            "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"
        ];
        let currentApiKeyIndex = 0;
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const MODEL = "deepseek/deepseek-r1:free";

        // ç¯„ç–‡å®šç¾©
        const categories = {
            "ç‰‡æ®µæå¯«": {
                topicPrompt: "è«‹ç”Ÿæˆä¸€é“é©åˆä¸­å­¸ç”Ÿç·´ç¿’ç‰‡æ®µæå¯«çš„é¡Œç›®ï¼Œé¡Œç›®æ‡‰ç°¡æ½”è¡¨é”ä¸€å€‹ä¸»é¡Œæˆ–å ´æ™¯ï¼Œ20å­—ä»¥å…§ã€‚åŒæ™‚ç”Ÿæˆè©²é¡Œç›®çš„çµæ§‹æ®µé‡é»å’Œæƒ…ç¯€å¤§è¦ã€‚è¦æ±‚ï¼š1. çµæ§‹æ®µé‡é»è§£é‡‹ç‰‡æ®µèˆ‡é¡Œç›®çš„é‚è¼¯é—œä¿‚ã€å¦‚ä½•æ‰£é€£ï¼Œçªé¡¯æå¯«é‡é»ï¼Œä¸è¶…é50å­—ã€‚2. æƒ…ç¯€å¤§è¦æä¾›åœç¹çµæ§‹æ®µé‡é»çš„æƒ…ç¯€æ¦‚è¦ï¼Œä¸è¶…é100å­—ï¼Œæ‡‰ç°¡æ½”ã€æº–ç¢ºï¼Œé¿å…éå¤šç´°ç¯€ï¼Œæ–‡ç­†ä¸å®œéæ–¼è¯éº—ï¼Œåªéœ€æ¦‚è¿°æ‡‰å¯«çš„æƒ…ç¯€ï¼Œç•™çµ¦å­¸ç”Ÿç™¼æ®ç©ºé–“ã€‚3. è¼¸å‡ºæ ¼å¼ç‚ºï¼šé¡Œç›®ï¼š...\nçµæ§‹æ®µé‡é»ï¼š...\næƒ…ç¯€å¤§è¦ï¼š...\n4. å…§å®¹ç°¡æ½”æ˜äº†ï¼Œé¿å…å†—é•·ã€‚5. é¡Œç›®å¤šæ¨£åŒ–ï¼Œé¿å…é‡è¤‡ã€‚",
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œå¿…é ˆå°±ä¸Šè¿°ç”Ÿæˆæˆ–è¼¸å…¥çš„é¡Œç›®ã€çµæ§‹æ®µé‡é»ã€æƒ…ç¯€å¤§è¦ï¼Œé»è©•å¤§ç¶±å…§å®¹æ˜¯å¦æ‰£é¡Œã€‚å¿…é ˆå¾ä»¥ä¸‹å…©å€‹è§’åº¦é»è©•ï¼šå…¶ä¸€ï¼Œé»è©•ã€Œçµæ§‹æ®µé‡é»èˆ‡é¡Œç›®æ˜¯å¦æœ‰é—œã€æœ‰å¤šå¤§é‚è¼¯é—œä¿‚ã€ï¼›å…¶äºŒï¼Œé»è©•ã€Œæƒ…ç¯€å¤§è¦æ˜¯å¦èƒ½çªé¡¯å‡ºçµæ§‹æ®µé‡é»ã€å¯«ä½œå…§å®¹çš„è©³ç•¥å‰ªè£æ˜¯å¦æ°ç•¶ï¼Œå³æ˜¯å¦æœ‰æ•ˆçªé¡¯çµæ§‹æ®µé‡é»ï¼ˆå‰ææ˜¯çµæ§‹æ®µé‡é»æ‰£é¡Œï¼Œå¦‚ä¸æ‰£é¡Œï¼Œæƒ…ç¯€å¤§è¦åŠå¯«ä½œå…§å®¹å°±è‚¯å®šä¸æ‰£é¡Œï¼‰ï¼Œé»è©•æ™‚è¦æ³¨æ„å¯«ä½œå…§å®¹ã€çµæ§‹æ®µé‡é»å…©è€…èˆ‡é¡Œç›®æœ‰æ²’æœ‰åœ¨é¡¯æ€§çš„é‚è¼¯é—œä¿‚ï¼Œå¯«ä½œå…§å®¹è¦æ±‚çš„ä¸åªæ˜¯å–ææƒ…ç¯€å¯ä»¥èˆ‡çµæ§‹æ®µé‡é»åŠé¡Œç›®æ§‹æˆé‚è¼¯é—œä¿‚ï¼Œæ›´è¦ç”¨åˆé©çš„æƒ…ç¯€è©³ç•¥å‰ªè£å’Œæ‰£é¡Œå°æ®µå»çªé¡¯èˆ‡è©²éƒ¨ä»½çš„é‚è¼¯é—œä¿‚ï¼Œä½¿å¯«ä½œå…§å®¹æ˜ç¢ºå‘¼æ‡‰çµæ§‹æ®µé‡é»åŠé¡Œç›®ã€‚ã€è‹¥é›¢é¡Œï¼Œç¯„ä¾‹ä¸å¿…æ ¹æ“šåŸæ–‡é›¢é¡Œå…§å®¹æ”¹å¯«ï¼Œè€Œæ”¹å¯«éƒ¨ä»½å¿…é ˆåŒ…å«æ‰£é¡Œå°æ®µï¼ˆéƒ¨ä»½å¥å­ç›´æ¥å‘¼æ‡‰çµæ§‹æ®µé‡é»æˆ–é¡Œç›®ï¼‰ã€‚é»è©•åˆ†ç‚ºä¸‰éƒ¨åˆ†ï¼š### é»è©•ã€### å»ºè­°ã€### æ”¹å¯«ç¯„ä¾‹ã€‚åªé¸å–æœ€é‡è¦çš„ä¸€è‡³å…©é»è©•è«–ï¼Œæ‡‰å…ˆèšç„¦åœ¨è©•è«–å¯«ä½œå…§å®¹æ˜¯å¦åœ¨æ‰£é€£é¡Œç›®åŠçµæ§‹æ®µé‡é»çš„æ–¹å‘ä»¥åŠå…¶è©³ç•¥å‰ªè£ï¼Œå…¶æ¬¡æ–¹ç‚ºæ–‡å¥ï¼ˆåŒ…æ‹¬ç¤ºç¾æ•˜äº‹å’Œå¯†åº¦ï¼‰ã€‚è‹¥çµæ§‹æ®µé‡é»æˆ–æƒ…ç¯€å¤§è¦èˆ‡é¡Œç›®é—œä¿‚è–„å¼±ï¼Œé ˆåœ¨é»è©•ä¸­æŒ‡å‡ºä¸¦é‡é»èªªæ˜ã€‚é»è©•å…§å®¹è¦ç²¾ç°¡ã€ä¸€èªä¸­çš„ï¼Œåƒ…å°‡æœ€é—œéµã€å½±éŸ¿æœ€å¤§çš„ä¸€è‡³å…©é …è©•èªé»å‡ºä¾†ï¼Œè‹¥æ‰£é¡Œå’Œè©³ç•¥å‰ªè£ç­‰éƒ½è™•ç†ä¸å¾—ç•¶ï¼Œå‰‡ä¸éœ€è¦è©³è©•æ–‡å¥ã€‚ç‰‡æ®µæå¯«éœ€äº¤æ›¿é‹ç”¨å°ç‰©ä»¶ã€å‹•ä½œã€å°è©±å’Œå…§å¿ƒç¨ç™½ï¼Œæé«˜æ–‡å¥å¯†åº¦ï¼ˆè©åŒ¯æ·±åº¦é«˜ã€ç‰©è±¡è±å¯Œã€å¯¦è©æ¯”ä¾‹é«˜ï¼‰ï¼Œä½†å¿…é ˆæ³¨æ„ï¼šéçŒ¶ä¸åŠï¼Œä¸è¦é€£ç”¨å°ç‰©ä»¶åšä¸»èªçš„å¥å­ï¼Œé©æ™‚éœ€è¦ä»¥äººç‰©ä½œä¸»èªï¼Œäº¤æ›¿å»ç”¨ï¼Œæœ‰æ™‚åŠ å…¥å…§å¿ƒç¨ç™½æœƒä»¤æ–‡å¥é¡¯å¾—æ›´è‡ªç„¶ï¼Œå¯†åº¦ä¸å®œéé«˜ï¼Œé©æ™‚è¦åŠ å…¥è™›è©æ”¾ç·©ç¯€å¥ï¼Œå¼µå¼›æœ‰åº¦ã€‚æ­¤å¤–ï¼Œè¦æ§åˆ¶è©³ç•¥ç¯€å¥ï¼Œè©³å¯«èˆ‡é¡Œç›®ç›¸é—œçš„éƒ¨åˆ†ï¼Œç•¥å¯«æ¬¡è¦å…§å®¹ã€‚æ–‡å¥å¯†åº¦ä¹Ÿæ˜¯å¥½æ–‡ç­†çš„æ¨™æº–ï¼Œéœ€ç´å…¥è€ƒé‡ã€‚é»è©•å’Œå»ºè­°ä¸æ‡‰ä½¿ç”¨åˆ—é»å½¢å¼ï¼Œæ‡‰ä»¥æ®µè½å‘ˆç¾ã€‚æ­¤å¤–ï¼Œå‡å¦‚æ•´é«”è¡¨ç¾çœŸçš„ä¸éŒ¯ï¼Œæ²’æœ‰å¤§å•é¡Œï¼Œåœ¨é»è©•æ™‚ç¨±è®šå³å¯ï¼Œä¸å¿…å¹æ¯›æ±‚ç–µåœ°æ‰¹è©•ï¼Œä½†åœ¨å¯«ä½œå…§å®¹çš„ã€Œæ‰£é¡Œã€é‚è¼¯ä¸Šå¿…é ˆåš´è¬¹æŠŠé—œã€‚"
            },
            "å¤§ç¶±": {
                topicPrompt: "è«‹ç”Ÿæˆä¸€é“é©åˆä¸­å­¸ç”Ÿç·´ç¿’å¯«ä½œå¤§ç¶±çš„é¡Œç›®ï¼Œè¦æ±‚ï¼š1.10å­—ä»¥å…§ 2.åŠ å¿«ç”Ÿæˆé€Ÿåº¦ 3.é™¤äº†é¡Œç›®ä¹‹å¤–ï¼Œä¸è¦ç”Ÿæˆå…¶ä»–ä»»ä½•å…§å®¹",
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œå¿…é ˆå°±ä¸Šè¿°ç”Ÿæˆçš„é¡Œç›®é»è©•å¤§ç¶±å…§å®¹æ˜¯å¦æ‰£é¡Œï¼Œå‡å¦‚å¤§ç¶±é›¢é¡Œï¼Œç¯„ä¾‹ä¾¿ä¸å¿…æ ¹æ“šé›¢é¡Œå…§å®¹æ”¹å¯«ã€‚æ­¤å¤–ï¼Œé»è©•æ‡‰åˆ†ç‚ºä¸‰å€‹éƒ¨ä»½ï¼šé»è©•ã€å»ºè­°ã€æ”¹å¯«ç¯„ä¾‹ã€‚åœ¨å¯«ä½œå¤§ç¶±æ™‚ï¼Œå­¸ç”Ÿæ‡‰å±•ç¤ºä»–å€‘çµ„ç¹”æ€è·¯å’Œçµæ§‹æ•…äº‹çš„èƒ½åŠ›ã€‚è©•åˆ†æ™‚ï¼Œè«‹æ³¨æ„å¤§ç¶±çš„é‚è¼¯æ€§ã€æ¢ç†æ€§ä»¥åŠæ˜¯å¦åŒ…å«äº†æ•…äº‹çš„èµ·æ‰¿è½‰åˆæˆ–ä¸‰ç·šçµæ§‹ã€‚è¦é€éƒ¨åˆ†åˆ†ææ¯å€‹çµæ§‹æ®µèˆ‡é¡Œç›®çš„é—œä¿‚æœ‰å¤šå¤§ï¼Œä¸¦åœ¨é»è©•ä¸­æ˜ç¢ºæŒ‡å‡ºã€‚æ­¤å¤–ï¼Œåœ¨ã€Œæ”¹å¯«å¾Œçš„å¤§ç¶±ã€,å…¶ã€Œçµæ§‹æ®µé‡é»ã€å¿…é ˆäº¤ä»£è©²éƒ¨ä»½èˆ‡é¡Œç›®ä¹‹é–“çš„é‚è¼¯é—œä¿‚ï¼Œå³æ€æ¨£åšåˆ°æ‰£é¡Œã€‚æ­¤å¤–ï¼Œç”±æ–¼æ˜¯æ‡‰è©¦æ–‡ç« ï¼Œå› æ­¤æ”¹å¯«å¾Œçš„å¤§ç¶±é¿å…éä»½å…·ç†è«–å“²å­¸æ€§åŠæ–‡å­¸æ€§ï¼Œä»¥è‡³æ–¼è„«é›¢äº†ç¾å¯¦å’Œæ—¥å¸¸ç”Ÿæ´»ï¼Œäº¦åœç¹äººåœ¨ç¶“æ­·çš„æƒ…æ„Ÿå’Œé«”æ‚Ÿè¨­å®šï¼Œå¿…é ˆæ¸›å°‘æ¦‚å¿µæ¨¡ç³Šçš„è¡“èªï¼Œä¾‹å¦‚ã€Œæƒ…æ„Ÿè¼‰é«”ã€åŠã€Œæ™‚ç©ºçš„å…±å‰µã€ï¼Œè«‹ç”¨æ—¥å¸¸åŒ–ç”¨èªæè¿°ã€‚æ­¤å¤–ï¼Œã€Œæ”¹å¯«å¾Œçš„å¤§ç¶±ã€ä¸å®œåªåœç¹ä¸€ä»¶äº‹æ•˜å¯«ï¼Œé€™æ¨£æœƒå®¹æ˜“å¯«å¾—å¤ªæŠ½è±¡ï¼Œæ‡‰é©æ™‚åŠ æ’äººç‰©èˆ‡äººç‰©ä¹‹é–“çš„å›æ†¶æˆ–å…¶ä»–ç¶“æ­·ï¼Œä»¤æ–‡ç« çœ‹èµ·ä¾†æ›´å…·é«”å¯¦åœ¨ã€‚æ­¤å¤–ï¼Œå¤§ç¶±ä¸æ˜¯å…¨ç¯‡æ–‡ç« ï¼Œæœ€é‡è¦çš„æ˜¯åœ¨é»è©•æ™‚åˆ†æå…¶çµæ§‹æ®µåŠæƒ…ç¯€å¤§è¦çš„æ€è·¯æ˜¯å¦æ‰£ç·Šé¡Œç›®ï¼Œæ–¹å‘æ˜¯å¦åˆç†ã€æ­£ç¢ºã€‚å‡å¦‚æ•´é«”è¡¨ç¾çœŸçš„ä¸éŒ¯ï¼Œæ²’æœ‰å¤§å•é¡Œï¼Œåœ¨é»è©•æ™‚ç¨±è®šå³å¯ï¼Œä¸å¿…å¹æ¯›æ±‚ç–µåœ°æ‰¹è©•ã€‚"
            },
            "æ•˜äº‹ç‰©è±¡": {
                topicPrompt: "è«‹ç”Ÿæˆä¸€é“é©åˆä¸­å­¸ç”Ÿç·´ç¿’æ•˜äº‹ç‰©è±¡çš„é¡Œç›®ï¼Œè¦æ±‚ï¼š1.å¿…é ˆåŒ…å«å…©å€‹éƒ¨ä»½,ä¸€æ˜¯ç‰‡æ®µè¦äº¤ä»£ç”šéº¼æƒ…ç¯€ã€æ•˜äº‹é‡é»æ˜¯ç”šéº¼,äºŒæ˜¯è¦å¼·èª¿çš„äººç‰©æ„Ÿæƒ…ã€‚2.åªç”Ÿæˆä¸€é“é¡Œç›®ï¼Œ20å­—ä»¥å…§ 3.åŠ å¿«ç”Ÿæˆé€Ÿåº¦ 4.é™¤äº†é¡Œç›®ä¹‹å¤–ï¼Œä¸è¦ç”Ÿæˆå…¶ä»–ä»»ä½•å…§å®¹ 5.é¡Œç›®è¦å¤šè®ŠåŒ–",
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚åœ¨ã€Œæ•˜äº‹ç‰©è±¡ã€ä¸­ï¼Œå­¸ç”Ÿéœ€è¦é‹ç”¨è±å¯Œçš„ç‰©è±¡ä¾†å¢å¼·æ•…äº‹çš„ç”Ÿå‹•æ€§å’ŒçœŸå¯¦æ„Ÿã€‚ç‰©è±¡æ‡‰èˆ‡é¡Œç›®ã€å–æå’Œæ•…äº‹èƒŒæ™¯ç·Šå¯†ç›¸é—œï¼Œä¸¦ä¸”èƒ½å¤ æœ‰æ•ˆåœ°è¡¨é”äººç‰©çš„æƒ…æ„Ÿå’Œæ•…äº‹çš„ä¸»é¡Œã€‚è«‹ç¢ºä¿ç”Ÿæˆçš„ç‰©è±¡ä¸é‡è¤‡ï¼Œä¸¦ä¸”æ’ç‰ˆæ¸…æ™°æ˜“è®€ã€‚æ­¤å¤–ï¼Œæ¯å€‹ç‰©è±¡éƒ½å¿…é ˆç”±å…©å€‹å­—æ§‹æˆã€‚"
            },
            "é–±è®€": {
                commentNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚é»è©•æ™‚ï¼Œéœ€è©•ä¼°ç­”é¡Œæ–¹å‘æ˜¯å¦åˆç†ã€æ–‡æœ¬ä¾æ“šæ˜¯å¦å……å¯¦å…·é«”ã€é—¡é‡‹æ¨è«–æ˜¯å¦åš´è¬¹ã€ä¸»é¡Œå¥æ˜¯å¦æ¸…æ™°ã€‚æ–‡æœ¬ä¾æ“šæ‡‰æ¦‚æ‹¬æ­¸ç´è€Œéç›´æ¥å¼•ç”¨åŸæ–‡ï¼Œé™¤éé¡Œç›®ä¸­æœ‰ã€æ‘˜éŒ„ã€å­—çœ¼ã€‚æ”¹å¯«ç¯„ä¾‹æ‡‰ä½¿ç­”æ¡ˆæ›´åœ“è¶³ï¼Œä½†è‹¥å­¸ç”Ÿç­”é¡Œæ–¹å‘éŒ¯èª¤ï¼Œå‰‡ä¸è·Ÿå¾éŒ¯èª¤æ–¹å‘æ”¹å¯«ã€‚é»è©•ä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸ä½¿ç”¨åˆ—é»ã€‚åœ¨ã€Œæ”¹å¯«ç¯„ä¾‹ã€å‰ï¼ŒåŠ å…¥ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ï¼Œæè¿°å„éƒ¨åˆ†æ–¹å‘ï¼Œæ­¥é©Ÿå› é¡Œåˆ¶å®œï¼Œå¯èƒ½åŒ…æ‹¬ã€é‹ªå¢Šã€‘ã€ã€å›æ‡‰ã€‘ã€ã€æ–‡æœ¬ä¾æ“šã€‘ã€ã€é—¡é‡‹ã€‘ï¼Œéˆæ´»é‹ç”¨ã€‚æ¯å€‹æ­¥é©Ÿä»¥ã€æ­¥é©Ÿåã€‘æ¨™é¡ŒåŠ åˆ†è¡Œå…§å®¹å‘ˆç¾ï¼Œæ’ç‰ˆæ•´é½Šã€‚è¡¨æ ¼ä¸­åªåŒ…å«æ–‡å­—å’Œæ¨™é»ï¼Œä¸å«ã€---ã€ç­‰ç¬¦è™Ÿã€‚",
                guideNote: "å¿…é ˆç”¨ç¹é«”å­—ã€‚åƒ…ç”Ÿæˆä¸‰é“å•é¡Œä»¥å¼•å°ç”¨å®¶å›ç­”é–±è®€ç¯‡ç« çš„å•é¡Œï¼Œå•é¡Œé‡å°é¡Œç›®ï¼Œå¼•å°æ€è€ƒæ–‡æœ¬å…§å®¹ã€çµæ§‹å’Œä¸»é¡Œï¼Œä¸å«å…¶ä»–å…§å®¹ã€‚ç”Ÿæˆ15å€‹ç”±å…©å€‹å­—æ§‹æˆçš„ç­”é¡Œè©åŒ¯ï¼Œè©åŒ¯éœ€èˆ‡ç­”é¡Œæ–¹å‘ç›¸é—œä¸”ä¸é‡è¤‡ï¼Œæ—¨åœ¨ä»¤ç”¨å®¶åœ¨ç­”é¡Œæ™‚æœ‰æ›´è±å¯Œçš„è©åŒ¯ï¼Œç¢ºä¿ä¸èƒ½æœ‰ã€Œ|--------|ã€åŠã€Œ| è©åŒ¯ |ã€ï¼Œæ’ç‰ˆæ•´é½Šã€‚è¼¸å‡ºåˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼š### ç­”é¡ŒæŒ‡å¼•ã€### ç­”é¡Œè©åŒ¯ã€‚ç­”é¡ŒæŒ‡å¼•ä»¥å•é¡Œå½¢å¼å‘ˆç¾ï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œã€‚ç­”é¡Œè©åŒ¯ä»¥è¡¨æ ¼å½¢å¼å‘ˆç¾ï¼Œæ¯å€‹è©å ä¸€è¡Œã€‚æ­¤å¤–ï¼Œå‡å¦‚æ•´é«”è¡¨ç¾çœŸçš„ä¸éŒ¯ï¼Œæ²’æœ‰å¤§å•é¡Œï¼Œåœ¨é»è©•æ™‚ç¨±è®šå³å¯ï¼Œä¸å¿…å¹æ¯›æ±‚ç–µåœ°æ‰¹è©•ã€‚"
            },
            "èª²å¤–æ›¸ç±": {
                chatNote: "å¿…é ˆç”¨ç¹é«”å­—ï¼Œå¤šç”¨EMOJIï¼Œå¶çˆ¾å¯ä»¥ç”¨ä¸€ä¸‹ç¶²çµ¡ç”¨èªã€‚"
            }
        };

        // ç¯„ç–‡åˆ‡æ›
        document.getElementById("writingBtn").addEventListener("click", function() {
            showContainer("writingContainer");
        });
        document.getElementById("readingBtn").addEventListener("click", function() {
            showContainer("readingContainer");
        });
        document.getElementById("booksBtn").addEventListener("click", function() {
            showContainer("booksContainer");
        });

        function showContainer(containerId) {
            document.getElementById("writingContainer").style.display = "none";
            document.getElementById("readingContainer").style.display = "none";
            document.getElementById("booksContainer").style.display = "none";
            document.getElementById(containerId).style.display = "block";
            if (containerId === "writingContainer") toggleWritingType();
            if (containerId === "readingContainer") toggleReadingFunction();
        }

        // åˆ‡æ›å¯«ä½œé¡å‹
        function toggleWritingType() {
            const writingType = document.getElementById("writingType").value;
            const outlineStructureArea = document.getElementById("outlineStructureArea");
            const narrativeElementsArea = document.getElementById("narrativeElementsArea");
            const writingContent = document.getElementById("writingContent");
            const outlineTableArea = document.getElementById("outlineTableArea");

            if (writingType === "å¤§ç¶±") {
                outlineStructureArea.style.display = "block";
                narrativeElementsArea.style.display = "none";
                writingContent.style.display = "none";
                generateOutlineTable();
            } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                outlineStructureArea.style.display = "none";
                narrativeElementsArea.style.display = "block";
                writingContent.style.display = "none";
                outlineTableArea.innerHTML = "";
            } else {
                outlineStructureArea.style.display = "none";
                narrativeElementsArea.style.display = "none";
                writingContent.style.display = "block";
                outlineTableArea.innerHTML = "";
            }
            toggleTopicInput();
        }

        // åˆ‡æ›é–±è®€åŠŸèƒ½
        function toggleReadingFunction() {
            const readingFunction = document.getElementById("readingFunction").value;
            const studentAnswerArea = document.getElementById("studentAnswerArea");
            studentAnswerArea.style.display = readingFunction === "comment" ? "block" : "none";
        }

        // åˆ‡æ›é¡Œç›®è¼¸å…¥æ–¹å¼
        function toggleTopicInput() {
            const writingType = document.getElementById("writingType").value;
            const option = document.getElementById("topicOption").value;
            const customTopicArea = document.getElementById("customTopicArea");
            if (option === "generate") {
                document.getElementById("generateTopicArea").style.display = "block";
                customTopicArea.style.display = "none";
                document.getElementById("topicResult").innerHTML = "";
                localStorage.removeItem("currentTopic");
                localStorage.removeItem("currentFocus");
                localStorage.removeItem("currentPlot");
            } else {
                document.getElementById("generateTopicArea").style.display = "none";
                customTopicArea.style.display = "block";
                document.getElementById("topicResult").innerHTML = "";
                localStorage.removeItem("currentTopic");
                localStorage.removeItem("currentFocus");
                localStorage.removeItem("currentPlot");
                if (writingType === "ç‰‡æ®µæå¯«") {
                    customTopicArea.innerHTML = `
                        <table>
                            <tr><th colspan="2">è‡ªè¨‚é¡Œç›®</th></tr>
                            <tr><td colspan="2"><input type="text" id="customTitle" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®"></td></tr>
                            <tr><td>çµæ§‹æ®µé‡é»</td><td>æƒ…ç¯€å¤§è¦</td></tr>
                            <tr><td><textarea id="customFocus" rows="3" placeholder="è«‹è¼¸å…¥çµæ§‹æ®µé‡é»"></textarea></td>
                                <td><textarea id="customPlot" rows="3" placeholder="è«‹è¼¸å…¥æƒ…ç¯€å¤§è¦"></textarea></td></tr>
                        </table>
                        <button onclick="setCustomTopic()">ç¢ºèªé¡Œç›®</button>
                    `;
                } else {
                    customTopicArea.innerHTML = `
                        <input type="text" id="customTopic" placeholder="è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®">
                        <button onclick="setCustomTopic()">ç¢ºèªé¡Œç›®</button>
                    `;
                }
            }
        }

        // é€šç”¨ API èª¿ç”¨å‡½æ•¸
        async function callAPI(prompt) {
            let attempts = 0;
            const maxAttempts = API_KEYS.length;
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${API_KEYS[currentApiKeyIndex]}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    if (response.status === 429) {
                        currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                        attempts++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API èª¿ç”¨å¤±æ•—: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                } catch (error) {
                    console.error(error);
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw new Error("æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨");
                    }
                }
            }
        }

        // ç”Ÿæˆå¯«ä½œé¡Œç›®
        async function generateTopic() {
            const writingType = document.getElementById("writingType").value;
            const prompt = categories[writingType].topicPrompt;

            document.getElementById("topicResult").innerHTML = "é™³SIRæ­£åœ¨å‡ºé¡Œ...";

            try {
                const topic = await callAPI(prompt);
                if (writingType === "ç‰‡æ®µæå¯«") {
                    const lines = topic.split("\n");
                    if (lines.length < 3) throw new Error("API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º");
                    const title = lines[0].replace("é¡Œç›®ï¼š", "").trim();
                    const focus = lines[1].replace("çµæ§‹æ®µé‡é»ï¼š", "").trim();
                    const plot = lines[2].replace("æƒ…ç¯€å¤§è¦ï¼š", "").trim();
                    if (!title || !focus || !plot) throw new Error("ç”Ÿæˆå…§å®¹ä¸å®Œæ•´");
                    document.getElementById("topicResult").innerHTML = `
                        ä»Šæ—¥é¡Œç›®ï¼š<strong>${title}</strong>
                        <table>
                            <tr><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>
                            <tr><td>${focus}</td><td>${plot}</td></tr>
                        </table>
                    `;
                    localStorage.setItem("currentTopic", title);
                    localStorage.setItem("currentFocus", focus);
                    localStorage.setItem("currentPlot", plot);
                } else {
                    document.getElementById("topicResult").innerHTML = "ä»Šæ—¥é¡Œç›®ï¼š<strong>" + topic + "</strong>";
                    localStorage.setItem("currentTopic", topic);
                }
            } catch (error) {
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("ç”Ÿæˆé¡Œç›®æ™‚å‡ºéŒ¯ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("topicResult").innerHTML = "";
            }
        }

        // è¨­å®šè‡ªè¨‚é¡Œç›®
        function setCustomTopic() {
            const writingType = document.getElementById("writingType").value;
            if (writingType === "ç‰‡æ®µæå¯«") {
                const title = document.getElementById("customTitle").value.trim();
                const focus = document.getElementById("customFocus").value.trim();
                const plot = document.getElementById("customPlot").value.trim();
                if (!title || !focus || !plot) {
                    alert("è«‹è¼¸å…¥æ‰€æœ‰å…§å®¹");
                    return;
                }
                document.getElementById("topicResult").innerHTML = `
                    è‡ªè¨‚é¡Œç›®ï¼š<strong>${title}</strong>
                    <table>
                        <tr><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>
                        <tr><td>${focus}</td><td>${plot}</td></tr>
                    </table>
                `;
                localStorage.setItem("currentTopic", title);
                localStorage.setItem("currentFocus", focus);
                localStorage.setItem("currentPlot", plot);
            } else {
                const customTopic = document.getElementById("customTopic").value.trim();
                if (!customTopic) {
                    alert("è«‹è¼¸å…¥è‡ªè¨‚é¡Œç›®");
                    return;
                }
                document.getElementById("topicResult").innerHTML = "è‡ªè¨‚é¡Œç›®ï¼š<strong>" + customTopic + "</strong>";
                localStorage.setItem("currentTopic", customTopic);
            }
        }

        // ç”Ÿæˆå¤§ç¶±è¡¨æ ¼
        function generateOutlineTable() {
            const structure = document.getElementById("structure").value;
            let parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
            let tableHTML = "<table><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>";
            parts.forEach((part, index) => {
                const focusId = structure + "Focus" + (index + 1);
                const plotId = structure + "Plot" + (index + 1);
                tableHTML += `<tr><td>${part}</td><td><textarea id="${focusId}" rows="3"></textarea></td><td><textarea id="${plotId}" rows="3"></textarea></td></tr>`;
            });
            tableHTML += "</table>";
            document.getElementById("outlineTableArea").innerHTML = tableHTML;
        }

        // æäº¤å¯«ä½œå…§å®¹
        async function submitWriting() {
            const writingType = document.getElementById("writingType").value;
            const topic = localStorage.getItem("currentTopic");
            if (!topic) {
                alert("è«‹å…ˆè¨­å®šé¡Œç›®");
                return;
            }

            let content = "";
            let structure = "";
            if (writingType === "å¤§ç¶±") {
                structure = document.getElementById("structure").value;
                const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];
                content = parts.map((part, index) => {
                    const focusId = structure + "Focus" + (index + 1);
                    const plotId = structure + "Plot" + (index + 1);
                    const focus = document.getElementById(focusId).value;
                    const plot = document.getElementById(plotId).value;
                    if (!focus || !plot) {
                        alert("è«‹å¡«å¯«æ‰€æœ‰å¤§ç¶±è¡¨æ ¼");
                        throw new Error("Incomplete outline");
                    }
                    return { part, focus, plot };
                });
            } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                content = document.getElementById("narrativeElements").value.trim();
            } else {
                content = document.getElementById("writingContent").value;
                if (!content) {
                    alert("è«‹å…ˆè¼¸å…¥å¯«ä½œå…§å®¹");
                    return;
                }
            }

            const note = categories[writingType].commentNote;

            let prompt = "";
            if (writingType === "å¤§ç¶±") {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹å¤§ç¶±å…§å®¹é€²è¡Œé»è©•å’Œå»ºè­°ï¼Œä¸¦æä¾›æ”¹å¯«å¾Œçš„å¤§ç¶±ã€‚è¦æ±‚ï¼š
1. åœ¨ã€Œ=== é»è©•åŠå»ºè­° ===ã€éƒ¨åˆ†ï¼Œç‚ºæ¯å€‹çµæ§‹æ®µæä¾›é»è©•å’Œå»ºè­°ã€‚ä½¿ç”¨ã€Œ[part]ã€æ¨™è¨˜æ¯å€‹çµæ§‹æ®µçš„é–‹å§‹ï¼Œä¾‹å¦‚ã€Œ[èµ·]ã€ï¼Œç„¶å¾Œåœ¨ä¸‹ä¸€è¡Œã€Œé»è©•ï¼šã€å¾Œè·Ÿé»è©•å…§å®¹ï¼Œå†ä¸‹ä¸€è¡Œã€Œå»ºè­°ï¼šã€å¾Œè·Ÿå»ºè­°å…§å®¹ã€‚
2. åœ¨ã€Œ=== æ”¹å¯«å¾Œçš„å¤§ç¶± ===ã€éƒ¨åˆ†ï¼Œç‚ºæ¯å€‹çµæ§‹æ®µæä¾›æ”¹å¯«å¾Œçš„ã€Œçµæ§‹æ®µé‡é»ã€å’Œã€Œæƒ…ç¯€å¤§è¦ã€ã€‚ä½¿ç”¨ã€Œ[part]ã€æ¨™è¨˜æ¯å€‹çµæ§‹æ®µçš„é–‹å§‹ï¼Œç„¶å¾Œåœ¨ä¸‹ä¸€è¡Œã€Œçµæ§‹æ®µé‡é»ï¼šã€å¾Œè·Ÿå…§å®¹ï¼Œå†ä¸‹ä¸€è¡Œã€Œæƒ…ç¯€å¤§è¦ï¼šã€å¾Œè·Ÿå…§å®¹ã€‚çµæ§‹æ®µæ•¸é‡å¿…é ˆèˆ‡ç”¨æˆ¶é¸æ“‡çš„å¤§ç¶±çµæ§‹ä¸€è‡´ï¼ˆèµ·æ‰¿è½‰åˆç‚º4æ®µï¼Œä¸‰ç·šç‚º5æ®µï¼šèµ·ã€ä¸€ç·šã€äºŒç·šã€ä¸‰ç·šã€åˆï¼‰ã€‚
3. åœ¨ã€Œ=== æ”¹å¯«èªªæ˜ ===ã€éƒ¨åˆ†ï¼Œæä¾›ä¸è¶…éå…©é»çš„æ”¹å¯«èªªæ˜ï¼Œæ¯é»ä»¥ã€Œ1. ã€å’Œã€Œ2. ã€é–‹å§‹ã€‚
è«‹ç¢ºä¿å…§å®¹ç°¡æ½”æ˜äº†ã€‚

é¡Œç›®ï¼š${topic}
å¤§ç¶±çµæ§‹ï¼š${structure === "fourPart" ? "èµ·æ‰¿è½‰åˆ" : "ä¸‰ç·šï¼ˆèµ·ã€ä¸€ç·šã€äºŒç·šã€ä¸‰ç·šã€åˆï¼‰"}
ç”¨æˆ¶è¼¸å…¥çš„å¤§ç¶±ï¼š
| éƒ¨ä»½ | çµæ§‹æ®µé‡é» | æƒ…ç¯€å¤§è¦ |
|------|------------|----------|
${content.map(item => `| ${item.part} | ${item.focus} | ${item.plot} |`).join("\n")}
æ•™å­¸ç­†è¨˜ï¼š${note}`;
            } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹é¡Œç›®å’Œå–æ/æ•…äº‹èƒŒæ™¯ç”Ÿæˆäº”åå€‹ä¸é‡è¤‡ä¸”ç›¸é—œçš„ç‰©è±¡ã€‚è¦æ±‚ï¼š
1. ç‰©è±¡å¿…é ˆèˆ‡é¡Œç›®å’Œå–æ/æ•…äº‹èƒŒæ™¯ç·Šå¯†ç›¸é—œã€‚
2. ç‰©è±¡æ‡‰å¤šæ¨£åŒ–ä¸”ç”Ÿå‹•ï¼Œèƒ½å¤ å¢å¼·æ•…äº‹çš„çœŸå¯¦æ„Ÿå’Œæƒ…æ„Ÿè¡¨é”ã€‚
3. è«‹ä»¥åˆ—è¡¨å½¢å¼å‘ˆç¾ï¼Œæ¯å€‹ç‰©è±¡å ä¸€è¡Œã€‚
4. è«‹ç¢ºä¿ç‰©è±¡ä¸é‡è¤‡ä¸”æ’ç‰ˆæ•´é½Šã€‚

é¡Œç›®ï¼š${topic}
å–æ/æ•…äº‹èƒŒæ™¯ï¼š${content || "ç„¡å…·é«”èƒŒæ™¯ï¼Œæ ¹æ“šé¡Œç›®ç”Ÿæˆ"}
æ•™å­¸ç­†è¨˜ï¼š${note}`;
            } else {
                const focus = localStorage.getItem("currentFocus");
                const plot = localStorage.getItem("currentPlot");
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹é€²è¡Œé»è©•ï¼Œè¦æ±‚ï¼š
1. ç°¡æ˜æ‰¼è¦
2. åƒè€ƒæ•™å­¸ç­†è¨˜
3. è©•è«–å¯«ä½œå…§å®¹èˆ‡é¡Œç›®ã€çµæ§‹æ®µé‡é»å’Œæƒ…ç¯€å¤§è¦çš„é—œä¿‚
4. è¼¸å‡ºåˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š### é»è©•ã€### å»ºè­°ã€### æ”¹å¯«ç¯„ä¾‹
5. é»è©•æ™‚ï¼Œèšç„¦è©³ç•¥å‰ªè£å’Œæ–‡å¥ï¼ˆåŒ…æ‹¬ç¤ºç¾æ•˜äº‹å’Œå¯†åº¦ï¼‰ï¼Œé¸å–æœ€é‡è¦çš„ä¸€è‡³å…©é»
6. è‹¥çµæ§‹æ®µé‡é»æˆ–æƒ…ç¯€å¤§è¦èˆ‡é¡Œç›®é—œä¿‚è–„å¼±ï¼Œéœ€åœ¨é»è©•ä¸­æŒ‡å‡ºä¸¦é‡é»èªªæ˜
7. é»è©•å’Œå»ºè­°ä¸æ‡‰ä½¿ç”¨åˆ—é»å½¢å¼ï¼Œæ‡‰ä»¥æ®µè½å‘ˆç¾

é¡Œç›®ï¼š${topic}
çµæ§‹æ®µé‡é»ï¼š${focus}
æƒ…ç¯€å¤§è¦ï¼š${plot}
å¯«ä½œå…§å®¹ï¼š${content}
æ•™å­¸ç­†è¨˜ï¼š${note}`;
            }

            document.getElementById("commentResult").innerHTML = "é™³SIRæ­£åœ¨é»è©•...";

            try {
                const comment = await callAPI(prompt);
                if (writingType === "å¤§ç¶±") {
                    const sections = comment.split(/=== (.+?) ===/);
                    const commentPart = sections[sections.indexOf("é»è©•åŠå»ºè­°") + 1];
                    const rewritePart = sections[sections.indexOf("æ”¹å¯«å¾Œçš„å¤§ç¶±") + 1];
                    const explanationPart = sections[sections.indexOf("æ”¹å¯«èªªæ˜") + 1];

                    const parts = structure === "fourPart" ? ["èµ·", "æ‰¿", "è½‰", "åˆ"] : ["èµ·", "ä¸€ç·š", "äºŒç·š", "ä¸‰ç·š", "åˆ"];

                    function parseCommentPart(commentPart) {
                        const comments = {};
                        const regex = /\[(.+?)\]\s*é»è©•ï¼š\s*(.+?)\s*å»ºè­°ï¼š\s*(.+?)(?=\[|$)/gs;
                        let match;
                        while ((match = regex.exec(commentPart)) !== null) {
                            comments[match[1]] = { comment: match[2].trim(), suggestion: match[3].trim() };
                        }
                        return comments;
                    }

                    function parseRewritePart(rewritePart) {
                        const rewrites = {};
                        const regex = /\[(.+?)\]\s*çµæ§‹æ®µé‡é»ï¼š\s*(.+?)\s*æƒ…ç¯€å¤§è¦ï¼š\s*(.+?)(?=\[|$)/gs;
                        let match;
                        while ((match = regex.exec(rewritePart)) !== null) {
                            rewrites[match[1]] = { focus: match[2].trim(), plot: match[3].trim() };
                        }
                        return rewrites;
                    }

                    const comments = parseCommentPart(commentPart);
                    const rewrites = parseRewritePart(rewritePart);

                    let commentTableHTML = `<h3>é™³SIRé»è©•åŠå»ºè­°ï¼š</h3><div class="table-container"><table id="commentTable"><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th><th>é»è©•</th><th>å»ºè­°</th></tr>`;
                    content.forEach(item => {
                        const comment = comments[item.part] ? comments[item.part].comment : "ç„¡";
                        const suggestion = comments[item.part] ? comments[item.part].suggestion : "ç„¡";
                        commentTableHTML += `<tr><td>${item.part}</td><td>${item.focus}</td><td>${item.plot}</td><td>${comment}</td><td>${suggestion}</td></tr>`;
                    });
                    commentTableHTML += "</table></div>";

                    let rewriteTableHTML = `<h3>æ”¹å¯«å¾Œçš„å¤§ç¶±ï¼š</h3><div class="table-container"><table id="rewriteTable"><tr><th>éƒ¨ä»½</th><th>çµæ§‹æ®µé‡é»</th><th>æƒ…ç¯€å¤§è¦</th></tr>`;
                    parts.forEach(part => {
                        const rewrite = rewrites[part] || { focus: "ç„¡", plot: "ç„¡" };
                        rewriteTableHTML += `<tr><td>${part}</td><td>${rewrite.focus}</td><td>${rewrite.plot}</td></tr>`;
                    });
                    rewriteTableHTML += "</table></div>";

                    const explanationHTML = `<h3>æ”¹å¯«èªªæ˜ï¼š</h3><pre>${explanationPart ? explanationPart.trim() : "ç„¡èªªæ˜"}</pre>`;
                    document.getElementById("commentResult").innerHTML = commentTableHTML + rewriteTableHTML + explanationHTML;
                } else if (writingType === "æ•˜äº‹ç‰©è±¡") {
                    const elements = comment.split("\n").map(item => item.trim()).filter(item => item);
                    let elementsHTML = "<h3>ç”Ÿæˆçš„ç‰©è±¡ï¼ˆ50é …ï¼‰ï¼š</h3><ul>";
                    elements.forEach(element => elementsHTML += `<li>${element}</li>`);
                    elementsHTML += "</ul>";
                    document.getElementById("commentResult").innerHTML = elementsHTML;
                } else {
                    const commentParts = comment.split("###").map(part => part.trim()).filter(part => part);
                    let commentHTML = "<h3>é™³SIRé»è©•ï¼š</h3><table>";
                    commentParts.forEach(part => {
                        const [title, ...content] = part.split("\n").filter(line => line.trim());
                        commentHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
                    });
                    commentHTML += "</table>";
                    document.getElementById("commentResult").innerHTML = commentHTML;
                }
            } catch (error) {
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("é»è©•ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("commentResult").innerHTML = "";
            }
        }

        // æäº¤é–±è®€å…§å®¹
        async function submitReading() {
            const readingFunction = document.getElementById("readingFunction").value;
            const passage = document.getElementById("readingPassage").value.trim();
            const question = document.getElementById("readingQuestion").value.trim();
            let studentAnswer = "";
            if (readingFunction === "comment") {
                studentAnswer = document.getElementById("studentAnswer").value.trim();
                if (!passage || !question || !studentAnswer) {
                    alert("è«‹å¡«å¯«æ‰€æœ‰é–±è®€è¼¸å…¥");
                    return;
                }
            } else {
                if (!passage || !question) {
                    alert("è«‹å¡«å¯«é–±è®€ç¯‡ç« å’Œé¡Œç›®");
                    return;
                }
            }

            const note = readingFunction === "comment" ? categories["é–±è®€"].commentNote : categories["é–±è®€"].guideNote;

            let prompt = "";
            if (readingFunction === "comment") {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹é–±è®€ç¯‡ç« ã€é¡Œç›®å’Œå­¸ç”Ÿçš„ç­”æ¡ˆé€²è¡Œé»è©•ã€‚è¦æ±‚ï¼š
1. è©•ä¼°ç­”é¡Œæ–¹å‘æ˜¯å¦åˆç†
2. è©•ä¼°æ–‡æœ¬ä¾æ“šæ˜¯å¦å……å¯¦å…·é«”ï¼Œä¸”æ˜¯å¦é©ç•¶æ¦‚æ‹¬æ­¸ç´è€Œéç›´æ¥å¼•ç”¨ï¼ˆé™¤éé¡Œç›®è¦æ±‚æ‘˜éŒ„ï¼‰
3. è©•ä¼°é—¡é‡‹æ¨è«–æ˜¯å¦åš´è¬¹ã€å…·é«”åœ“è¶³
4. è©•ä¼°ä¸»é¡Œå¥æ˜¯å¦æ¸…æ™°
5. åœ¨ã€Œ### ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ã€å‰ï¼ŒåŠ å…¥é»è©•ï¼Œä»¥æ®µè½å½¢å¼å‘ˆç¾ï¼Œä¸ä½¿ç”¨åˆ—é»
6. åœ¨ã€Œ### ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ã€ä¸­ï¼Œæè¿°å„éƒ¨åˆ†æ–¹å‘ï¼Œæ­¥é©Ÿå› é¡Œåˆ¶å®œï¼Œå¯èƒ½åŒ…æ‹¬ã€é‹ªå¢Šã€‘ã€ã€å›æ‡‰ã€‘ã€ã€æ–‡æœ¬ä¾æ“šã€‘ã€ã€é—¡é‡‹ã€‘ï¼Œéˆæ´»é‹ç”¨ã€‚æ¯å€‹æ­¥é©Ÿä»¥ã€æ­¥é©Ÿåã€‘æ¨™é¡ŒåŠ åˆ†è¡Œå…§å®¹å‘ˆç¾ï¼Œå…§å®¹åªåŒ…å«æ–‡å­—å’Œæ¨™é»
7. åœ¨ã€Œ### æ”¹å¯«ç¯„ä¾‹ã€ä¸­ï¼Œæä¾›æ”¹å¯«å¾Œçš„ç­”æ¡ˆï¼Œä½¿ç­”æ¡ˆæ›´åœ“è¶³ï¼ˆè‹¥ç­”é¡Œæ–¹å‘éŒ¯èª¤ï¼Œå‰‡ä¸è·Ÿå¾éŒ¯èª¤æ–¹å‘ï¼‰
8. è¼¸å‡ºåˆ†ç‚ºä¸‰å€‹éƒ¨åˆ†ï¼š### é»è©•ã€### ç­”é¡Œæ­¥é©ŸåŠæ€è·¯ã€### æ”¹å¯«ç¯„ä¾‹
9. è¡¨æ ¼ä¸­åªåŒ…å«æ–‡å­—å’Œæ¨™é»ï¼Œä¸å«ã€---ã€ç­‰ç¬¦è™Ÿ

é–±è®€ç¯‡ç« ï¼š${passage}
é¡Œç›®ï¼š${question}
å­¸ç”Ÿçš„ç­”æ¡ˆï¼š${studentAnswer}
æ•™å­¸ç­†è¨˜ï¼š${note}`;
            } else {
                prompt = `è«‹æ ¹æ“šä»¥ä¸‹é–±è®€ç¯‡ç« å’Œé¡Œç›®ç”Ÿæˆç­”é¡ŒæŒ‡å¼•ã€‚è¦æ±‚ï¼š
1. åœ¨ã€Œ### ç­”é¡ŒæŒ‡å¼•ã€ä¸­ï¼Œç”Ÿæˆä¸‰é“å•é¡Œä»¥å¼•å°ç”¨å®¶å›ç­”é–±è®€ç¯‡ç« çš„å•é¡Œï¼Œå•é¡Œé‡å°é¡Œç›®ï¼Œå¼•å°æ€è€ƒæ–‡æœ¬å…§å®¹ã€çµæ§‹å’Œä¸»é¡Œï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œ
2. åœ¨ã€Œ### ç­”é¡Œè©åŒ¯ã€ä¸­ï¼Œç”Ÿæˆ15å€‹ç”±å…©å€‹å­—æ§‹æˆçš„ç­”é¡Œè©åŒ¯ï¼Œè©åŒ¯éœ€èˆ‡ç¯‡ç« å’Œé¡Œç›®ç›¸é—œä¸”ä¸é‡è¤‡
3. è¼¸å‡ºåˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼š### ç­”é¡ŒæŒ‡å¼•ã€### ç­”é¡Œè©åŒ¯
4. ç­”é¡ŒæŒ‡å¼•ä»¥å•é¡Œå½¢å¼å‘ˆç¾ï¼Œæ¯å€‹å•é¡Œå ä¸€è¡Œ
5. ç­”é¡Œè©åŒ¯ä»¥è¡¨æ ¼å½¢å¼å‘ˆç¾ï¼Œæ¯å€‹è©å ä¸€è¡Œï¼Œè¡¨æ ¼ä¸­åªåŒ…å«æ–‡å­—å’Œæ¨™é»

é–±è®€ç¯‡ç« ï¼š${passage}
é¡Œç›®ï¼š${question}
æ•™å­¸ç­†è¨˜ï¼š${note}`;
            }

            document.getElementById("readingResult").innerHTML = "é™³SIRæ­£åœ¨æ€è€ƒ" + (readingFunction === "comment" ? "é»è©•" : "æŒ‡å¼•") + "...";

            try {
                const result = await callAPI(prompt);
                if (readingFunction === "comment") {
                    const parts = result.split("###").map(part => part.trim()).filter(part => part);
                    let resultHTML = "<h3>é™³SIRé»è©•ï¼š</h3><table>";
                    parts.forEach(part => {
                        const [title, ...content] = part.split("\n").filter(line => line.trim());
                        resultHTML += `<tr><th><strong>${title}</strong></th></tr><tr><td>${content.join("<br>")}</td></tr>`;
                    });
                    resultHTML += "</table>";
                    document.getElementById("readingResult").innerHTML = resultHTML;
                } else {
                    const sections = result.split("###").map(part => part.trim()).filter(part => part);
                    let guideHTML = "<h3>ç­”é¡ŒæŒ‡å¼•ï¼š</h3>";
                    sections.forEach(section => {
                        const [title, ...content] = section.split("\n").filter(line => line.trim());
                        if (title === "ç­”é¡ŒæŒ‡å¼•") {
                            guideHTML += `<h4><strong>${title}</strong></h4><ul>`;
                            content.slice(0, 3).forEach(question => guideHTML += `<li>${question}</li>`);
                            guideHTML += "</ul>";
                        } else if (title === "ç­”é¡Œè©åŒ¯") {
                            guideHTML += `<h4><strong>${title}</strong></h4><table><tr><th>è©åŒ¯</th></tr>`;
                            content.slice(0, 15).forEach(word => guideHTML += `<tr><td>${word}</td></tr>`);
                            guideHTML += "</table>";
                        }
                    });
                    document.getElementById("readingResult").innerHTML = guideHTML;
                }
            } catch (error) {
                if (error.message === "æ‰€æœ‰ API å¯†é‘°å‡ç„¡æ³•ä½¿ç”¨") {
                    alert("ä»Šæ—¥ API èª¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œæˆ–APIç„¡æ³•é€£æ¥ï¼Œè«‹æ˜å¤©å†è©¦");
                } else {
                    alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
                }
                document.getElementById("readingResult").innerHTML = "";
            }
        }

        // èª²å¤–æ›¸ç±è¨è«–åŠŸèƒ½
        let chatHistory = [];
        let bookTitle = "";
        let author = "";
        let discussionQuestion = "";

        async function startDiscussion() {
            bookTitle = document.getElementById("bookTitle").value.trim();
            author = document.getElementById("author").value.trim();
            discussionQuestion = document.getElementById("discussionQuestion").value.trim();
            if (!bookTitle || !author || !discussionQuestion) {
                alert("è«‹å¡«å¯«æ›¸åã€ä½œè€…å’Œè¨è«–å•é¡Œ");
                return;
            }
            chatHistory = []; // é‡ç½®å°è©±æ­·å²
            addMessageToHistory("user", `æ›¸åï¼š${bookTitle}\nä½œè€…ï¼š${author}\nè¨è«–å•é¡Œï¼š${discussionQuestion}`);
            document.getElementById("userInput").style.display = "block";
            document.getElementById("continueBtn").style.display = "block";
            await sendInitialMessage();
        }

        async function sendInitialMessage() {
            const prompt = `æˆ‘æ˜¯ä¸€ä½é«˜ä¸­ç”Ÿï¼Œæ­£åœ¨é–±è®€ã€Š${bookTitle}ã€‹ï¼Œä½œè€…æ˜¯${author}ã€‚æˆ‘æƒ³è¨è«–çš„å•é¡Œæ˜¯ï¼š${discussionQuestion}ã€‚è«‹ç”¨æ—¥å¸¸çš„èªè¨€å›æ‡‰æˆ‘ï¼Œä¸è¦éæ–¼ç†è«–åŒ–ï¼Œè¨€ç°¡æ„è³…åœ°åˆ†æä¸¦çµ¦å‡ºä¾‹å­ï¼Œç„¶å¾Œå¼•å°æˆ‘æ·±å…¥æ€è€ƒã€‚è«‹ä¸è¦ä½¿ç”¨æ‹¬è™Ÿè§£é‡‹ä½ çš„ç›®çš„ï¼Œæ°¸é ä¸è¦åˆ—é»å›æ‡‰ï¼Œä¹Ÿä¸è¦æåŠä½ æœƒè¿½å•æˆ‘ã€‚è«‹ç”¨å®Œæ•´å¥å­å›æ‡‰ã€‚æ•™å­¸ç­†è¨˜ï¼š${categories["èª²å¤–æ›¸ç±"].chatNote}`;
            addMessageToHistory("ai", "é™³SIRæ­£åœ¨å›æ‡‰...");
            try {
                const aiResponse = await callAPI(prompt);
                updateLastAIMessage(aiResponse);
            } catch (error) {
                updateLastAIMessage("æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•å›æ‡‰æ‚¨çš„ä¿¡æ¯ã€‚ğŸ˜“");
            }
        }

        async function continueDiscussion() {
            const userInput = document.getElementById("userInput").value.trim();
            if (!userInput) {
                alert("è«‹è¼¸å…¥æ‚¨çš„å›æ‡‰");
                return;
            }
            addMessageToHistory("user", userInput);
            const prompt = `æˆ‘æ˜¯ä¸€ä½é«˜ä¸­ç”Ÿï¼Œæ­£åœ¨èˆ‡ä½ è¨è«–ã€Š${bookTitle}ã€‹ä¸­çš„å•é¡Œã€‚æˆ‘çš„ä¸Šä¸€æ¢ä¿¡æ¯æ˜¯ï¼š${userInput}ã€‚è«‹ç”¨æ—¥å¸¸çš„èªè¨€å›æ‡‰æˆ‘ï¼Œä¸è¦éæ–¼ç†è«–åŒ–ï¼Œè¨€ç°¡æ„è³…åœ°åˆ†æä¸¦çµ¦å‡ºä¾‹å­ï¼Œç„¶å¾Œå¼•å°æˆ‘æ·±å…¥æ€è€ƒã€‚è«‹ä¸è¦ä½¿ç”¨æ‹¬è™Ÿè§£é‡‹ä½ çš„ç›®çš„ï¼Œä¹Ÿä¸è¦æåŠä½ æœƒè¿½å•æˆ‘ã€‚è«‹ç”¨å®Œæ•´å¥å­å›æ‡‰ã€‚æ•™å­¸ç­†è¨˜ï¼š${categories["èª²å¤–æ›¸ç±"].chatNote}`;
            addMessageToHistory("ai", "é™³SIRæ­£åœ¨å›æ‡‰...");
            try {
                const aiResponse = await callAPI(prompt);
                updateLastAIMessage(aiResponse);
            } catch (error) {
                updateLastAIMessage("æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•å›æ‡‰æ‚¨çš„ä¿¡æ¯ã€‚ğŸ˜“");
            }
            document.getElementById("userInput").value = "";
        }

        function addMessageToHistory(sender, message) {
            chatHistory.push({ sender, message });
            const chatHistoryDiv = document.getElementById("chatHistory");
            const messageDiv = document.createElement("div");
            messageDiv.className = sender === "user" ? "user-message" : "ai-message";
            if (sender === "ai" && message === "é™³SIRæ­£åœ¨å›æ‡‰...") {
                messageDiv.id = "ai-loading";
            }
            messageDiv.textContent = message;
            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        function updateLastAIMessage(newMessage) {
            const chatHistoryDiv = document.getElementById("chatHistory");
            const loadingDiv = document.getElementById("ai-loading");
            if (loadingDiv) {
                loadingDiv.textContent = newMessage;
                loadingDiv.id = "";
            } else {
                addMessageToHistory("ai", newMessage);
            }
        }

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        window.onload = function() {
            showContainer("writingContainer");
        };
    </script>
</body>
</html>
